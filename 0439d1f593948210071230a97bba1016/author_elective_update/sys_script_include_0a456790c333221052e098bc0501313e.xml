<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="DELETE">
        <access>package_private</access>
        <active>true</active>
        <api_name>global.aiabReqInfra</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description/>
        <mobile_callable>false</mobile_callable>
        <name>aiabReqInfra</name>
        <sandbox_callable>false</sandbox_callable>
        <script><![CDATA[var aiabReqInfra = Class.create();
aiabReqInfra.prototype = {
    initialize: function() {},
    CreateMidUser: function(password) {
        var user_name = 'tryaiinabox-mid-user';
        
        var sys_user = new GlideRecord('sys_user');
        if (sys_user.get('user_name', user_name)) {
            sys_user.deleteRecord();
        }
        
        sys_user.newRecord();
        sys_user.setValue('user_name', user_name);
        sys_user.user_password.setDisplayValue(password);
        sys_user.setValue('password_needs_reset', false);
        
        var userGR = sys_user.insert();
        
        // add mid_server role
        var giveRole = new GlideRecord('sys_user_has_role');
        giveRole.newRecord();
        giveRole.setValue('user', userGR);
        giveRole.setDisplayValue('role', 'mid_server');
        var roleGR = giveRole.insert();
        
        return {
            status: "success",
            message: "create user and gave role",
            user_id: userGR
        };
    },
    GeneratePassword: function() {
        var password = '',
            size = 8, // Default minimum length if the policy does not specify one.
            chars = [
                'abcdefghijklmnopqrstuvwxyz',
                'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
                '0123456789'
            ];

        // Get the password policy with the largest minimum-length value
        var policy = new global.GlideQuery.parse('password_policy', 'ORDERBYDESCminimun_password_length')
            .limit(1)
            .select('minimun_password_length', 'whitelisted_special_characters')
            .reduce(function(obj, rec) {
                obj.size = rec.minimun_password_length;
                obj.chars = rec.whitelisted_special_characters;
                return obj;
            }, {});

        chars.push(policy.chars);
        chars = chars.join('');
        size = policy.size || size;

        while (password.length <= size) {
            var character = chars[Math.floor(Math.random() * chars.length)];
            if (character == '$' || character == '%' || character == '^' || character == '&') {
                continue; //skip these characters
            }
            password += character;
        }
        
        return password;
    },
    RequestDemoInfra: function(username, password) {
        // first we're going to check if the server's been requested before
        // we are storing the history in a unusual place, the preferences table
        // the response for this will be a return object
        // containing a status, and message
        // first lets "down" the current midserver
        var eccAgent = GlideRecord('ecc_agent');
        eccAgent.addQuery('name', 'aiinabox-mid');
        eccAgent.query();
        if (eccAgent.next()) {
            eccAgent.deleteRecord();
        }
        
        var host = 'https://tryaiinabox.com/';
        var url = host + '.redwood/functions/requestDemoInfra';
        
        var instanceName = gs.getProperty('instance_name');
        
        var body = {
            midUserName: username,
            midPassword: password,
            instance: instanceName + '.service-now.com'
        };
        
        //gs.print(JSON.stringify(body, null, ' '));
        var restMessage = new sn_ws.RESTMessageV2();
        restMessage.setHttpMethod('post');
        restMessage.setEndpoint(url);
        restMessage.setRequestHeader('Content-type', 'application/json');
        restMessage.setRequestBody(JSON.stringify(body));
        
        var response = restMessage.execute();
        
        var error = response.haveError();
        var statusCode = response.getStatusCode();
        var responseBody = response.getBody();
        gs.info("  - Status Code: " + statusCode);
        gs.info("  - Has Error: " + error);
        gs.info("  - Response Body: " + (responseBody || 'EMPTY'));
        
        if (error) {
            var errorCode = response.getErrorCode();
            var errorMsg = response.getErrorMessage();
            
            gs.error("aiabReqInfra: Request failed:");
            gs.error("  - Error Code: " + errorCode);
            gs.error("  - Error Message: " + errorMsg);
            gs.addErrorMessage(errorMsg);
            
            return {
                status: "error",
                message: errorMsg
            };
        } else {
            gs.info("aiabReqInfra: Request successful - Status Code: " + statusCode);
            return {
                status: statusCode,
                message: "Request recieved, this will take a 3-5 minutes to process.  Monitor the mid server list for the new mid server."
            };
        }
    },
    SetupServerfulProperties: function() {
        gs.setProperty('ai_in_a_box.config.server.aiab.url', 'http://172.17.0.1:3333');
        gs.setProperty('ai_in_a_box.config.midserver.enabled', 'true');
        gs.setProperty('ai_in_a_box.config.midserver', 'aiinabox-mid');
    },
    SetupServerlessProperties: function() {
        gs.setProperty('ai_in_a_box.config.server.aiab.url', 'https://2025-08-30-azure-aiab.azurewebsites.net');
        gs.setProperty('ai_in_a_box.config.midserver.enabled', 'false');
        gs.setProperty('ai_in_a_box.config.midserver', '');
    },
    type: 'aiabReqInfra'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>jacebenson</sys_created_by>
        <sys_created_on>2025-09-01 18:05:54</sys_created_on>
        <sys_id>0a456790c333221052e098bc0501313e</sys_id>
        <sys_mod_count>7</sys_mod_count>
        <sys_name>aiabReqInfra</sys_name>
        <sys_package display_value="AI in a Box" source="0439d1f593948210071230a97bba1016">0439d1f593948210071230a97bba1016</sys_package>
        <sys_policy/>
        <sys_scope display_value="AI in a Box">0439d1f593948210071230a97bba1016</sys_scope>
        <sys_update_name>sys_script_include_0a456790c333221052e098bc0501313e</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-14 01:05:41</sys_updated_on>
    </sys_script_include>
    <sys_update_version action="INSERT_OR_UPDATE">
        <action>DELETE</action>
        <application display_value="AI in a Box">0439d1f593948210071230a97bba1016</application>
        <file_path/>
        <instance_id>3e01943a1b79f9901024eb9b2d4bcb05</instance_id>
        <instance_name>dev184755</instance_name>
        <name>sys_script_include_0a456790c333221052e098bc0501313e</name>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_include"&gt;&lt;sys_script_include action="INSERT_OR_UPDATE"&gt;&lt;access&gt;package_private&lt;/access&gt;&lt;active&gt;true&lt;/active&gt;&lt;api_name&gt;global.aiabReqInfra&lt;/api_name&gt;&lt;caller_access/&gt;&lt;client_callable&gt;false&lt;/client_callable&gt;&lt;description/&gt;&lt;mobile_callable&gt;false&lt;/mobile_callable&gt;&lt;name&gt;aiabReqInfra&lt;/name&gt;&lt;sandbox_callable&gt;false&lt;/sandbox_callable&gt;&lt;script&gt;&lt;![CDATA[var aiabReqInfra = Class.create();
aiabReqInfra.prototype = {
    initialize: function() {},
    CreateMidUser: function(password) {
        var user_name = 'tryaiinabox-mid-user';
        
        var sys_user = new GlideRecord('sys_user');
        if (sys_user.get('user_name', user_name)) {
            sys_user.deleteRecord();
        }
        
        sys_user.newRecord();
        sys_user.setValue('user_name', user_name);
        sys_user.user_password.setDisplayValue(password);
        sys_user.setValue('password_needs_reset', false);
        
        var userGR = sys_user.insert();
        
        // add mid_server role
        var giveRole = new GlideRecord('sys_user_has_role');
        giveRole.newRecord();
        giveRole.setValue('user', userGR);
        giveRole.setDisplayValue('role', 'mid_server');
        var roleGR = giveRole.insert();
        
        return {
            status: "success",
            message: "create user and gave role",
            user_id: userGR
        };
    },
    GeneratePassword: function() {
        var password = '',
            size = 8, // Default minimum length if the policy does not specify one.
            chars = [
                'abcdefghijklmnopqrstuvwxyz',
                'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
                '0123456789'
            ];

        // Get the password policy with the largest minimum-length value
        var policy = new global.GlideQuery.parse('password_policy', 'ORDERBYDESCminimun_password_length')
            .limit(1)
            .select('minimun_password_length', 'whitelisted_special_characters')
            .reduce(function(obj, rec) {
                obj.size = rec.minimun_password_length;
                obj.chars = rec.whitelisted_special_characters;
                return obj;
            }, {});

        chars.push(policy.chars);
        chars = chars.join('');
        size = policy.size || size;

        while (password.length &lt;= size) {
            var character = chars[Math.floor(Math.random() * chars.length)];
            if (character == '$' || character == '%' || character == '^' || character == '&amp;') {
                continue; //skip these characters
            }
            password += character;
        }
        
        return password;
    },
    RequestDemoInfra: function(username, password) {
        // first we're going to check if the server's been requested before
        // we are storing the history in a unusual place, the preferences table
        // the response for this will be a return object
        // containing a status, and message
        // first lets "down" the current midserver
        var eccAgent = GlideRecord('ecc_agent');
        eccAgent.addQuery('name', 'aiinabox-mid');
        eccAgent.query();
        if (eccAgent.next()) {
            eccAgent.deleteRecord();
        }
        
        var host = 'https://tryaiinabox.com/';
        var url = host + '.redwood/functions/requestDemoInfra';
        
        var instanceName = gs.getProperty('instance_name');
        
        var body = {
            midUserName: username,
            midPassword: password,
            instance: instanceName + '.service-now.com'
        };
        
        //gs.print(JSON.stringify(body, null, ' '));
        var restMessage = new sn_ws.RESTMessageV2();
        restMessage.setHttpMethod('post');
        restMessage.setEndpoint(url);
        restMessage.setRequestHeader('Content-type', 'application/json');
        restMessage.setRequestBody(JSON.stringify(body));
        
        var response = restMessage.execute();
        
        var error = response.haveError();
        var statusCode = response.getStatusCode();
        var responseBody = response.getBody();
        gs.info("  - Status Code: " + statusCode);
        gs.info("  - Has Error: " + error);
        gs.info("  - Response Body: " + (responseBody || 'EMPTY'));
        
        if (error) {
            var errorCode = response.getErrorCode();
            var errorMsg = response.getErrorMessage();
            
            gs.error("aiabReqInfra: Request failed:");
            gs.error("  - Error Code: " + errorCode);
            gs.error("  - Error Message: " + errorMsg);
            gs.addErrorMessage(errorMsg);
            
            return {
                status: "error",
                message: errorMsg
            };
        } else {
            gs.info("aiabReqInfra: Request successful - Status Code: " + statusCode);
            return {
                status: statusCode,
                message: "Request recieved, this will take a 3-5 minutes to process.  Monitor the mid server list for the new mid server."
            };
        }
    },
    SetupServerfulProperties: function() {
        gs.setProperty('ai_in_a_box.config.server.aiab.url', 'http://172.17.0.1:3333');
        gs.setProperty('ai_in_a_box.config.midserver.enabled', 'true');
        gs.setProperty('ai_in_a_box.config.midserver', 'aiinabox-mid');
    },
    SetupServerlessProperties: function() {
        gs.setProperty('ai_in_a_box.config.server.aiab.url', 'https://2025-08-30-azure-aiab.azurewebsites.net');
        gs.setProperty('ai_in_a_box.config.midserver.enabled', 'false');
        gs.setProperty('ai_in_a_box.config.midserver', '');
    },
    type: 'aiabReqInfra'
};]]&gt;&lt;/script&gt;&lt;sys_class_name&gt;sys_script_include&lt;/sys_class_name&gt;&lt;sys_created_by&gt;jacebenson&lt;/sys_created_by&gt;&lt;sys_created_on&gt;2025-09-01 18:05:54&lt;/sys_created_on&gt;&lt;sys_id&gt;0a456790c333221052e098bc0501313e&lt;/sys_id&gt;&lt;sys_mod_count&gt;7&lt;/sys_mod_count&gt;&lt;sys_name&gt;aiabReqInfra&lt;/sys_name&gt;&lt;sys_package display_value="AI in a Box" source="0439d1f593948210071230a97bba1016"&gt;0439d1f593948210071230a97bba1016&lt;/sys_package&gt;&lt;sys_policy/&gt;&lt;sys_scope display_value="AI in a Box"&gt;0439d1f593948210071230a97bba1016&lt;/sys_scope&gt;&lt;sys_update_name&gt;sys_script_include_0a456790c333221052e098bc0501313e&lt;/sys_update_name&gt;&lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;&lt;sys_updated_on&gt;2026-01-14 01:05:41&lt;/sys_updated_on&gt;&lt;/sys_script_include&gt;&lt;/record_update&gt;</payload>
        <payload_hash>-1313794409</payload_hash>
        <record_name>aiabReqInfra</record_name>
        <reverted_from/>
        <source>fb79436b835232104d4fccb6feaad310</source>
        <source_table>sys_update_set</source_table>
        <state>previous</state>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-14 01:05:41</sys_created_on>
        <sys_id>017a4feb835232104d4fccb6feaad3fc</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_recorded_at>19bba09773c0000001</sys_recorded_at>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-14 01:05:41</sys_updated_on>
        <type>Script Include</type>
        <update_guid>417a4feb7552321017eda4114733affb</update_guid>
        <update_guid_history>417a4feb7552321017eda4114733affb:-1313794409,6b5b6b06a1fba2107529fbf91bd778d7:685429233,cbc9e7c214fba210b9fb1b8003eff30d:592758526,fc17db42bb7ba210103c373945268577:-888041892,a15d3341317fe2107faa681177d0bd5f:1665899384,79bc3b01987fe210f99b08c48cd4b736:228163844,6085e714fa332210d9f758d740732d5d:-1981871192,2d55e3546a33221032455effce565cac:1031478984</update_guid_history>
    </sys_update_version>
    <sys_metadata_delete action="INSERT_OR_UPDATE">
        <sys_audit_delete/>
        <sys_class_name>sys_metadata_delete</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-02-14 07:27:37</sys_created_on>
        <sys_db_object display_value="" name="sys_script_include">sys_script_include</sys_db_object>
        <sys_id>1d73e3ac67cd4b0894920fe52c28c724</sys_id>
        <sys_metadata>0a456790c333221052e098bc0501313e</sys_metadata>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>aiabReqInfra</sys_name>
        <sys_package display_value="AI in a Box" source="0439d1f593948210071230a97bba1016">0439d1f593948210071230a97bba1016</sys_package>
        <sys_parent/>
        <sys_policy/>
        <sys_scope display_value="AI in a Box">0439d1f593948210071230a97bba1016</sys_scope>
        <sys_scope_delete display_value="">c1a48f6b4a924506a5b1a6becbc665a1</sys_scope_delete>
        <sys_update_name>sys_script_include_0a456790c333221052e098bc0501313e</sys_update_name>
        <sys_update_version display_value="sys_script_include_0a456790c333221052e098bc0501313e">017a4feb835232104d4fccb6feaad3fc</sys_update_version>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-02-14 07:27:37</sys_updated_on>
    </sys_metadata_delete>
</record_update>
