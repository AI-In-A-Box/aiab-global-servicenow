<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="DELETE">
        <access>public</access>
        <active>true</active>
        <api_name>global.aiabAjax</api_name>
        <caller_access>1</caller_access>
        <client_callable>true</client_callable>
        <description/>
        <mobile_callable>false</mobile_callable>
        <name>aiabAjax</name>
        <sandbox_callable>true</sandbox_callable>
        <script><![CDATA[var aiabAjax = Class.create();
aiabAjax.prototype = Object.extendsObject(AbstractAjaxProcessor, {
    cancelAIInference: function (sys_id, table, inferenceId) {
        try {
            if (!sys_id) sys_id = this.getParameter('sysparm_sys_id') || false;
            if (!table) table = this.getParameter('sysparm_table') || false;
            if (!inferenceId) inferenceId = this.getParameter('sysparm_inference_id') || false;
            var inference = new GlideRecord('u_ai_inference');
            if (inferenceId) {
                inference.addQuery('sys_id', inferenceId);
            }
            if (table && sys_id) {
                inference.addQuery('u_table', table);
                inference.addQuery('u_target', sys_id);
            }
            inference.addQuery('u_state', 'requested');
            inference.orderByDesc('sys_created_on');
            inference.query();
            if (inference.hasNext() === false) {
                return "Nothing to cancel.";
            }
            while (inference.next()) {
                inference.setValue('u_state', 'cancelled');
                inference.update();
                return "Cancelled Inference.";
            }
        } catch (error) {

        }
    },
    createAIInference: function (sys_id, table, type) {
        try {
            if (!sys_id) sys_id = this.getParameter('sysparm_sys_id') || "";
            if (!table) table = this.getParameter('sysparm_table') || "";
            if (!type) type = this.getParameter('sysparm_type') || "generic";
            var data = this.getParameter('sysparm_data') || {};
            var prompt = this.getParameter('sysparm_prompt') || '';
            var toolsIncluded = this.getParameter('sysparm_tools_included') || '';
            
            var inference = new GlideRecord('u_ai_inference');
            inference.newRecord();
            inference.setValue('u_target', sys_id);
            inference.setValue('u_table', table);
            inference.setValue('u_metadata', data);
            inference.setValue('u_type', type);
            
            // If prompt provided, set it directly
            if (prompt) {
                inference.setValue('u_prompt', prompt);
            }
            
            // If specific tools included, set them
            if (toolsIncluded) {
                inference.setValue('u_tools_included', toolsIncluded);
            }
            
            return inference.insert();
        } catch (error) {
            return error;
        }
    },
    createAIChat: function (messages) {
        try {
            if (!messages) messages = this.getParameter('sysparm_messages') || this.getParameter('sysparm_conversation') || false;
            if (messages == false) {
                return JSON.stringify({ error: "missing messages" })
            }
            
            var recordTable = this.getParameter('sysparm_table') || '';
            var recordSysId = this.getParameter('sysparm_record') || '';
            var toolsIncluded = this.getParameter('sysparm_tools_included') || '';
            
            var inference = new GlideRecord('u_ai_inference');
            inference.newRecord();
            inference.setValue('u_type','chat');
            
            if (recordTable && recordSysId) {
                inference.setValue('u_table', recordTable);
                inference.setValue('u_target', recordSysId);
            }
            
            // Set specific tools if provided
            if (toolsIncluded) {
                inference.setValue('u_tools_included', toolsIncluded);
            }
            
            var systemPrompt = gs.getProperty('ai_in_a_box.feature.chat.system_prompt') || 
                "You are a helpful AI assistant. Answer questions clearly and concisely. If you don't know the answer, say so.";
            
            var context = [{
                role: "system",
                content: systemPrompt
            }];
            
            var userContext = this._buildUserContext();
            if (userContext) {
                context[0].content += '\n\n--- Current User Context ---\n' + userContext;
            }
            
            if (recordTable && recordSysId) {
                var recContext = this._buildRecordContext(recordTable, recordSysId);
                if (recContext) {
                    context[0].content += '\n\n--- Current Record Context ---\n' + recContext;
                }
            }
            
            var parsedMessages = JSON.parse(messages);
            parsedMessages = context.concat(parsedMessages);
            inference.setValue('u_prompt', JSON.stringify(parsedMessages, null, 4));
            return inference.insert();
            
        } catch (error) {
            return '';
        }
    },
    
    getAIInference: function(inferenceId) {
        try {
            if (!inferenceId) inferenceId = this.getParameter('sysparm_sys_id') || '';
            if (!inferenceId) {
                return JSON.stringify({ error: 'missing sys_id' });
            }
            
            var gr = new GlideRecord('u_ai_inference');
            if (gr.get(inferenceId)) {
                return JSON.stringify({
                    response: gr.getValue('u_response') || '',
                    state: gr.getValue('u_state') || ''
                });
            } else {
                return JSON.stringify({ error: 'not found' });
            }
        } catch (error) {
            return JSON.stringify({ error: error.message || 'unknown error' });
        }
    },
    
    getChatHistory: function() {
        try {
            var table = this.getParameter('sysparm_table') || '';
            var record = this.getParameter('sysparm_record') || '';
            
            if (!table || !record) {
                return JSON.stringify({ chats: [] });
            }
            
            var chats = [];
            var gr = new GlideRecord('u_ai_inference');
            gr.addQuery('u_type', 'chat');
            gr.addQuery('u_table', table);
            gr.addQuery('u_target', record);
            gr.addQuery('sys_created_by', gs.getUserName());
            gr.addQuery('u_state', 'finished');
            gr.orderByDesc('sys_created_on');
            gr.setLimit(10);
            gr.query();
            
            while (gr.next()) {
                var preview = 'Chat conversation';
                try {
                    var prompt = JSON.parse(gr.getValue('u_prompt') || '[]');
                    for (var i = 0; i < prompt.length; i++) {
                        if (prompt[i].role === 'user') {
                            preview = prompt[i].content || '';
                            if (preview.length > 50) {
                                preview = preview.substring(0, 50) + '...';
                            }
                            break;
                        }
                    }
                } catch(e) {
                }
                
                chats.push({
                    sys_id: gr.getValue('sys_id'),
                    created: gr.getDisplayValue('sys_created_on'),
                    preview: preview
                });
            }
            
            return JSON.stringify({ chats: chats });
        } catch (error) {
            return JSON.stringify({ chats: [], error: error.message || 'unknown error' });
        }
    },
    
    loadChatConversation: function() {
        try {
            var sysId = this.getParameter('sysparm_sys_id') || '';
            
            if (!sysId) {
                return JSON.stringify({ error: 'missing sys_id' });
            }
            
            var gr = new GlideRecord('u_ai_inference');
            if (!gr.get(sysId)) {
                return JSON.stringify({ error: 'not found' });
            }
            
            if (gr.getValue('sys_created_by') !== gs.getUserName()) {
                return JSON.stringify({ error: 'access denied' });
            }
            
            var messages = [];
            try {
                var prompt = JSON.parse(gr.getValue('u_prompt') || '[]');
                for (var i = 0; i < prompt.length; i++) {
                    if (prompt[i].role === 'user' || prompt[i].role === 'assistant') {
                        messages.push({
                            role: prompt[i].role,
                            content: prompt[i].content || ''
                        });
                    }
                }
            } catch(e) {
            }
            
            var response = gr.getValue('u_response') || '';
            if (response && messages.length > 0 && messages[messages.length - 1].role !== 'assistant') {
                messages.push({ role: 'assistant', content: response });
            }
            
            return JSON.stringify({ messages: messages });
        } catch (error) {
            return JSON.stringify({ error: error.message || 'unknown error' });
        }
    },
    
    _buildUserContext: function() {
        var user = new GlideRecord('sys_user');
        if (!user.get(gs.getUserID())) return '';
        
        var lines = [
            'Logged in user: ' + user.getDisplayValue('name'),
            '- Email: ' + (user.getValue('email') || 'Not set'),
            '- Title: ' + (user.getValue('title') || 'Not set'),
            '- Department: ' + (user.getDisplayValue('department') || 'Not set'),
            '- Location: ' + (user.getDisplayValue('location') || 'Not set'),
            '- Manager: ' + (user.getDisplayValue('manager') || 'Not set')
        ];
        
        return lines.join('\n');
    },
    
    _buildRecordContext: function(table, sysId) {
        var gr = new GlideRecord(table);
        if (!gr.get(sysId)) return '';
        
        var userId = gs.getUserID();
        var lines = [
            'Table: ' + table,
            'Record: ' + gr.getDisplayValue()
        ];
        
        if (gr.isValidField('number')) {
            lines.push('Number: ' + gr.getValue('number'));
        }
        
        if (gr.isValidField('short_description')) {
            lines.push('Short description: ' + gr.getValue('short_description'));
        }
        
        if (gr.isValidField('description') && gr.getValue('description')) {
            var desc = gr.getValue('description');
            if (desc.length > 500) {
                desc = desc.substring(0, 500) + '...';
            }
            lines.push('Description: ' + desc);
        }
        
        if (gr.isValidField('state')) {
            lines.push('State: ' + gr.getDisplayValue('state'));
        }
        
        if (gr.isValidField('priority')) {
            lines.push('Priority: ' + gr.getDisplayValue('priority'));
        }
        
        var callerFields = ['caller_id', 'requested_by', 'u_requested_by', 'contact', 'opened_by'];
        for (var c = 0; c < callerFields.length; c++) {
            var callerField = callerFields[c];
            if (gr.isValidField(callerField) && gr.getValue(callerField)) {
                var callerLabel = gr.getElement(callerField).getLabel();
                lines.push(callerLabel + ': ' + gr.getDisplayValue(callerField));
            }
        }
        
        if (gr.isValidField('assigned_to') && gr.getValue('assigned_to')) {
            lines.push('Assigned to: ' + gr.getDisplayValue('assigned_to'));
        }
        
        if (gr.isValidField('assignment_group') && gr.getValue('assignment_group')) {
            lines.push('Assignment group: ' + gr.getDisplayValue('assignment_group'));
        }
        
        if (gr.isValidField('category') && gr.getValue('category')) {
            lines.push('Category: ' + gr.getDisplayValue('category'));
        }
        if (gr.isValidField('subcategory') && gr.getValue('subcategory')) {
            lines.push('Subcategory: ' + gr.getDisplayValue('subcategory'));
        }
        
        if (gr.isValidField('sys_created_on')) {
            lines.push('Created: ' + gr.getDisplayValue('sys_created_on'));
        }
        if (gr.isValidField('sys_updated_on')) {
            lines.push('Last updated: ' + gr.getDisplayValue('sys_updated_on'));
        }
        
        var relationships = this._determineUserRelationship(gr, userId);
        if (relationships.length > 0) {
            lines.push('');
            lines.push('Your relationship to this record:');
            for (var r = 0; r < relationships.length; r++) {
                lines.push('- ' + relationships[r]);
            }
        }
        
        return lines.join('\n');
    },
    
    _determineUserRelationship: function(gr, userId) {
        var relationships = [];
        
        var callerFields = ['caller_id', 'opened_by', 'requested_by', 'u_requested_by', 'contact'];
        for (var i = 0; i < callerFields.length; i++) {
            var field = callerFields[i];
            if (gr.isValidField(field) && gr.getValue(field) === userId) {
                relationships.push('You are the ' + gr.getElement(field).getLabel());
                break;
            }
        }
        
        if (gr.isValidField('assigned_to') && gr.getValue('assigned_to') === userId) {
            relationships.push('You are assigned to this record');
        }
        
        if (gr.isValidField('assignment_group') && gr.getValue('assignment_group')) {
            var groupId = gr.getValue('assignment_group');
            var groupMember = new GlideRecord('sys_user_grmember');
            groupMember.addQuery('group', groupId);
            groupMember.addQuery('user', userId);
            groupMember.setLimit(1);
            groupMember.query();
            if (groupMember.hasNext()) {
                relationships.push('You are a member of the assignment group');
            }
        }
        
        if (gr.isValidField('assigned_to') && gr.getValue('assigned_to')) {
            var assignee = new GlideRecord('sys_user');
            if (assignee.get(gr.getValue('assigned_to'))) {
                if (assignee.getValue('manager') === userId) {
                    relationships.push('You are the manager of the assignee');
                }
            }
        }
        
        if (relationships.length === 0) {
            relationships.push('You are viewing this record (no direct relationship)');
        }
        
        return relationships;
    },

    askClientScript: function (sys_id, table, prompt, script) {
        try {
            if (!sys_id) sys_id = this.getParameter('sysparm_sys_id') || "";
            if (!table) table = this.getParameter('sysparm_table') || "";
            if (!script) script = this.getParameter('sysparm_script') || "";
            if (!prompt) prompt = this.getParameter('sysparm_prompt');
            var inference = new GlideRecord('u_ai_inference');
            inference.newRecord();
            inference.setValue('u_target', sys_id);
            inference.setValue('u_table', table);
            var jsonPrompt = [
                {
                    role: "system",
                    content: "You are a helpful assistant."
                },
                {
                    role: "user",
                    content: 'I have a question about this code.\n\n"""' + script + '\n""""'
                }
            ]
            inference.setValue('u_prompt', JSON.stringify(jsonPrompt));
            inference.setValue('u_type', 'generic');
            return inference.insert();
        } catch (error) {
            return error;
        }
    },
    createAIInferenceAskRecord: function (sys_id, table, prompt) {
        try {
            if (!sys_id) sys_id = this.getParameter('sysparm_sys_id') || "";
            if (!table) table = this.getParameter('sysparm_table') || "";
            if (!prompt) prompt = this.getParameter('sysparm_prompt');
            var inference = new GlideRecord('u_ai_inference');
            inference.newRecord();
            inference.setValue('u_target', sys_id);
            inference.setValue('u_table', table);
            inference.setValue('u_prompt', prompt);
            inference.setValue('u_type', 'ask-record');
            return inference.insert();
        } catch (error) {
            return error;
        }
    },
    isChatEnabled: function () {
        var enabled = gs.getProperty('ai_in_a_box.feature.chat.enabled') == 'true';
        if (!enabled) return 'false';
        
        var rolesStr = gs.getProperty('ai_in_a_box.feature.chat.roles') || '';
        if (!rolesStr) return 'true';
        
        var roles = rolesStr.split(',');
        for (var i = 0; i < roles.length; i++) {
            if (gs.hasRole(roles[i].trim())) {
                return 'true';
            }
        }
        return 'false';
    },
    getInferenceRecord: function (sys_id) {
        try {
            if (!sys_id) sys_id = this.getParameter('sysparm_sys_id') || "";
            var inferenceGR = new GlideRecord('u_ai_inference');
            inferenceGR.addQuery('u_target', sys_id);
            inferenceGR.orderByDesc('sys_created_on');
            inferenceGR.setLimit(1);
            inferenceGR.query();
            if (inferenceGR.next()) {
                return inferenceGR.getValue('u_response') || "";
            } else {
                return "No summary found";
            }
        } catch (error) {
            return error;
        }
    },
    getSummarizeTemplate: function (table, sys_id, template) {
        try {
            if (!table) table = this.getParameter('sysparm_table') || "";
            if (!sys_id) sys_id = this.getParameter('sysparm_sys_id') || "";
            if (!template) template = this.getParameter('sysparm_template');
            var task = new GlideRecord(table);
            if (task.get(sys_id)) {
                var aiSummarierGR = new GlideRecord('u_ai_summarizer');
                aiSummarierGR.addQuery('u_active', 'true');
                aiSummarierGR.addQuery('u_table', table);
                aiSummarierGR.setLimit(1);
                aiSummarierGR.query();
                if (aiSummarierGR.next()) {
                    var recordTemplate;
                    if (!template) recordTemplate = aiSummarierGR.getValue('u_record_template');
                    if (template) recordTemplate = template;
                    var recordFieldsFromTemplate = recordTemplate.match(/{{(.*?)}}/g);
                    var fields = recordFieldsFromTemplate.map(function (field) {
                        field = field.replace('{{', '').replace('}}', '');
                        return field;
                    });

                    var taskText = recordTemplate + '';
                    fields.forEach(function (field) {
                        var value = task.getDisplayValue(field) || '';
                        if (field == "__all_variables__") {
                            value += "Variables:\n";
                            for (var prop in task.variables) {
                                value += prop + ': ' + task.variables[prop] + '\n';
                            }
                        }
                        if (field.indexOf('__related__') > -1) {
                            try {
                                var clearField = field.replace('__related__', '');
                                var parts = clearField.split('__');
                                var rTable = parts[0];
                                var rQuery = parts[1];
                                var rField = parts[2].split(',');
                                (function () {
                                    var re = /\[\[(.*?)\]\]/g;
                                    var match;
                                    var result = [];
                                    while (match = re.exec(rQuery)) {
                                        result.push(match[1]);
                                    }
                                    result.forEach(function (r) {
                                        rQuery = rQuery.replace('[[' + r + ']]', task.getValue(r));
                                    });
                                })();
                                var rGR = new GlideRecord(rTable);
                                rGR.addQuery(rQuery);
                                rGR.setLimit(10);
                                rGR.query();
                                var rValues = [];
                                while (rGR.next()) {
                                    var rFields = []
                                    rField.forEach(function (dField) {
                                        rFields.push(rGR.getElement(dField).getLabel() + ': ' + rGR.getDisplayValue(dField));
                                    });
                                    rValues.push(rFields.join('\n>'));
                                }
                                value = rValues.join('\n\n');
                            } catch (e) {
                                value = "ERROR: " + e
                            }
                        }
                        taskText = taskText.replace('{{' + field + '}}', value);
                    });
                    return taskText;
                } else {
                    return "Cannot find Summarizer Record";
                }
            } else {
                return "Cannot find Task";
            }
        } catch (error) {
            return "Error: " + error;
        }
    },

    commentToCode: function (instruction, script) {
        try {
            if (!instruction) instruction = this.getParameter('sysparm_instruction') || "";
            if (!script) script = this.getParameter('sysparm_script') || "";

            var baseUrl = gs.getProperty('scribe.url');
            var midserver = gs.getProperty('scribe.midserver');
            var tokenRestCall = new sn_ws.RESTMessageV2();
            tokenRestCall.setHttpMethod('post');
            tokenRestCall.setEndpoint(baseUrl + '/api/v1/auths/signin');
            tokenRestCall.setRequestHeader('Content-Type', 'application/json');
            var tokenBody = {
                "email": gs.getProperty('scribe.email'),
                "password": gs.getProperty('scribe.password')
            };
            tokenRestCall.setRequestBody(JSON.stringify(tokenBody));
            tokenRestCall.setMIDServer(midserver);
            var tokenResponse = tokenRestCall.execute();
            var tokenResponseBody = tokenResponse.getBody();
            var token = JSON.parse(tokenResponseBody).token || false;
            if (!token) return "Cannot Summarize, token not valid";
            var generateRestCall = new sn_ws.RESTMessageV2();
            generateRestCall.setHttpMethod('post');
            generateRestCall.setEndpoint(baseUrl + '/summarizeTask');
            generateRestCall.setRequestHeader('Content-Type', 'application/json');
            generateRestCall.setRequestHeader('Authorization', 'Bearer ' + token);
            var generateBody = {
                "model": "starcoder:1b",
                "prompt": script,
                "stream": false,
                "options": {
                    "temperature": 0.2
                }
            };
            generateRestCall.setRequestBody(JSON.stringify(generateBody));
            generateRestCall.setMIDServer(midserver);
            var generateResponse = generateRestCall.execute();
            var generateResponseBody = generateResponse.getBody();
            gs.info(generateResponseBody);
            var llmResponse = JSON.parse(generateResponseBody);
            var answer = llmResponse.response;
            return answer;
        } catch (error) {
            return error;
        }
    },
    
    testToolDirect: function() {
        try {
            var toolId = this.getParameter('sysparm_tool_id') || '';
            var argsJson = this.getParameter('sysparm_args') || '{}';
            
            if (!toolId) {
                return JSON.stringify({ error: 'Missing tool_id parameter' });
            }
            
            var toolGR = new GlideRecord('u_ai_tool');
            if (!toolGR.get(toolId)) {
                return JSON.stringify({ error: 'Tool not found: ' + toolId });
            }
            
            var isActive = toolGR.u_active == true;
            if (!isActive) {
                return JSON.stringify({ error: 'Tool is not active' });
            }
            
            var scriptText = toolGR.getValue('u_script') || '';
            if (!scriptText) {
                return JSON.stringify({ error: 'Tool has no script defined' });
            }
            
            var args;
            try {
                args = JSON.parse(argsJson);
            } catch (e) {
                return JSON.stringify({ error: 'Invalid JSON arguments: ' + e.message });
            }
            
            var startTime = new GlideDateTime();
            var userId = gs.getUserID();
            
            var evaluator = new GlideScopedEvaluator();
            evaluator.putVariable('args', args);
            evaluator.putVariable('userId', userId);
            
            var result = evaluator.evaluateScript(toolGR, 'u_script');
            
            var endTime = new GlideDateTime();
            var executionTime = GlideDateTime.subtract(startTime, endTime).getNumericValue();
            
            return JSON.stringify({
                result: result,
                execution_time: executionTime,
                tool_name: toolGR.getValue('u_name'),
                args_used: args
            });
            
        } catch (error) {
            return JSON.stringify({ 
                error: 'Script execution error: ' + (error.message || error.toString())
            });
        }
    },

    type: 'aiabAjax'
});]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>jacebenson</sys_created_by>
        <sys_created_on>2024-02-12 07:43:24</sys_created_on>
        <sys_id>7849113993948210071230a97bba105f</sys_id>
        <sys_mod_count>276</sys_mod_count>
        <sys_name>aiabAjax</sys_name>
        <sys_package display_value="AI in a Box" source="0439d1f593948210071230a97bba1016">0439d1f593948210071230a97bba1016</sys_package>
        <sys_policy/>
        <sys_scope display_value="AI in a Box">0439d1f593948210071230a97bba1016</sys_scope>
        <sys_update_name>sys_script_include_7849113993948210071230a97bba105f</sys_update_name>
        <sys_updated_by>opencode</sys_updated_by>
        <sys_updated_on>2026-02-13 08:15:18</sys_updated_on>
    </sys_script_include>
    <sys_update_version action="INSERT_OR_UPDATE">
        <action>DELETE</action>
        <application display_value="AI in a Box">0439d1f593948210071230a97bba1016</application>
        <file_path/>
        <instance_id>3e01943a1b79f9901024eb9b2d4bcb05</instance_id>
        <instance_name>dev184755</instance_name>
        <name>sys_script_include_7849113993948210071230a97bba105f</name>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_include"&gt;&lt;sys_script_include action="INSERT_OR_UPDATE"&gt;&lt;access&gt;public&lt;/access&gt;&lt;active&gt;true&lt;/active&gt;&lt;api_name&gt;global.aiabAjax&lt;/api_name&gt;&lt;caller_access&gt;1&lt;/caller_access&gt;&lt;client_callable&gt;true&lt;/client_callable&gt;&lt;description/&gt;&lt;mobile_callable&gt;false&lt;/mobile_callable&gt;&lt;name&gt;aiabAjax&lt;/name&gt;&lt;sandbox_callable&gt;true&lt;/sandbox_callable&gt;&lt;script&gt;&lt;![CDATA[var aiabAjax = Class.create();
aiabAjax.prototype = Object.extendsObject(AbstractAjaxProcessor, {
    cancelAIInference: function (sys_id, table, inferenceId) {
        try {
            if (!sys_id) sys_id = this.getParameter('sysparm_sys_id') || false;
            if (!table) table = this.getParameter('sysparm_table') || false;
            if (!inferenceId) inferenceId = this.getParameter('sysparm_inference_id') || false;
            var inference = new GlideRecord('u_ai_inference');
            if (inferenceId) {
                inference.addQuery('sys_id', inferenceId);
            }
            if (table &amp;&amp; sys_id) {
                inference.addQuery('u_table', table);
                inference.addQuery('u_target', sys_id);
            }
            inference.addQuery('u_state', 'requested');
            inference.orderByDesc('sys_created_on');
            inference.query();
            if (inference.hasNext() === false) {
                return "Nothing to cancel.";
            }
            while (inference.next()) {
                inference.setValue('u_state', 'cancelled');
                inference.update();
                return "Cancelled Inference.";
            }
        } catch (error) {

        }
    },
    createAIInference: function (sys_id, table, type) {
        try {
            if (!sys_id) sys_id = this.getParameter('sysparm_sys_id') || "";
            if (!table) table = this.getParameter('sysparm_table') || "";
            if (!type) type = this.getParameter('sysparm_type') || "generic";
            var data = this.getParameter('sysparm_data') || {};
            var prompt = this.getParameter('sysparm_prompt') || '';
            var toolsIncluded = this.getParameter('sysparm_tools_included') || '';
            
            var inference = new GlideRecord('u_ai_inference');
            inference.newRecord();
            inference.setValue('u_target', sys_id);
            inference.setValue('u_table', table);
            inference.setValue('u_metadata', data);
            inference.setValue('u_type', type);
            
            // If prompt provided, set it directly
            if (prompt) {
                inference.setValue('u_prompt', prompt);
            }
            
            // If specific tools included, set them
            if (toolsIncluded) {
                inference.setValue('u_tools_included', toolsIncluded);
            }
            
            return inference.insert();
        } catch (error) {
            return error;
        }
    },
    createAIChat: function (messages) {
        try {
            if (!messages) messages = this.getParameter('sysparm_messages') || this.getParameter('sysparm_conversation') || false;
            if (messages == false) {
                return JSON.stringify({ error: "missing messages" })
            }
            
            var recordTable = this.getParameter('sysparm_table') || '';
            var recordSysId = this.getParameter('sysparm_record') || '';
            var toolsIncluded = this.getParameter('sysparm_tools_included') || '';
            
            var inference = new GlideRecord('u_ai_inference');
            inference.newRecord();
            inference.setValue('u_type','chat');
            
            if (recordTable &amp;&amp; recordSysId) {
                inference.setValue('u_table', recordTable);
                inference.setValue('u_target', recordSysId);
            }
            
            // Set specific tools if provided
            if (toolsIncluded) {
                inference.setValue('u_tools_included', toolsIncluded);
            }
            
            var systemPrompt = gs.getProperty('ai_in_a_box.feature.chat.system_prompt') || 
                "You are a helpful AI assistant. Answer questions clearly and concisely. If you don't know the answer, say so.";
            
            var context = [{
                role: "system",
                content: systemPrompt
            }];
            
            var userContext = this._buildUserContext();
            if (userContext) {
                context[0].content += '\n\n--- Current User Context ---\n' + userContext;
            }
            
            if (recordTable &amp;&amp; recordSysId) {
                var recContext = this._buildRecordContext(recordTable, recordSysId);
                if (recContext) {
                    context[0].content += '\n\n--- Current Record Context ---\n' + recContext;
                }
            }
            
            var parsedMessages = JSON.parse(messages);
            parsedMessages = context.concat(parsedMessages);
            inference.setValue('u_prompt', JSON.stringify(parsedMessages, null, 4));
            return inference.insert();
            
        } catch (error) {
            return '';
        }
    },
    
    getAIInference: function(inferenceId) {
        try {
            if (!inferenceId) inferenceId = this.getParameter('sysparm_sys_id') || '';
            if (!inferenceId) {
                return JSON.stringify({ error: 'missing sys_id' });
            }
            
            var gr = new GlideRecord('u_ai_inference');
            if (gr.get(inferenceId)) {
                return JSON.stringify({
                    response: gr.getValue('u_response') || '',
                    state: gr.getValue('u_state') || ''
                });
            } else {
                return JSON.stringify({ error: 'not found' });
            }
        } catch (error) {
            return JSON.stringify({ error: error.message || 'unknown error' });
        }
    },
    
    getChatHistory: function() {
        try {
            var table = this.getParameter('sysparm_table') || '';
            var record = this.getParameter('sysparm_record') || '';
            
            if (!table || !record) {
                return JSON.stringify({ chats: [] });
            }
            
            var chats = [];
            var gr = new GlideRecord('u_ai_inference');
            gr.addQuery('u_type', 'chat');
            gr.addQuery('u_table', table);
            gr.addQuery('u_target', record);
            gr.addQuery('sys_created_by', gs.getUserName());
            gr.addQuery('u_state', 'finished');
            gr.orderByDesc('sys_created_on');
            gr.setLimit(10);
            gr.query();
            
            while (gr.next()) {
                var preview = 'Chat conversation';
                try {
                    var prompt = JSON.parse(gr.getValue('u_prompt') || '[]');
                    for (var i = 0; i &lt; prompt.length; i++) {
                        if (prompt[i].role === 'user') {
                            preview = prompt[i].content || '';
                            if (preview.length &gt; 50) {
                                preview = preview.substring(0, 50) + '...';
                            }
                            break;
                        }
                    }
                } catch(e) {
                }
                
                chats.push({
                    sys_id: gr.getValue('sys_id'),
                    created: gr.getDisplayValue('sys_created_on'),
                    preview: preview
                });
            }
            
            return JSON.stringify({ chats: chats });
        } catch (error) {
            return JSON.stringify({ chats: [], error: error.message || 'unknown error' });
        }
    },
    
    loadChatConversation: function() {
        try {
            var sysId = this.getParameter('sysparm_sys_id') || '';
            
            if (!sysId) {
                return JSON.stringify({ error: 'missing sys_id' });
            }
            
            var gr = new GlideRecord('u_ai_inference');
            if (!gr.get(sysId)) {
                return JSON.stringify({ error: 'not found' });
            }
            
            if (gr.getValue('sys_created_by') !== gs.getUserName()) {
                return JSON.stringify({ error: 'access denied' });
            }
            
            var messages = [];
            try {
                var prompt = JSON.parse(gr.getValue('u_prompt') || '[]');
                for (var i = 0; i &lt; prompt.length; i++) {
                    if (prompt[i].role === 'user' || prompt[i].role === 'assistant') {
                        messages.push({
                            role: prompt[i].role,
                            content: prompt[i].content || ''
                        });
                    }
                }
            } catch(e) {
            }
            
            var response = gr.getValue('u_response') || '';
            if (response &amp;&amp; messages.length &gt; 0 &amp;&amp; messages[messages.length - 1].role !== 'assistant') {
                messages.push({ role: 'assistant', content: response });
            }
            
            return JSON.stringify({ messages: messages });
        } catch (error) {
            return JSON.stringify({ error: error.message || 'unknown error' });
        }
    },
    
    _buildUserContext: function() {
        var user = new GlideRecord('sys_user');
        if (!user.get(gs.getUserID())) return '';
        
        var lines = [
            'Logged in user: ' + user.getDisplayValue('name'),
            '- Email: ' + (user.getValue('email') || 'Not set'),
            '- Title: ' + (user.getValue('title') || 'Not set'),
            '- Department: ' + (user.getDisplayValue('department') || 'Not set'),
            '- Location: ' + (user.getDisplayValue('location') || 'Not set'),
            '- Manager: ' + (user.getDisplayValue('manager') || 'Not set')
        ];
        
        return lines.join('\n');
    },
    
    _buildRecordContext: function(table, sysId) {
        var gr = new GlideRecord(table);
        if (!gr.get(sysId)) return '';
        
        var userId = gs.getUserID();
        var lines = [
            'Table: ' + table,
            'Record: ' + gr.getDisplayValue()
        ];
        
        if (gr.isValidField('number')) {
            lines.push('Number: ' + gr.getValue('number'));
        }
        
        if (gr.isValidField('short_description')) {
            lines.push('Short description: ' + gr.getValue('short_description'));
        }
        
        if (gr.isValidField('description') &amp;&amp; gr.getValue('description')) {
            var desc = gr.getValue('description');
            if (desc.length &gt; 500) {
                desc = desc.substring(0, 500) + '...';
            }
            lines.push('Description: ' + desc);
        }
        
        if (gr.isValidField('state')) {
            lines.push('State: ' + gr.getDisplayValue('state'));
        }
        
        if (gr.isValidField('priority')) {
            lines.push('Priority: ' + gr.getDisplayValue('priority'));
        }
        
        var callerFields = ['caller_id', 'requested_by', 'u_requested_by', 'contact', 'opened_by'];
        for (var c = 0; c &lt; callerFields.length; c++) {
            var callerField = callerFields[c];
            if (gr.isValidField(callerField) &amp;&amp; gr.getValue(callerField)) {
                var callerLabel = gr.getElement(callerField).getLabel();
                lines.push(callerLabel + ': ' + gr.getDisplayValue(callerField));
            }
        }
        
        if (gr.isValidField('assigned_to') &amp;&amp; gr.getValue('assigned_to')) {
            lines.push('Assigned to: ' + gr.getDisplayValue('assigned_to'));
        }
        
        if (gr.isValidField('assignment_group') &amp;&amp; gr.getValue('assignment_group')) {
            lines.push('Assignment group: ' + gr.getDisplayValue('assignment_group'));
        }
        
        if (gr.isValidField('category') &amp;&amp; gr.getValue('category')) {
            lines.push('Category: ' + gr.getDisplayValue('category'));
        }
        if (gr.isValidField('subcategory') &amp;&amp; gr.getValue('subcategory')) {
            lines.push('Subcategory: ' + gr.getDisplayValue('subcategory'));
        }
        
        if (gr.isValidField('sys_created_on')) {
            lines.push('Created: ' + gr.getDisplayValue('sys_created_on'));
        }
        if (gr.isValidField('sys_updated_on')) {
            lines.push('Last updated: ' + gr.getDisplayValue('sys_updated_on'));
        }
        
        var relationships = this._determineUserRelationship(gr, userId);
        if (relationships.length &gt; 0) {
            lines.push('');
            lines.push('Your relationship to this record:');
            for (var r = 0; r &lt; relationships.length; r++) {
                lines.push('- ' + relationships[r]);
            }
        }
        
        return lines.join('\n');
    },
    
    _determineUserRelationship: function(gr, userId) {
        var relationships = [];
        
        var callerFields = ['caller_id', 'opened_by', 'requested_by', 'u_requested_by', 'contact'];
        for (var i = 0; i &lt; callerFields.length; i++) {
            var field = callerFields[i];
            if (gr.isValidField(field) &amp;&amp; gr.getValue(field) === userId) {
                relationships.push('You are the ' + gr.getElement(field).getLabel());
                break;
            }
        }
        
        if (gr.isValidField('assigned_to') &amp;&amp; gr.getValue('assigned_to') === userId) {
            relationships.push('You are assigned to this record');
        }
        
        if (gr.isValidField('assignment_group') &amp;&amp; gr.getValue('assignment_group')) {
            var groupId = gr.getValue('assignment_group');
            var groupMember = new GlideRecord('sys_user_grmember');
            groupMember.addQuery('group', groupId);
            groupMember.addQuery('user', userId);
            groupMember.setLimit(1);
            groupMember.query();
            if (groupMember.hasNext()) {
                relationships.push('You are a member of the assignment group');
            }
        }
        
        if (gr.isValidField('assigned_to') &amp;&amp; gr.getValue('assigned_to')) {
            var assignee = new GlideRecord('sys_user');
            if (assignee.get(gr.getValue('assigned_to'))) {
                if (assignee.getValue('manager') === userId) {
                    relationships.push('You are the manager of the assignee');
                }
            }
        }
        
        if (relationships.length === 0) {
            relationships.push('You are viewing this record (no direct relationship)');
        }
        
        return relationships;
    },

    askClientScript: function (sys_id, table, prompt, script) {
        try {
            if (!sys_id) sys_id = this.getParameter('sysparm_sys_id') || "";
            if (!table) table = this.getParameter('sysparm_table') || "";
            if (!script) script = this.getParameter('sysparm_script') || "";
            if (!prompt) prompt = this.getParameter('sysparm_prompt');
            var inference = new GlideRecord('u_ai_inference');
            inference.newRecord();
            inference.setValue('u_target', sys_id);
            inference.setValue('u_table', table);
            var jsonPrompt = [
                {
                    role: "system",
                    content: "You are a helpful assistant."
                },
                {
                    role: "user",
                    content: 'I have a question about this code.\n\n"""' + script + '\n""""'
                }
            ]
            inference.setValue('u_prompt', JSON.stringify(jsonPrompt));
            inference.setValue('u_type', 'generic');
            return inference.insert();
        } catch (error) {
            return error;
        }
    },
    createAIInferenceAskRecord: function (sys_id, table, prompt) {
        try {
            if (!sys_id) sys_id = this.getParameter('sysparm_sys_id') || "";
            if (!table) table = this.getParameter('sysparm_table') || "";
            if (!prompt) prompt = this.getParameter('sysparm_prompt');
            var inference = new GlideRecord('u_ai_inference');
            inference.newRecord();
            inference.setValue('u_target', sys_id);
            inference.setValue('u_table', table);
            inference.setValue('u_prompt', prompt);
            inference.setValue('u_type', 'ask-record');
            return inference.insert();
        } catch (error) {
            return error;
        }
    },
    isChatEnabled: function () {
        var enabled = gs.getProperty('ai_in_a_box.feature.chat.enabled') == 'true';
        if (!enabled) return 'false';
        
        var rolesStr = gs.getProperty('ai_in_a_box.feature.chat.roles') || '';
        if (!rolesStr) return 'true';
        
        var roles = rolesStr.split(',');
        for (var i = 0; i &lt; roles.length; i++) {
            if (gs.hasRole(roles[i].trim())) {
                return 'true';
            }
        }
        return 'false';
    },
    getInferenceRecord: function (sys_id) {
        try {
            if (!sys_id) sys_id = this.getParameter('sysparm_sys_id') || "";
            var inferenceGR = new GlideRecord('u_ai_inference');
            inferenceGR.addQuery('u_target', sys_id);
            inferenceGR.orderByDesc('sys_created_on');
            inferenceGR.setLimit(1);
            inferenceGR.query();
            if (inferenceGR.next()) {
                return inferenceGR.getValue('u_response') || "";
            } else {
                return "No summary found";
            }
        } catch (error) {
            return error;
        }
    },
    getSummarizeTemplate: function (table, sys_id, template) {
        try {
            if (!table) table = this.getParameter('sysparm_table') || "";
            if (!sys_id) sys_id = this.getParameter('sysparm_sys_id') || "";
            if (!template) template = this.getParameter('sysparm_template');
            var task = new GlideRecord(table);
            if (task.get(sys_id)) {
                var aiSummarierGR = new GlideRecord('u_ai_summarizer');
                aiSummarierGR.addQuery('u_active', 'true');
                aiSummarierGR.addQuery('u_table', table);
                aiSummarierGR.setLimit(1);
                aiSummarierGR.query();
                if (aiSummarierGR.next()) {
                    var recordTemplate;
                    if (!template) recordTemplate = aiSummarierGR.getValue('u_record_template');
                    if (template) recordTemplate = template;
                    var recordFieldsFromTemplate = recordTemplate.match(/{{(.*?)}}/g);
                    var fields = recordFieldsFromTemplate.map(function (field) {
                        field = field.replace('{{', '').replace('}}', '');
                        return field;
                    });

                    var taskText = recordTemplate + '';
                    fields.forEach(function (field) {
                        var value = task.getDisplayValue(field) || '';
                        if (field == "__all_variables__") {
                            value += "Variables:\n";
                            for (var prop in task.variables) {
                                value += prop + ': ' + task.variables[prop] + '\n';
                            }
                        }
                        if (field.indexOf('__related__') &gt; -1) {
                            try {
                                var clearField = field.replace('__related__', '');
                                var parts = clearField.split('__');
                                var rTable = parts[0];
                                var rQuery = parts[1];
                                var rField = parts[2].split(',');
                                (function () {
                                    var re = /\[\[(.*?)\]\]/g;
                                    var match;
                                    var result = [];
                                    while (match = re.exec(rQuery)) {
                                        result.push(match[1]);
                                    }
                                    result.forEach(function (r) {
                                        rQuery = rQuery.replace('[[' + r + ']]', task.getValue(r));
                                    });
                                })();
                                var rGR = new GlideRecord(rTable);
                                rGR.addQuery(rQuery);
                                rGR.setLimit(10);
                                rGR.query();
                                var rValues = [];
                                while (rGR.next()) {
                                    var rFields = []
                                    rField.forEach(function (dField) {
                                        rFields.push(rGR.getElement(dField).getLabel() + ': ' + rGR.getDisplayValue(dField));
                                    });
                                    rValues.push(rFields.join('\n&gt;'));
                                }
                                value = rValues.join('\n\n');
                            } catch (e) {
                                value = "ERROR: " + e
                            }
                        }
                        taskText = taskText.replace('{{' + field + '}}', value);
                    });
                    return taskText;
                } else {
                    return "Cannot find Summarizer Record";
                }
            } else {
                return "Cannot find Task";
            }
        } catch (error) {
            return "Error: " + error;
        }
    },

    commentToCode: function (instruction, script) {
        try {
            if (!instruction) instruction = this.getParameter('sysparm_instruction') || "";
            if (!script) script = this.getParameter('sysparm_script') || "";

            var baseUrl = gs.getProperty('scribe.url');
            var midserver = gs.getProperty('scribe.midserver');
            var tokenRestCall = new sn_ws.RESTMessageV2();
            tokenRestCall.setHttpMethod('post');
            tokenRestCall.setEndpoint(baseUrl + '/api/v1/auths/signin');
            tokenRestCall.setRequestHeader('Content-Type', 'application/json');
            var tokenBody = {
                "email": gs.getProperty('scribe.email'),
                "password": gs.getProperty('scribe.password')
            };
            tokenRestCall.setRequestBody(JSON.stringify(tokenBody));
            tokenRestCall.setMIDServer(midserver);
            var tokenResponse = tokenRestCall.execute();
            var tokenResponseBody = tokenResponse.getBody();
            var token = JSON.parse(tokenResponseBody).token || false;
            if (!token) return "Cannot Summarize, token not valid";
            var generateRestCall = new sn_ws.RESTMessageV2();
            generateRestCall.setHttpMethod('post');
            generateRestCall.setEndpoint(baseUrl + '/summarizeTask');
            generateRestCall.setRequestHeader('Content-Type', 'application/json');
            generateRestCall.setRequestHeader('Authorization', 'Bearer ' + token);
            var generateBody = {
                "model": "starcoder:1b",
                "prompt": script,
                "stream": false,
                "options": {
                    "temperature": 0.2
                }
            };
            generateRestCall.setRequestBody(JSON.stringify(generateBody));
            generateRestCall.setMIDServer(midserver);
            var generateResponse = generateRestCall.execute();
            var generateResponseBody = generateResponse.getBody();
            gs.info(generateResponseBody);
            var llmResponse = JSON.parse(generateResponseBody);
            var answer = llmResponse.response;
            return answer;
        } catch (error) {
            return error;
        }
    },
    
    testToolDirect: function() {
        try {
            var toolId = this.getParameter('sysparm_tool_id') || '';
            var argsJson = this.getParameter('sysparm_args') || '{}';
            
            if (!toolId) {
                return JSON.stringify({ error: 'Missing tool_id parameter' });
            }
            
            var toolGR = new GlideRecord('u_ai_tool');
            if (!toolGR.get(toolId)) {
                return JSON.stringify({ error: 'Tool not found: ' + toolId });
            }
            
            var isActive = toolGR.u_active == true;
            if (!isActive) {
                return JSON.stringify({ error: 'Tool is not active' });
            }
            
            var scriptText = toolGR.getValue('u_script') || '';
            if (!scriptText) {
                return JSON.stringify({ error: 'Tool has no script defined' });
            }
            
            var args;
            try {
                args = JSON.parse(argsJson);
            } catch (e) {
                return JSON.stringify({ error: 'Invalid JSON arguments: ' + e.message });
            }
            
            var startTime = new GlideDateTime();
            var userId = gs.getUserID();
            
            var evaluator = new GlideScopedEvaluator();
            evaluator.putVariable('args', args);
            evaluator.putVariable('userId', userId);
            
            var result = evaluator.evaluateScript(toolGR, 'u_script');
            
            var endTime = new GlideDateTime();
            var executionTime = GlideDateTime.subtract(startTime, endTime).getNumericValue();
            
            return JSON.stringify({
                result: result,
                execution_time: executionTime,
                tool_name: toolGR.getValue('u_name'),
                args_used: args
            });
            
        } catch (error) {
            return JSON.stringify({ 
                error: 'Script execution error: ' + (error.message || error.toString())
            });
        }
    },

    type: 'aiabAjax'
});]]&gt;&lt;/script&gt;&lt;sys_class_name&gt;sys_script_include&lt;/sys_class_name&gt;&lt;sys_created_by&gt;jacebenson&lt;/sys_created_by&gt;&lt;sys_created_on&gt;2024-02-12 07:43:24&lt;/sys_created_on&gt;&lt;sys_id&gt;7849113993948210071230a97bba105f&lt;/sys_id&gt;&lt;sys_mod_count&gt;276&lt;/sys_mod_count&gt;&lt;sys_name&gt;aiabAjax&lt;/sys_name&gt;&lt;sys_package display_value="AI in a Box" source="0439d1f593948210071230a97bba1016"&gt;0439d1f593948210071230a97bba1016&lt;/sys_package&gt;&lt;sys_policy/&gt;&lt;sys_scope display_value="AI in a Box"&gt;0439d1f593948210071230a97bba1016&lt;/sys_scope&gt;&lt;sys_update_name&gt;sys_script_include_7849113993948210071230a97bba105f&lt;/sys_update_name&gt;&lt;sys_updated_by&gt;opencode&lt;/sys_updated_by&gt;&lt;sys_updated_on&gt;2026-02-13 08:15:18&lt;/sys_updated_on&gt;&lt;/sys_script_include&gt;&lt;/record_update&gt;</payload>
        <payload_hash>192686355</payload_hash>
        <record_name>aiabAjax</record_name>
        <reverted_from/>
        <source>fb79436b835232104d4fccb6feaad310</source>
        <source_table>sys_update_set</source_table>
        <state>previous</state>
        <sys_created_by>opencode</sys_created_by>
        <sys_created_on>2026-02-13 08:15:18</sys_created_on>
        <sys_id>727c0fd1838bb2504d4fccb6feaad35f</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_recorded_at>19c5611952d0000001</sys_recorded_at>
        <sys_updated_by>opencode</sys_updated_by>
        <sys_updated_on>2026-02-13 08:15:18</sys_updated_on>
        <type>Script Include</type>
        <update_guid>367c0fd1238bb2507b7d7f5ffc4e5f45</update_guid>
        <update_guid_history>367c0fd1238bb2507b7d7f5ffc4e5f45:192686355,a188155debcb72501f11f4d75ebb0b40:-1663016702,bbb6599951cb7250f94438bba74e1a20:-208432780,1ee4d9b66eae36100ed38dd0aa4cf8a6:-749143670,d9a1dde2a6eeb210ee1d46ca141a873e:149502410,1297ac2a9a6ab210cf55b80de3751155:1400021617,59742862496ab210fcf06afee64dbffa:294624323,3bf2e0ae5e2ab21053e499f4aef963f3:-983334388,59694c2a6466b210d95724e0bec64c4d:-172681476,6c7b7ceba52b221028f124294ee24844:-383780304,1ac9b02b412b2210541285f1257aaf36:-1782287730,76763467732b2210e90cd14d9ed51903:1739576918,7362f0aff4e722101dbd45b9c42f4b9c:1966432232</update_guid_history>
    </sys_update_version>
    <sys_metadata_delete action="INSERT_OR_UPDATE">
        <sys_audit_delete/>
        <sys_class_name>sys_metadata_delete</sys_class_name>
        <sys_created_by>opencode</sys_created_by>
        <sys_created_on>2026-02-14 07:24:09</sys_created_on>
        <sys_db_object display_value="" name="sys_script_include">sys_script_include</sys_db_object>
        <sys_id>86a931bdd1104ef09542d87f91c4f381</sys_id>
        <sys_metadata>7849113993948210071230a97bba105f</sys_metadata>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>aiabAjax</sys_name>
        <sys_package display_value="AI in a Box" source="0439d1f593948210071230a97bba1016">0439d1f593948210071230a97bba1016</sys_package>
        <sys_parent/>
        <sys_policy/>
        <sys_scope display_value="AI in a Box">0439d1f593948210071230a97bba1016</sys_scope>
        <sys_scope_delete display_value="">c1a48f6b4a924506a5b1a6becbc665a1</sys_scope_delete>
        <sys_update_name>sys_script_include_7849113993948210071230a97bba105f</sys_update_name>
        <sys_update_version display_value="sys_script_include_7849113993948210071230a97bba105f">727c0fd1838bb2504d4fccb6feaad35f</sys_update_version>
        <sys_updated_by>opencode</sys_updated_by>
        <sys_updated_on>2026-02-14 07:24:09</sys_updated_on>
    </sys_metadata_delete>
</record_update>
