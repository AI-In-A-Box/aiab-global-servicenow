<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="DELETE">
        <access>public</access>
        <active>true</active>
        <api_name>global.aiabHtmlToMarkdown</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description/>
        <mobile_callable>false</mobile_callable>
        <name>aiabHtmlToMarkdown</name>
        <sandbox_callable>false</sandbox_callable>
        <script><![CDATA[var aiabHtmlToMarkdown = Class.create();
aiabHtmlToMarkdown.prototype = {
    initialize: function() {},

    convert: function(html) {
        var tree = this.parseHTML(html);
        var markdown = this.processNode(tree).trim().replace(/\n{3,}/g, '\n\n');
        var emptyLinks = markdown.match(/\[\]\(\)/g);
        if (emptyLinks) {
            for (var i = 0; i < emptyLinks.length; i++) {
                markdown = markdown.replace(emptyLinks[i], '');
            }
        }
		return markdown;
    },

    parseHTML: function(html) {
        var root = {
            type: 'root',
            children: []
        };
        var stack = [root];
        var current = root;
        var pos = 0;
        var voidElements = {
            img: 1,
            br: 1,
            hr: 1,
            meta: 1,
            link: 1,
            input: 1
        };
        var skipTags = {
            style: 1,
            script: 1
        };

        while (pos < html.length) {
            if (html[pos] === '<') {
                var end = html.indexOf('>', pos);
                if (end === -1) break;

                var tagContent = html.substring(pos + 1, end).replace(/\/$/, '');
                var isClosing = tagContent[0] === '/';
                var spaceIndex = tagContent.indexOf(' ');
                var tagName = (isClosing ? tagContent.substring(1) : tagContent)
                    .toLowerCase().split(/\s+/)[0];

                // Skip content of style/script tags
                if (!isClosing && skipTags[tagName]) {
                    var closingTag = '</' + tagName + '>';
                    var tagEnd = html.indexOf(closingTag, end);
                    if (tagEnd === -1) {
                        pos = html.length;
                    } else {
                        pos = tagEnd + closingTag.length;
                    }
                    continue;
                }

                if (isClosing) {
                    while (stack.length > 1 && current.tagName !== tagName) {
                        stack.pop();
                        current = stack[stack.length - 1];
                    }
                    if (current.tagName === tagName) {
                        stack.pop();
                        current = stack[stack.length - 1];
                    }
                } else {
                    var node = {
                        type: 'element',
                        tagName: tagName,
                        attributes: this.parseAttributes(tagContent),
                        children: []
                    };

                    current.children.push(node);
                    if (!voidElements[tagName] && !tagContent.endsWith('/')) {
                        stack.push(node);
                        current = node;
                    }
                }
                pos = end + 1;
            } else {
                var textEnd = html.indexOf('<', pos);
                if (textEnd === -1) textEnd = html.length;
                var text = html.substring(pos, textEnd)
                    .replace(/&nbsp;/g, ' ')
                    .replace(/\r?\n/g, '\n') // Preserve newlines
                    .replace(/[^\S\n]+/g, ' ') // Collapse multiple spaces
                    .trim();

                if (text) {
                    current.children.push({
                        type: 'text',
                        value: text
                    });
                }
                pos = textEnd;
            }
        }
        return root;
    },

    parseAttributes: function(attrString) {
        var attrs = {};
        var matches = attrString.match(/(\w+)=["']([^"']*)["']/g) || [];
        for (var i = 0; i < matches.length; i++) {
            var pair = matches[i].split('=');
            attrs[pair[0]] = pair[1].replace(/^["']|["']$/g, '');
        }
        return attrs;
    },

    processNode: function(node) {
        if (node.type === 'text') {
            return node.value.replace(/\n/g, ' ') // Handle newlines in text
                .replace(/  +/g, ' ');
        }

        var tag = node.tagName;
        var children = node.children || [];

        // Headings
        if (/^h[1-6]$/.test(tag)) {
            var level = parseInt(tag.charAt(1), 10);
            return '\n' + Array(level + 1).join('#') + ' ' + this.processChildren(children) + '\n';
        }

        // Paragraphs (preserve surrounding newlines)
        if (tag === 'p') {
            return '\n' + this.processChildren(children).replace(/\n/g, ' ') + '\n\n';
        }

        // Lists
        if (tag === 'ul') return this.processList(children, false);
        if (tag === 'ol') return this.processList(children, true);

        // List items
        if (tag === 'li') return this.processChildren(children) + '\n';

        // Links
        if (tag === 'a') {
            var href = node.attributes.href || '';
            return '[' + this.processChildren(children) + '](' + href + ')';
        }

        // Images
        if (tag === 'img') {
            var src = node.attributes.src || '';
            var alt = node.attributes.alt || '';
            return '![' + alt + '](' + src + ')';
        }

        // Text formatting
        if (tag === 'strong' || tag === 'b') return '**' + this.processChildren(children) + '**';
        if (tag === 'em' || tag === 'i') return '*' + this.processChildren(children) + '*';
        if (tag === 'code') return '`' + this.processChildren(children) + '`';

        // Code blocks (preserve newlines)
        if (tag === 'pre') return '\n```\n' + this.processChildren(children) + '\n```\n';

        // Blockquotes
        if (tag === 'blockquote') {
            return '> ' + this.processChildren(children).replace(/\n/g, '\n> ');
        }

        // Line breaks (Markdown requires two spaces)
        if (tag === 'br') return '  \n';

        // Divs/sections (preserve newlines)
        if (tag === 'div' || tag === 'section') return this.processChildren(children) + '\n';

        if (tag === 'div') return this.processDiv(node);

        // Default case
        return this.processChildren(children);
    },

    processChildren: function(children) {
        var output = '';
        for (var i = 0; i < children.length; i++) {
            output += this.processNode(children[i]);
        }
        return output;
    },

    processList: function(items, isOrdered) {
        var output = '';
        var count = 1;

        for (var i = 0; i < items.length; i++) {
            var bullet = isOrdered ? count++ + '. ' : '- ';
            output += bullet + this.processNode(items[i]).trim() + '\n';

            // Process nested lists
            for (var j = 0; j < items[i].children.length; j++) {
                var child = items[i].children[j];
                if (child.tagName === 'ul' || child.tagName === 'ol') {
                    output += this.processList(child.children, child.tagName === 'ol');
                }
            }
        }
        return output;
    },
    processDiv: function(node) {
        var style = node.attributes.style || '';
        var children = node.children || [];
        var output = '';

        // Calculate indentation from left position
        var leftMatch = style.match(/left:\s*([\d.]+)pt/);
        var indentLevel = leftMatch ? Math.floor(parseFloat(leftMatch[1]) / 18) : 0;
        var indent = Array(indentLevel * 4 + 1).join(' ');

        // Check for bullet characters
        var hasBullet = false;
        var contentParts = [];

        for (var i = 0; i < children.length; i++) {
            var child = children[i];
            if (child.type === 'element' && child.tagName === 'span') {
                var spanContent = this.processNode(child).trim();

                // Detect bullet characters
                if (/[●•▪○]/.test(spanContent)) {
                    hasBullet = true;
                    contentParts.push('- '); // Markdown bullet
                } else {
                    contentParts.push(spanContent);
                }
            } else {
                contentParts.push(this.processNode(child));
            }
        }

        // Build output with proper indentation
        if (hasBullet) {
            output = indent + contentParts.join(' ').replace(/- +/g, '- ') + '\n';

            // Maintain list context for nested items
            if (indentLevel > this.currentIndent) {
                output = '\n' + output;
                this.currentIndent = indentLevel;
            }
        } else {
            output = this.processChildren(children) + '\n\n';
        }

        return output;
    },
    type: 'aiabHtmlToMarkdown'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-03-09 16:39:04</sys_created_on>
        <sys_id>7389f0fb830c2a107f36c5b5eeaad360</sys_id>
        <sys_mod_count>2</sys_mod_count>
        <sys_name>aiabHtmlToMarkdown</sys_name>
        <sys_package display_value="AI in a Box" source="0439d1f593948210071230a97bba1016">0439d1f593948210071230a97bba1016</sys_package>
        <sys_policy/>
        <sys_scope display_value="AI in a Box">0439d1f593948210071230a97bba1016</sys_scope>
        <sys_update_name>sys_script_include_7389f0fb830c2a107f36c5b5eeaad360</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-03-09 16:44:08</sys_updated_on>
    </sys_script_include>
    <sys_es_latest_script action="DELETE">
        <id>7389f0fb830c2a107f36c5b5eeaad360</id>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-03-09 16:39:03</sys_created_on>
        <sys_id>19a9b8bb830c2a107f36c5b5eeaad313</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-03-09 16:39:03</sys_updated_on>
        <table>sys_script_include</table>
        <use_es_latest>false</use_es_latest>
    </sys_es_latest_script>
    <sys_update_version action="INSERT_OR_UPDATE">
        <action>DELETE</action>
        <application display_value="AI in a Box">0439d1f593948210071230a97bba1016</application>
        <file_path/>
        <instance_id>3e01943a1b79f9901024eb9b2d4bcb05</instance_id>
        <instance_name>dev184755</instance_name>
        <name>sys_script_include_7389f0fb830c2a107f36c5b5eeaad360</name>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_include"&gt;&lt;sys_script_include action="INSERT_OR_UPDATE"&gt;&lt;access&gt;public&lt;/access&gt;&lt;active&gt;true&lt;/active&gt;&lt;api_name&gt;global.aiabHtmlToMarkdown&lt;/api_name&gt;&lt;caller_access/&gt;&lt;client_callable&gt;false&lt;/client_callable&gt;&lt;description/&gt;&lt;mobile_callable&gt;false&lt;/mobile_callable&gt;&lt;name&gt;aiabHtmlToMarkdown&lt;/name&gt;&lt;sandbox_callable&gt;false&lt;/sandbox_callable&gt;&lt;script&gt;&lt;![CDATA[var aiabHtmlToMarkdown = Class.create();
aiabHtmlToMarkdown.prototype = {
    initialize: function() {},

    convert: function(html) {
        var tree = this.parseHTML(html);
        var markdown = this.processNode(tree).trim().replace(/\n{3,}/g, '\n\n');
        var emptyLinks = markdown.match(/\[\]\(\)/g);
        if (emptyLinks) {
            for (var i = 0; i &lt; emptyLinks.length; i++) {
                markdown = markdown.replace(emptyLinks[i], '');
            }
        }
		return markdown;
    },

    parseHTML: function(html) {
        var root = {
            type: 'root',
            children: []
        };
        var stack = [root];
        var current = root;
        var pos = 0;
        var voidElements = {
            img: 1,
            br: 1,
            hr: 1,
            meta: 1,
            link: 1,
            input: 1
        };
        var skipTags = {
            style: 1,
            script: 1
        };

        while (pos &lt; html.length) {
            if (html[pos] === '&lt;') {
                var end = html.indexOf('&gt;', pos);
                if (end === -1) break;

                var tagContent = html.substring(pos + 1, end).replace(/\/$/, '');
                var isClosing = tagContent[0] === '/';
                var spaceIndex = tagContent.indexOf(' ');
                var tagName = (isClosing ? tagContent.substring(1) : tagContent)
                    .toLowerCase().split(/\s+/)[0];

                // Skip content of style/script tags
                if (!isClosing &amp;&amp; skipTags[tagName]) {
                    var closingTag = '&lt;/' + tagName + '&gt;';
                    var tagEnd = html.indexOf(closingTag, end);
                    if (tagEnd === -1) {
                        pos = html.length;
                    } else {
                        pos = tagEnd + closingTag.length;
                    }
                    continue;
                }

                if (isClosing) {
                    while (stack.length &gt; 1 &amp;&amp; current.tagName !== tagName) {
                        stack.pop();
                        current = stack[stack.length - 1];
                    }
                    if (current.tagName === tagName) {
                        stack.pop();
                        current = stack[stack.length - 1];
                    }
                } else {
                    var node = {
                        type: 'element',
                        tagName: tagName,
                        attributes: this.parseAttributes(tagContent),
                        children: []
                    };

                    current.children.push(node);
                    if (!voidElements[tagName] &amp;&amp; !tagContent.endsWith('/')) {
                        stack.push(node);
                        current = node;
                    }
                }
                pos = end + 1;
            } else {
                var textEnd = html.indexOf('&lt;', pos);
                if (textEnd === -1) textEnd = html.length;
                var text = html.substring(pos, textEnd)
                    .replace(/&amp;nbsp;/g, ' ')
                    .replace(/\r?\n/g, '\n') // Preserve newlines
                    .replace(/[^\S\n]+/g, ' ') // Collapse multiple spaces
                    .trim();

                if (text) {
                    current.children.push({
                        type: 'text',
                        value: text
                    });
                }
                pos = textEnd;
            }
        }
        return root;
    },

    parseAttributes: function(attrString) {
        var attrs = {};
        var matches = attrString.match(/(\w+)=["']([^"']*)["']/g) || [];
        for (var i = 0; i &lt; matches.length; i++) {
            var pair = matches[i].split('=');
            attrs[pair[0]] = pair[1].replace(/^["']|["']$/g, '');
        }
        return attrs;
    },

    processNode: function(node) {
        if (node.type === 'text') {
            return node.value.replace(/\n/g, ' ') // Handle newlines in text
                .replace(/  +/g, ' ');
        }

        var tag = node.tagName;
        var children = node.children || [];

        // Headings
        if (/^h[1-6]$/.test(tag)) {
            var level = parseInt(tag.charAt(1), 10);
            return '\n' + Array(level + 1).join('#') + ' ' + this.processChildren(children) + '\n';
        }

        // Paragraphs (preserve surrounding newlines)
        if (tag === 'p') {
            return '\n' + this.processChildren(children).replace(/\n/g, ' ') + '\n\n';
        }

        // Lists
        if (tag === 'ul') return this.processList(children, false);
        if (tag === 'ol') return this.processList(children, true);

        // List items
        if (tag === 'li') return this.processChildren(children) + '\n';

        // Links
        if (tag === 'a') {
            var href = node.attributes.href || '';
            return '[' + this.processChildren(children) + '](' + href + ')';
        }

        // Images
        if (tag === 'img') {
            var src = node.attributes.src || '';
            var alt = node.attributes.alt || '';
            return '![' + alt + '](' + src + ')';
        }

        // Text formatting
        if (tag === 'strong' || tag === 'b') return '**' + this.processChildren(children) + '**';
        if (tag === 'em' || tag === 'i') return '*' + this.processChildren(children) + '*';
        if (tag === 'code') return '`' + this.processChildren(children) + '`';

        // Code blocks (preserve newlines)
        if (tag === 'pre') return '\n```\n' + this.processChildren(children) + '\n```\n';

        // Blockquotes
        if (tag === 'blockquote') {
            return '&gt; ' + this.processChildren(children).replace(/\n/g, '\n&gt; ');
        }

        // Line breaks (Markdown requires two spaces)
        if (tag === 'br') return '  \n';

        // Divs/sections (preserve newlines)
        if (tag === 'div' || tag === 'section') return this.processChildren(children) + '\n';

        if (tag === 'div') return this.processDiv(node);

        // Default case
        return this.processChildren(children);
    },

    processChildren: function(children) {
        var output = '';
        for (var i = 0; i &lt; children.length; i++) {
            output += this.processNode(children[i]);
        }
        return output;
    },

    processList: function(items, isOrdered) {
        var output = '';
        var count = 1;

        for (var i = 0; i &lt; items.length; i++) {
            var bullet = isOrdered ? count++ + '. ' : '- ';
            output += bullet + this.processNode(items[i]).trim() + '\n';

            // Process nested lists
            for (var j = 0; j &lt; items[i].children.length; j++) {
                var child = items[i].children[j];
                if (child.tagName === 'ul' || child.tagName === 'ol') {
                    output += this.processList(child.children, child.tagName === 'ol');
                }
            }
        }
        return output;
    },
    processDiv: function(node) {
        var style = node.attributes.style || '';
        var children = node.children || [];
        var output = '';

        // Calculate indentation from left position
        var leftMatch = style.match(/left:\s*([\d.]+)pt/);
        var indentLevel = leftMatch ? Math.floor(parseFloat(leftMatch[1]) / 18) : 0;
        var indent = Array(indentLevel * 4 + 1).join(' ');

        // Check for bullet characters
        var hasBullet = false;
        var contentParts = [];

        for (var i = 0; i &lt; children.length; i++) {
            var child = children[i];
            if (child.type === 'element' &amp;&amp; child.tagName === 'span') {
                var spanContent = this.processNode(child).trim();

                // Detect bullet characters
                if (/[●•▪○]/.test(spanContent)) {
                    hasBullet = true;
                    contentParts.push('- '); // Markdown bullet
                } else {
                    contentParts.push(spanContent);
                }
            } else {
                contentParts.push(this.processNode(child));
            }
        }

        // Build output with proper indentation
        if (hasBullet) {
            output = indent + contentParts.join(' ').replace(/- +/g, '- ') + '\n';

            // Maintain list context for nested items
            if (indentLevel &gt; this.currentIndent) {
                output = '\n' + output;
                this.currentIndent = indentLevel;
            }
        } else {
            output = this.processChildren(children) + '\n\n';
        }

        return output;
    },
    type: 'aiabHtmlToMarkdown'
};]]&gt;&lt;/script&gt;&lt;sys_class_name&gt;sys_script_include&lt;/sys_class_name&gt;&lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;&lt;sys_created_on&gt;2025-03-09 16:39:04&lt;/sys_created_on&gt;&lt;sys_id&gt;7389f0fb830c2a107f36c5b5eeaad360&lt;/sys_id&gt;&lt;sys_mod_count&gt;2&lt;/sys_mod_count&gt;&lt;sys_name&gt;aiabHtmlToMarkdown&lt;/sys_name&gt;&lt;sys_package display_value="AI in a Box" source="0439d1f593948210071230a97bba1016"&gt;0439d1f593948210071230a97bba1016&lt;/sys_package&gt;&lt;sys_policy/&gt;&lt;sys_scope display_value="AI in a Box"&gt;0439d1f593948210071230a97bba1016&lt;/sys_scope&gt;&lt;sys_update_name&gt;sys_script_include_7389f0fb830c2a107f36c5b5eeaad360&lt;/sys_update_name&gt;&lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;&lt;sys_updated_on&gt;2025-03-09 16:44:08&lt;/sys_updated_on&gt;&lt;/sys_script_include&gt;&lt;sys_es_latest_script action="INSERT_OR_UPDATE"&gt;&lt;id&gt;7389f0fb830c2a107f36c5b5eeaad360&lt;/id&gt;&lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;&lt;sys_created_on&gt;2025-03-09 16:39:03&lt;/sys_created_on&gt;&lt;sys_id&gt;19a9b8bb830c2a107f36c5b5eeaad313&lt;/sys_id&gt;&lt;sys_mod_count&gt;0&lt;/sys_mod_count&gt;&lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;&lt;sys_updated_on&gt;2025-03-09 16:39:03&lt;/sys_updated_on&gt;&lt;table&gt;sys_script_include&lt;/table&gt;&lt;use_es_latest&gt;false&lt;/use_es_latest&gt;&lt;/sys_es_latest_script&gt;&lt;/record_update&gt;</payload>
        <payload_hash>1041245902</payload_hash>
        <record_name>aiabHtmlToMarkdown</record_name>
        <reverted_from/>
        <source>ee32c045831afe104d4fccb6feaad328</source>
        <source_table>sys_update_set</source_table>
        <state>previous</state>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-05 16:06:20</sys_created_on>
        <sys_id>ea424c45831afe104d4fccb6feaad3cc</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_recorded_at>19b8ee8cf4c0000001</sys_recorded_at>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-05 16:06:20</sys_updated_on>
        <type>Script Include</type>
        <update_guid>3762f0af78e72210092c2e7c66ace19a</update_guid>
        <update_guid_history>3762f0af78e72210092c2e7c66ace19a:1041245902</update_guid_history>
    </sys_update_version>
    <sys_metadata_delete action="INSERT_OR_UPDATE">
        <sys_audit_delete/>
        <sys_class_name>sys_metadata_delete</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-02-14 07:42:34</sys_created_on>
        <sys_db_object display_value="" name="sys_script_include">sys_script_include</sys_db_object>
        <sys_id>388744a8404f4372a0f330a6bbaa1aa4</sys_id>
        <sys_metadata>7389f0fb830c2a107f36c5b5eeaad360</sys_metadata>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>aiabHtmlToMarkdown</sys_name>
        <sys_package display_value="AI in a Box" source="0439d1f593948210071230a97bba1016">0439d1f593948210071230a97bba1016</sys_package>
        <sys_parent/>
        <sys_policy/>
        <sys_scope display_value="AI in a Box">0439d1f593948210071230a97bba1016</sys_scope>
        <sys_scope_delete display_value="">c1a48f6b4a924506a5b1a6becbc665a1</sys_scope_delete>
        <sys_update_name>sys_script_include_7389f0fb830c2a107f36c5b5eeaad360</sys_update_name>
        <sys_update_version display_value="sys_script_include_7389f0fb830c2a107f36c5b5eeaad360">ea424c45831afe104d4fccb6feaad3cc</sys_update_version>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-02-14 07:42:34</sys_updated_on>
    </sys_metadata_delete>
</record_update>
