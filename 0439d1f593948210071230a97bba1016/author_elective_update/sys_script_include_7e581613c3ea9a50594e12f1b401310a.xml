<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="DELETE">
        <access>public</access>
        <active>false</active>
        <api_name>global.aiabStatus</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description/>
        <mobile_callable>false</mobile_callable>
        <name>aiabStatus</name>
        <sandbox_callable>false</sandbox_callable>
        <script><![CDATA[//current aiiab
/* global Class,gs,GlideRecord, sn_ws */
/*eslint semi: "error"*/
var aiabStatus = Class.create();
aiabStatus.prototype = {
  initialize: function () { },
  canSummarize: function (table) {
    var enabled = gs.getProperty('ai_in_a_box.feature.summarize.enabled') == "true";
    if (enabled === false) return false;
    var userHasRole = gs.hasRole(gs.getProperty('ai_in_a_box.feature.summarize.roles'.split(',')));
    if (userHasRole === false) return false;
    return true;
  },
  featuresAndProperties: [
    {
      enabled: gs.getProperty('ai_in_a_box.config.midserver.enabled') == "true",
      properties: [
        'ai_in_a_box.config.midserver.enabled',
        'ai_in_a_box.config.midserver'
      ],
      label: "Midserver"
    },
    {
      enabled: gs.getProperty('ai_in_a_box.feature.summarize.enabled') == "true",
      roles: gs.getProperty('ai_in_a_box.feature.summarize.roles').split(','),
      properties: [
        'ai_in_a_box.feature.summarize.enabled',
        'ai_in_a_box.feature.summarize.roles',
      ],
      label: "Summarize"
    },
  {
    enabled: gs.getProperty('ai_in_a_box.feature.chat.enabled') == "true",
    roles: gs.getProperty('ai_in_a_box.feature.chat.roles').split(','),
    properties: [
      'ai_in_a_box.feature.chat.enabled',
      'ai_in_a_box.feature.chat.roles',
    ],
    label: "Chat"
  }
  ],
  status: function () {
    var summarize = (function () {
      var property = 'ai_in_a_box.feature.summarize.enabled';
      var returnObject = {
        "className": "btn btn-danger",
        "label": "Summarize",
        "buttonText": "Disabled",
        "url": "/sys_properties_list.do?sysparm_query=name=" + property
      };
      var value = gs.getProperty(property);
      if (value == null) {
        returnObject.buttonText = "Not Set";
        return returnObject;
      }
      if (value == "false") {
        returnObject.buttonText = "Disabled";
        returnObject.className = "btn btn-warning";
        return returnObject;
      }
      returnObject.className = "btn btn-success";
      returnObject.buttonText = '✅Done';
      return returnObject;
    })();
    var chat = (function () {
      var property = 'ai_in_a_box.feature.chat.enabled';
      var returnObject = {
        "className": "btn btn-danger",
        "label": "Chat",
        "buttonText": "Disabled",
        "url": "/sys_properties_list.do?sysparm_query=name=" + property
      };
      var value = gs.getProperty(property);
      if (value == null) {
        returnObject.buttonText = "Not Set";
        return returnObject;
      }
      if (value == "false") {
        returnObject.buttonText = "Disabled";
        returnObject.className = "btn btn-warning";
        return returnObject;
      }
      returnObject.className = "btn btn-success";
      returnObject.buttonText = '✅Done';
      return returnObject;
    })();
    // Tools ACL - checks if impersonation is configured for ACL-aware tool execution
    // Global Helper - checks if AIABGlobalHelper script include exists in global scope
    // Callback Auth - checks if the callback auth property is set
    var callbackAuth = (function () {
      var returnObject = {
        "className": "btn btn-warning",
        "label": "Callback Auth",
        "buttonText": "Not Set",
        "url": "/sys_properties_list.do?sysparm_query=name=ai_in_a_box.config.server.callback.auth",
        "description": "Authentication for AI server callbacks"
      };
      var authValue = gs.getProperty('ai_in_a_box.config.server.callback.auth');
      if (!authValue || authValue == '') {
        returnObject.className = 'btn btn-secondary';
        returnObject.buttonText = 'Not Set';
        return returnObject;
      }
      var parts = authValue.split(':');
      if (parts.length < 2) {
        returnObject.className = 'btn btn-danger';
        returnObject.buttonText = 'Invalid Format';
        returnObject.description = 'Should be username:password';
        return returnObject;
      }
      returnObject.className = 'btn btn-success';
      returnObject.buttonText = 'Set';
      returnObject.description = 'Callback auth is configured';
      return returnObject;
    })();
    // Service Account - checks if the user exists, has admin role, and credentials work
    var serviceAccount = (function () {
      var returnObject = {
        "className": "btn btn-warning",
        "label": "Service Account",
        "buttonText": "Not Configured",
        "url": "https://getaiinabox.com/docs/tools-acl",
        "description": "User account for tool execution"
      };
      var authValue = gs.getProperty('ai_in_a_box.config.server.callback.auth');
      if (!authValue || authValue == '') {
        returnObject.className = 'btn btn-secondary';
        returnObject.buttonText = 'N/A';
        returnObject.description = 'Set callback auth first';
        return returnObject;
      }
      var parts = authValue.split(':');
      if (parts.length < 2) {
        returnObject.className = 'btn btn-secondary';
        returnObject.buttonText = 'N/A';
        return returnObject;
      }
      var username = parts[0];
      var userRecord = new GlideRecord('sys_user');
      userRecord.addQuery('user_name', username);
      userRecord.addQuery('active', true);
      userRecord.setLimit(1);
      userRecord.query();
      if (!userRecord.next()) {
        returnObject.className = 'btn btn-danger';
        returnObject.buttonText = 'Not Found';
        returnObject.description = 'User "' + username + '" not found or inactive';
        returnObject.url = '/sys_user_list.do?sysparm_query=user_name=' + username;
        return returnObject;
      }
      returnObject.url = '/sys_user.do?sys_id=' + userRecord.sys_id;
      // Check if user has admin role (required for GlideImpersonate)
      var hasAdminRole = new GlideRecord('sys_user_has_role');
      hasAdminRole.addQuery('user', userRecord.sys_id);
      hasAdminRole.addQuery('role.name', 'admin');
      hasAdminRole.setLimit(1);
      hasAdminRole.query();
      if (!hasAdminRole.hasNext()) {
        returnObject.className = 'btn btn-danger';
        returnObject.buttonText = 'No Admin Role';
        returnObject.description = 'User "' + username + '" needs admin role';
        return returnObject;
      }
      // Test that credentials actually work by making a REST call
      try {
        var instanceUrl = gs.getProperty('glide.servlet.uri', '');
        if (!instanceUrl) {
          instanceUrl = 'https://' + gs.getProperty('instance_name') + '.service-now.com/';
        }
        var testEndpoint = instanceUrl + 'api/now/table/sys_user?sysparm_query=user_name=' + username + '&sysparm_limit=1&sysparm_fields=user_name';
        var restMessage = new sn_ws.RESTMessageV2();
        restMessage.setHttpMethod('GET');
        restMessage.setEndpoint(testEndpoint);
        restMessage.setRequestHeader('Accept', 'application/json');
        restMessage.setRequestHeader('Authorization', 'Basic ' + GlideStringUtil.base64Encode(authValue));
        var response = restMessage.execute();
        var statusCode = response.getStatusCode();
        if (statusCode == 401 || statusCode == 403) {
          returnObject.className = 'btn btn-danger';
          returnObject.buttonText = 'Auth Failed';
          returnObject.description = 'Invalid password for "' + username + '"';
          return returnObject;
        }
        if (statusCode != 200) {
          returnObject.className = 'btn btn-warning';
          returnObject.buttonText = 'Test Error';
          returnObject.description = 'Could not verify (HTTP ' + statusCode + ')';
          return returnObject;
        }
      } catch (e) {
        returnObject.className = 'btn btn-warning';
        returnObject.buttonText = 'Test Error';
        returnObject.description = 'Error: ' + e.message;
        return returnObject;
      }
      returnObject.className = 'btn btn-success';
      returnObject.buttonText = username;
      returnObject.description = 'Verified with admin role';
      return returnObject;
    })();
    // Helper Script - checks if AIABGlobalHelper script include exists in global scope
    var helperScript = (function () {
      var returnObject = {
        "className": "btn btn-warning",
        "label": "Helper Script",
        "buttonText": "Not Found",
        "url": "https://getaiinabox.com/docs/tools-acl",
        "description": "Global script include for tool execution"
      };
      var scriptInclude = new GlideRecord('sys_script_include');
      scriptInclude.addQuery('name', 'AIABGlobalHelper');
      scriptInclude.addQuery('sys_scope', 'global');
      scriptInclude.addQuery('active', true);
      scriptInclude.setLimit(1);
      scriptInclude.query();
      if (scriptInclude.next()) {
        returnObject.className = 'btn btn-success';
        returnObject.buttonText = 'Installed';
        returnObject.description = 'AIABGlobalHelper is active';
        returnObject.url = '/sys_script_include.do?sys_id=' + scriptInclude.sys_id;
      } else {
        // Check if it exists but is inactive
        var inactiveCheck = new GlideRecord('sys_script_include');
        inactiveCheck.addQuery('name', 'AIABGlobalHelper');
        inactiveCheck.addQuery('sys_scope', 'global');
        inactiveCheck.setLimit(1);
        inactiveCheck.query();
        if (inactiveCheck.next()) {
          returnObject.className = 'btn btn-warning';
          returnObject.buttonText = 'Inactive';
          returnObject.description = 'Script exists but is not active';
          returnObject.url = '/sys_script_include.do?sys_id=' + inactiveCheck.sys_id;
        } else {
          returnObject.className = 'btn btn-secondary';
          returnObject.buttonText = 'Not Installed';
          returnObject.description = 'AIABGlobalHelper not found';
        }
      }
      return returnObject;
    })();
    var midserver = (function () {
	  var enabled = gs.getProperty('ai_in_a_box.config.midserver.enabled', 'true');
	  var returnObject = {
        "className": "btn btn-danger",
        "label": "Mid Server",
        "buttonText": "Down",
        "url": "/sys_properties_list.do?sysparm_query=name=ai_in_a_box.config.midserver"
      };
	  if(enabled == 'false') {
		returnObject.buttonText = "Not Used";
		returnObject.className = "btn btn-secondary";
		return returnObject;
	  }
      var property = 'ai_in_a_box.config.midserver';
      var value = gs.getProperty(property);
      if (value == null) {
        returnObject.buttonText = "Not Set";
        return returnObject;
      }
      var eccAgent = new GlideRecord('ecc_agent');
      eccAgent.setLimit(1);
      eccAgent.addQuery('name', value);
      eccAgent.query();
      if (eccAgent.hasNext() == false) {
        returnObject.buttonText = "Missing";
        return returnObject;
      }
      if (eccAgent.next()) {
        if (eccAgent.status != 'Up') {
          returnObject.buttonText = "Down";
          return returnObject;
        }
        if (eccAgent.validated != 'true') {
          returnObject.buttonText = "Not Validated";
          returnObject.className = "btn btn-warning";
          returnObject.url = "/ecc_agent_list.do?sysparm_query=" + eccAgent.getEncodedQuery();
          return returnObject;
        }
        // if... issues
        var eccAgentIssues = new GlideRecord('ecc_agent_issue');
        eccAgentIssues.addQuery('mid_server.name', value);
        eccAgentIssues.addQuery('state', '=', 'new');
        eccAgentIssues.query();
        if (eccAgentIssues.next()) {
          returnObject.className = "btn btn-warning";
          returnObject.buttonText = 'Address Issues';
          returnObject.url = "/ecc_agent_list.do?sysparm_query=" + eccAgent.getEncodedQuery();
          return returnObject;
        }
        returnObject.className = "btn btn-success";
        returnObject.buttonText = '✅Up';
        return returnObject;
      }
    })();
    // aiiab url / auth [ai_in_a_box.config.server.aiiab.url / ai_in_a_box.config.server.aiiab.auth]
    var aiiabServer = (function () {
      var property = 'ai_in_a_box.config.server.aiab.url';
      var returnObject = {
        "className": "btn btn-danger",
        "label": "AI In A Box",
        "buttonText": "Down",
        "url": "/sys_properties_list.do?sysparm_query=name=" + property
      };
      var value = gs.getProperty(property);
      if (value == null || value == "") {
        returnObject.buttonText = "URL Not Set";
        return returnObject;
      }
      var authProperty = 'ai_in_a_box.config.server.aiiab.auth';
      var authValue = gs.getProperty(authProperty);
      var url = value + "/meta/status";
      // we need to ensure the mid is up to do this
      var midEnabled = gs.getProperty('ai_in_a_box.config.midserver.enabled', 'true');
      if (midEnabled == 'true') {
        var eccAgent = new GlideRecord('ecc_agent');
        eccAgent.setLimit(1);
        eccAgent.addQuery('name', gs.getProperty('ai_in_a_box.config.midserver'));
        eccAgent.addQuery('status', 'Up');
        eccAgent.addQuery('validated', 'true');
        eccAgent.query();
        if (eccAgent.hasNext() == false) {
          returnObject.buttonText = "Mid Server Down";
          returnObject.url = "/ecc_agent_list.do?sysparm_query=name=" + gs.getProperty('ai_in_a_box.config.midserver');
          return returnObject;
        }
      }
      var restMessage = new sn_ws.RESTMessageV2();
      restMessage.setHttpMethod('get');
      restMessage.setEndpoint(url);
      if (midEnabled == 'true') {
        restMessage.setMIDServer(gs.getProperty('ai_in_a_box.config.midserver'));
      }
      restMessage.setRequestHeader('Content-Type', 'application/json');
      restMessage.setRequestHeader('Authorization', 'Basic ' + GlideStringUtil.base64Encode(authValue));
      var response = restMessage.execute();
      if (response.getStatusCode() == 401) {
        returnObject.buttonText = 'Invalid Auth';
        return returnObject;
      }
      if (response.getStatusCode() != 200) {
        returnObject.buttonText = 'Down';
        return returnObject;
      }
      returnObject.buttonText = '✅Up';
      returnObject.className = 'btn btn-success';
      return returnObject;
    })();
    var llmServer = (function () {
      var property = 'ai_in_a_box.config.server.llm.url';
      var returnObject = {
        "className": "btn btn-danger",
        "label": "LLM Server",
        "buttonText": "Down",
        "url": "/sys_properties_list.do?sysparm_query=name=" + property
      };
      var value = gs.getProperty(property);
      var urlRegex = new RegExp('^(http|https)://.*$');
      if (!urlRegex.test(value) || value == null) {
        returnObject.buttonText = 'Invalid URL';
        return returnObject;
      }
      var authProperty = 'ai_in_a_box.config.server.llm.auth';
      var authValue = gs.getProperty(authProperty);
      if (authValue == null || authValue == "") {
        returnObject.buttonText = 'Auth not set';
        returnObject.url = "/sys_properties_list.do?sysparm_query=name=" + authProperty;
        return returnObject;
      }
      var midEnabled = gs.getProperty('ai_in_a_box.config.midserver.enabled', 'true');
      if (midEnabled == 'true') {
        var eccAgent = new GlideRecord('ecc_agent');
        eccAgent.setLimit(1);
        eccAgent.addQuery('name', gs.getProperty('ai_in_a_box.config.midserver'));
        eccAgent.addQuery('status', 'Up');
        eccAgent.addQuery('validated', 'true');
        eccAgent.query();
        if (eccAgent.hasNext() == false) {
          returnObject.buttonText = "Mid Server Down";
          returnObject.url = "/ecc_agent_list.do?sysparm_query=name=" + gs.getProperty('ai_in_a_box.config.midserver');
          return returnObject;
        }
      }
      var restMessage = new sn_ws.RESTMessageV2();
      returnObject.gottorest = true;
      restMessage.setHttpMethod('get');
      restMessage.setEndpoint(value + '/models');
      if (midEnabled == 'true') {
        restMessage.setMIDServer(gs.getProperty('ai_in_a_box.config.midserver'));
      }
      restMessage.setRequestHeader('Content-Type', 'application/json');
      restMessage.setRequestHeader('Authorization', 'Bearer ' + authValue);
      var response = restMessage.execute();
      var responseBody = response.getBody();
      if (response.getStatusCode() == 401) {
        returnObject.buttonText = 'Invalid Auth';
        return returnObject;
      }
      if (response.getStatusCode() != 200) {
        returnObject.buttonText = 'Down';
        return returnObject;
      }

      var responseJSON = JSON.parse(responseBody);
      var isLlamaCpp = false;
      var models = [];
      if (responseJSON.data) {
        for (var i = 0; i < responseJSON.data.length; i++) {
          models.push(responseJSON.data[i].id);
          if (responseJSON.data[i].owned_by == 'llamacpp') {
            isLlamaCpp = true;
          }
        }
      }
      if (isLlamaCpp == false) {
        var modelProperty = 'ai_in_a_box.config.server.llm.model';
        var modelValue = gs.getProperty(modelProperty);
        if (models.indexOf(modelValue) == -1) {
          returnObject.className = 'btn btn-warning';
          returnObject.buttonText = 'Model(' + modelValue + ') not found.  Models: ' + models.join(', ');
          returnObject.url = "/sys_properties_list.do?sysparm_query=name=" + modelProperty;
          return returnObject;
        }
      }

      returnObject.buttonText = '✅Up';
      returnObject.className = 'btn btn-success';
      return returnObject;
    })();
    var meet = {
      "label": "Let's Meet",
      "buttonText": "Schedule it",
      "url": "https://meetings.hubspot.com/jace-benson",
      "className": "btn btn-primary"
    };
    var docs = {
      "label": "Docs",
      "buttonText": "Help yourself",
      "url": "https://getaiinabox.com/docs",
      "className": "btn btn-success"
    };
    var email = {
      "label": "Email",
      "buttonText": "Email Us",
      "url": "mailto:team@getaiinabox.com",
      "className": "btn btn-outline-primary"
    };
    return {
      summarize: summarize,
      chat: chat,
      callbackAuth: callbackAuth,
      serviceAccount: serviceAccount,
      helperScript: helperScript,
      midserver: midserver,
      aiiabServer: aiiabServer,
      llmServer: llmServer,
      meet: meet,
      docs: docs,
      email: email,
      up: midserver.buttonText == '✅Up' && aiiabServer.buttonText == '✅Up' && llmServer.buttonText == '✅Up'
    };

  },
  statusMidServer: function () {

    var midservername = gs.getProperty('ai_in_a_box.config.midserver', 'aiinabox-mid');
    var enabled = gs.getProperty('ai_in_a_box.config.midserver.enabled', 'true');
    if(enabled != 'true'){
      return {
        status: "disabled",
        message: "Mid Server is disabled"
      };
    }
    var eccAgent = new GlideRecord('ecc_agent');
    eccAgent.addQuery('name', midservername);
    eccAgent.query();
    if (eccAgent.next()) {
      if (eccAgent.status != 'Up') {
        return {
          status: "down",
          message: "Mid Server is down"
        };
      }
      if (eccAgent.validated != 'true') {
        return {
          status: "not_validated",
          message: "Mid Server is not validated"
        };
      }
      var eccAgentIssues = new GlideRecord('ecc_agent_issue');
      eccAgentIssues.addQuery('mid_server.name', 'aiinabox-mid');
      eccAgentIssues.addQuery('state', '=', 'new');
      eccAgentIssues.query();
      if (eccAgentIssues.next()) {
        return {
          status: "issues",
          message: "Mid Server has issues"
        };
      }
      return {
        status: "up",
        message: "Mid Server is up"
      };
    } else {
      return {
        status: "down",
        message: "Mid Server is down"
      };
    }
  },
  statusAIABServer: function () {
    var aiabStatusServer = gs.getProperty('ai_in_a_box.config.server.aiab.url', 'http://localhost:5000');
    var response = new global.aiabRest().send({
      host: aiabStatusServer,
      path: '/meta/status',
    });
    var statusCode = JSON.parse(response.body).status;

    if (statusCode === "ok") {
      return {
        status: "up",
        message: "AIAB Server is up"
      };
    } else {
      return {
        status: "down",
        message: "AIAB Server is down"
      };
    }
  },
  type: 'aiabStatus'
};





]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>aiinaboxadmin</sys_created_by>
        <sys_created_on>2024-12-23 20:42:04</sys_created_on>
        <sys_id>7e581613c3ea9a50594e12f1b401310a</sys_id>
        <sys_mod_count>144</sys_mod_count>
        <sys_name>aiabStatus</sys_name>
        <sys_package display_value="AI in a Box" source="0439d1f593948210071230a97bba1016">0439d1f593948210071230a97bba1016</sys_package>
        <sys_policy/>
        <sys_scope display_value="AI in a Box">0439d1f593948210071230a97bba1016</sys_scope>
        <sys_update_name>sys_script_include_7e581613c3ea9a50594e12f1b401310a</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-02-14 06:46:38</sys_updated_on>
    </sys_script_include>
    <sys_es_latest_script action="DELETE">
        <id>7e581613c3ea9a50594e12f1b401310a</id>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-01-23 00:56:51</sys_created_on>
        <sys_id>2472394d83d792107f36c5b5eeaad3b1</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-01-23 00:56:51</sys_updated_on>
        <table>sys_script_include</table>
        <use_es_latest>false</use_es_latest>
    </sys_es_latest_script>
    <sys_update_version action="INSERT_OR_UPDATE">
        <action>DELETE</action>
        <application display_value="AI in a Box">0439d1f593948210071230a97bba1016</application>
        <file_path/>
        <instance_id>3e01943a1b79f9901024eb9b2d4bcb05</instance_id>
        <instance_name>dev184755</instance_name>
        <name>sys_script_include_7e581613c3ea9a50594e12f1b401310a</name>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_include"&gt;&lt;sys_script_include action="INSERT_OR_UPDATE"&gt;&lt;access&gt;public&lt;/access&gt;&lt;active&gt;false&lt;/active&gt;&lt;api_name&gt;global.aiabStatus&lt;/api_name&gt;&lt;caller_access/&gt;&lt;client_callable&gt;false&lt;/client_callable&gt;&lt;description/&gt;&lt;mobile_callable&gt;false&lt;/mobile_callable&gt;&lt;name&gt;aiabStatus&lt;/name&gt;&lt;sandbox_callable&gt;false&lt;/sandbox_callable&gt;&lt;script&gt;&lt;![CDATA[//current aiiab
/* global Class,gs,GlideRecord, sn_ws */
/*eslint semi: "error"*/
var aiabStatus = Class.create();
aiabStatus.prototype = {
  initialize: function () { },
  canSummarize: function (table) {
    var enabled = gs.getProperty('ai_in_a_box.feature.summarize.enabled') == "true";
    if (enabled === false) return false;
    var userHasRole = gs.hasRole(gs.getProperty('ai_in_a_box.feature.summarize.roles'.split(',')));
    if (userHasRole === false) return false;
    return true;
  },
  featuresAndProperties: [
    {
      enabled: gs.getProperty('ai_in_a_box.config.midserver.enabled') == "true",
      properties: [
        'ai_in_a_box.config.midserver.enabled',
        'ai_in_a_box.config.midserver'
      ],
      label: "Midserver"
    },
    {
      enabled: gs.getProperty('ai_in_a_box.feature.summarize.enabled') == "true",
      roles: gs.getProperty('ai_in_a_box.feature.summarize.roles').split(','),
      properties: [
        'ai_in_a_box.feature.summarize.enabled',
        'ai_in_a_box.feature.summarize.roles',
      ],
      label: "Summarize"
    },
  {
    enabled: gs.getProperty('ai_in_a_box.feature.chat.enabled') == "true",
    roles: gs.getProperty('ai_in_a_box.feature.chat.roles').split(','),
    properties: [
      'ai_in_a_box.feature.chat.enabled',
      'ai_in_a_box.feature.chat.roles',
    ],
    label: "Chat"
  }
  ],
  status: function () {
    var summarize = (function () {
      var property = 'ai_in_a_box.feature.summarize.enabled';
      var returnObject = {
        "className": "btn btn-danger",
        "label": "Summarize",
        "buttonText": "Disabled",
        "url": "/sys_properties_list.do?sysparm_query=name=" + property
      };
      var value = gs.getProperty(property);
      if (value == null) {
        returnObject.buttonText = "Not Set";
        return returnObject;
      }
      if (value == "false") {
        returnObject.buttonText = "Disabled";
        returnObject.className = "btn btn-warning";
        return returnObject;
      }
      returnObject.className = "btn btn-success";
      returnObject.buttonText = '✅Done';
      return returnObject;
    })();
    var chat = (function () {
      var property = 'ai_in_a_box.feature.chat.enabled';
      var returnObject = {
        "className": "btn btn-danger",
        "label": "Chat",
        "buttonText": "Disabled",
        "url": "/sys_properties_list.do?sysparm_query=name=" + property
      };
      var value = gs.getProperty(property);
      if (value == null) {
        returnObject.buttonText = "Not Set";
        return returnObject;
      }
      if (value == "false") {
        returnObject.buttonText = "Disabled";
        returnObject.className = "btn btn-warning";
        return returnObject;
      }
      returnObject.className = "btn btn-success";
      returnObject.buttonText = '✅Done';
      return returnObject;
    })();
    // Tools ACL - checks if impersonation is configured for ACL-aware tool execution
    // Global Helper - checks if AIABGlobalHelper script include exists in global scope
    // Callback Auth - checks if the callback auth property is set
    var callbackAuth = (function () {
      var returnObject = {
        "className": "btn btn-warning",
        "label": "Callback Auth",
        "buttonText": "Not Set",
        "url": "/sys_properties_list.do?sysparm_query=name=ai_in_a_box.config.server.callback.auth",
        "description": "Authentication for AI server callbacks"
      };
      var authValue = gs.getProperty('ai_in_a_box.config.server.callback.auth');
      if (!authValue || authValue == '') {
        returnObject.className = 'btn btn-secondary';
        returnObject.buttonText = 'Not Set';
        return returnObject;
      }
      var parts = authValue.split(':');
      if (parts.length &lt; 2) {
        returnObject.className = 'btn btn-danger';
        returnObject.buttonText = 'Invalid Format';
        returnObject.description = 'Should be username:password';
        return returnObject;
      }
      returnObject.className = 'btn btn-success';
      returnObject.buttonText = 'Set';
      returnObject.description = 'Callback auth is configured';
      return returnObject;
    })();
    // Service Account - checks if the user exists, has admin role, and credentials work
    var serviceAccount = (function () {
      var returnObject = {
        "className": "btn btn-warning",
        "label": "Service Account",
        "buttonText": "Not Configured",
        "url": "https://getaiinabox.com/docs/tools-acl",
        "description": "User account for tool execution"
      };
      var authValue = gs.getProperty('ai_in_a_box.config.server.callback.auth');
      if (!authValue || authValue == '') {
        returnObject.className = 'btn btn-secondary';
        returnObject.buttonText = 'N/A';
        returnObject.description = 'Set callback auth first';
        return returnObject;
      }
      var parts = authValue.split(':');
      if (parts.length &lt; 2) {
        returnObject.className = 'btn btn-secondary';
        returnObject.buttonText = 'N/A';
        return returnObject;
      }
      var username = parts[0];
      var userRecord = new GlideRecord('sys_user');
      userRecord.addQuery('user_name', username);
      userRecord.addQuery('active', true);
      userRecord.setLimit(1);
      userRecord.query();
      if (!userRecord.next()) {
        returnObject.className = 'btn btn-danger';
        returnObject.buttonText = 'Not Found';
        returnObject.description = 'User "' + username + '" not found or inactive';
        returnObject.url = '/sys_user_list.do?sysparm_query=user_name=' + username;
        return returnObject;
      }
      returnObject.url = '/sys_user.do?sys_id=' + userRecord.sys_id;
      // Check if user has admin role (required for GlideImpersonate)
      var hasAdminRole = new GlideRecord('sys_user_has_role');
      hasAdminRole.addQuery('user', userRecord.sys_id);
      hasAdminRole.addQuery('role.name', 'admin');
      hasAdminRole.setLimit(1);
      hasAdminRole.query();
      if (!hasAdminRole.hasNext()) {
        returnObject.className = 'btn btn-danger';
        returnObject.buttonText = 'No Admin Role';
        returnObject.description = 'User "' + username + '" needs admin role';
        return returnObject;
      }
      // Test that credentials actually work by making a REST call
      try {
        var instanceUrl = gs.getProperty('glide.servlet.uri', '');
        if (!instanceUrl) {
          instanceUrl = 'https://' + gs.getProperty('instance_name') + '.service-now.com/';
        }
        var testEndpoint = instanceUrl + 'api/now/table/sys_user?sysparm_query=user_name=' + username + '&amp;sysparm_limit=1&amp;sysparm_fields=user_name';
        var restMessage = new sn_ws.RESTMessageV2();
        restMessage.setHttpMethod('GET');
        restMessage.setEndpoint(testEndpoint);
        restMessage.setRequestHeader('Accept', 'application/json');
        restMessage.setRequestHeader('Authorization', 'Basic ' + GlideStringUtil.base64Encode(authValue));
        var response = restMessage.execute();
        var statusCode = response.getStatusCode();
        if (statusCode == 401 || statusCode == 403) {
          returnObject.className = 'btn btn-danger';
          returnObject.buttonText = 'Auth Failed';
          returnObject.description = 'Invalid password for "' + username + '"';
          return returnObject;
        }
        if (statusCode != 200) {
          returnObject.className = 'btn btn-warning';
          returnObject.buttonText = 'Test Error';
          returnObject.description = 'Could not verify (HTTP ' + statusCode + ')';
          return returnObject;
        }
      } catch (e) {
        returnObject.className = 'btn btn-warning';
        returnObject.buttonText = 'Test Error';
        returnObject.description = 'Error: ' + e.message;
        return returnObject;
      }
      returnObject.className = 'btn btn-success';
      returnObject.buttonText = username;
      returnObject.description = 'Verified with admin role';
      return returnObject;
    })();
    // Helper Script - checks if AIABGlobalHelper script include exists in global scope
    var helperScript = (function () {
      var returnObject = {
        "className": "btn btn-warning",
        "label": "Helper Script",
        "buttonText": "Not Found",
        "url": "https://getaiinabox.com/docs/tools-acl",
        "description": "Global script include for tool execution"
      };
      var scriptInclude = new GlideRecord('sys_script_include');
      scriptInclude.addQuery('name', 'AIABGlobalHelper');
      scriptInclude.addQuery('sys_scope', 'global');
      scriptInclude.addQuery('active', true);
      scriptInclude.setLimit(1);
      scriptInclude.query();
      if (scriptInclude.next()) {
        returnObject.className = 'btn btn-success';
        returnObject.buttonText = 'Installed';
        returnObject.description = 'AIABGlobalHelper is active';
        returnObject.url = '/sys_script_include.do?sys_id=' + scriptInclude.sys_id;
      } else {
        // Check if it exists but is inactive
        var inactiveCheck = new GlideRecord('sys_script_include');
        inactiveCheck.addQuery('name', 'AIABGlobalHelper');
        inactiveCheck.addQuery('sys_scope', 'global');
        inactiveCheck.setLimit(1);
        inactiveCheck.query();
        if (inactiveCheck.next()) {
          returnObject.className = 'btn btn-warning';
          returnObject.buttonText = 'Inactive';
          returnObject.description = 'Script exists but is not active';
          returnObject.url = '/sys_script_include.do?sys_id=' + inactiveCheck.sys_id;
        } else {
          returnObject.className = 'btn btn-secondary';
          returnObject.buttonText = 'Not Installed';
          returnObject.description = 'AIABGlobalHelper not found';
        }
      }
      return returnObject;
    })();
    var midserver = (function () {
	  var enabled = gs.getProperty('ai_in_a_box.config.midserver.enabled', 'true');
	  var returnObject = {
        "className": "btn btn-danger",
        "label": "Mid Server",
        "buttonText": "Down",
        "url": "/sys_properties_list.do?sysparm_query=name=ai_in_a_box.config.midserver"
      };
	  if(enabled == 'false') {
		returnObject.buttonText = "Not Used";
		returnObject.className = "btn btn-secondary";
		return returnObject;
	  }
      var property = 'ai_in_a_box.config.midserver';
      var value = gs.getProperty(property);
      if (value == null) {
        returnObject.buttonText = "Not Set";
        return returnObject;
      }
      var eccAgent = new GlideRecord('ecc_agent');
      eccAgent.setLimit(1);
      eccAgent.addQuery('name', value);
      eccAgent.query();
      if (eccAgent.hasNext() == false) {
        returnObject.buttonText = "Missing";
        return returnObject;
      }
      if (eccAgent.next()) {
        if (eccAgent.status != 'Up') {
          returnObject.buttonText = "Down";
          return returnObject;
        }
        if (eccAgent.validated != 'true') {
          returnObject.buttonText = "Not Validated";
          returnObject.className = "btn btn-warning";
          returnObject.url = "/ecc_agent_list.do?sysparm_query=" + eccAgent.getEncodedQuery();
          return returnObject;
        }
        // if... issues
        var eccAgentIssues = new GlideRecord('ecc_agent_issue');
        eccAgentIssues.addQuery('mid_server.name', value);
        eccAgentIssues.addQuery('state', '=', 'new');
        eccAgentIssues.query();
        if (eccAgentIssues.next()) {
          returnObject.className = "btn btn-warning";
          returnObject.buttonText = 'Address Issues';
          returnObject.url = "/ecc_agent_list.do?sysparm_query=" + eccAgent.getEncodedQuery();
          return returnObject;
        }
        returnObject.className = "btn btn-success";
        returnObject.buttonText = '✅Up';
        return returnObject;
      }
    })();
    // aiiab url / auth [ai_in_a_box.config.server.aiiab.url / ai_in_a_box.config.server.aiiab.auth]
    var aiiabServer = (function () {
      var property = 'ai_in_a_box.config.server.aiab.url';
      var returnObject = {
        "className": "btn btn-danger",
        "label": "AI In A Box",
        "buttonText": "Down",
        "url": "/sys_properties_list.do?sysparm_query=name=" + property
      };
      var value = gs.getProperty(property);
      if (value == null || value == "") {
        returnObject.buttonText = "URL Not Set";
        return returnObject;
      }
      var authProperty = 'ai_in_a_box.config.server.aiiab.auth';
      var authValue = gs.getProperty(authProperty);
      var url = value + "/meta/status";
      // we need to ensure the mid is up to do this
      var midEnabled = gs.getProperty('ai_in_a_box.config.midserver.enabled', 'true');
      if (midEnabled == 'true') {
        var eccAgent = new GlideRecord('ecc_agent');
        eccAgent.setLimit(1);
        eccAgent.addQuery('name', gs.getProperty('ai_in_a_box.config.midserver'));
        eccAgent.addQuery('status', 'Up');
        eccAgent.addQuery('validated', 'true');
        eccAgent.query();
        if (eccAgent.hasNext() == false) {
          returnObject.buttonText = "Mid Server Down";
          returnObject.url = "/ecc_agent_list.do?sysparm_query=name=" + gs.getProperty('ai_in_a_box.config.midserver');
          return returnObject;
        }
      }
      var restMessage = new sn_ws.RESTMessageV2();
      restMessage.setHttpMethod('get');
      restMessage.setEndpoint(url);
      if (midEnabled == 'true') {
        restMessage.setMIDServer(gs.getProperty('ai_in_a_box.config.midserver'));
      }
      restMessage.setRequestHeader('Content-Type', 'application/json');
      restMessage.setRequestHeader('Authorization', 'Basic ' + GlideStringUtil.base64Encode(authValue));
      var response = restMessage.execute();
      if (response.getStatusCode() == 401) {
        returnObject.buttonText = 'Invalid Auth';
        return returnObject;
      }
      if (response.getStatusCode() != 200) {
        returnObject.buttonText = 'Down';
        return returnObject;
      }
      returnObject.buttonText = '✅Up';
      returnObject.className = 'btn btn-success';
      return returnObject;
    })();
    var llmServer = (function () {
      var property = 'ai_in_a_box.config.server.llm.url';
      var returnObject = {
        "className": "btn btn-danger",
        "label": "LLM Server",
        "buttonText": "Down",
        "url": "/sys_properties_list.do?sysparm_query=name=" + property
      };
      var value = gs.getProperty(property);
      var urlRegex = new RegExp('^(http|https)://.*$');
      if (!urlRegex.test(value) || value == null) {
        returnObject.buttonText = 'Invalid URL';
        return returnObject;
      }
      var authProperty = 'ai_in_a_box.config.server.llm.auth';
      var authValue = gs.getProperty(authProperty);
      if (authValue == null || authValue == "") {
        returnObject.buttonText = 'Auth not set';
        returnObject.url = "/sys_properties_list.do?sysparm_query=name=" + authProperty;
        return returnObject;
      }
      var midEnabled = gs.getProperty('ai_in_a_box.config.midserver.enabled', 'true');
      if (midEnabled == 'true') {
        var eccAgent = new GlideRecord('ecc_agent');
        eccAgent.setLimit(1);
        eccAgent.addQuery('name', gs.getProperty('ai_in_a_box.config.midserver'));
        eccAgent.addQuery('status', 'Up');
        eccAgent.addQuery('validated', 'true');
        eccAgent.query();
        if (eccAgent.hasNext() == false) {
          returnObject.buttonText = "Mid Server Down";
          returnObject.url = "/ecc_agent_list.do?sysparm_query=name=" + gs.getProperty('ai_in_a_box.config.midserver');
          return returnObject;
        }
      }
      var restMessage = new sn_ws.RESTMessageV2();
      returnObject.gottorest = true;
      restMessage.setHttpMethod('get');
      restMessage.setEndpoint(value + '/models');
      if (midEnabled == 'true') {
        restMessage.setMIDServer(gs.getProperty('ai_in_a_box.config.midserver'));
      }
      restMessage.setRequestHeader('Content-Type', 'application/json');
      restMessage.setRequestHeader('Authorization', 'Bearer ' + authValue);
      var response = restMessage.execute();
      var responseBody = response.getBody();
      if (response.getStatusCode() == 401) {
        returnObject.buttonText = 'Invalid Auth';
        return returnObject;
      }
      if (response.getStatusCode() != 200) {
        returnObject.buttonText = 'Down';
        return returnObject;
      }

      var responseJSON = JSON.parse(responseBody);
      var isLlamaCpp = false;
      var models = [];
      if (responseJSON.data) {
        for (var i = 0; i &lt; responseJSON.data.length; i++) {
          models.push(responseJSON.data[i].id);
          if (responseJSON.data[i].owned_by == 'llamacpp') {
            isLlamaCpp = true;
          }
        }
      }
      if (isLlamaCpp == false) {
        var modelProperty = 'ai_in_a_box.config.server.llm.model';
        var modelValue = gs.getProperty(modelProperty);
        if (models.indexOf(modelValue) == -1) {
          returnObject.className = 'btn btn-warning';
          returnObject.buttonText = 'Model(' + modelValue + ') not found.  Models: ' + models.join(', ');
          returnObject.url = "/sys_properties_list.do?sysparm_query=name=" + modelProperty;
          return returnObject;
        }
      }

      returnObject.buttonText = '✅Up';
      returnObject.className = 'btn btn-success';
      return returnObject;
    })();
    var meet = {
      "label": "Let's Meet",
      "buttonText": "Schedule it",
      "url": "https://meetings.hubspot.com/jace-benson",
      "className": "btn btn-primary"
    };
    var docs = {
      "label": "Docs",
      "buttonText": "Help yourself",
      "url": "https://getaiinabox.com/docs",
      "className": "btn btn-success"
    };
    var email = {
      "label": "Email",
      "buttonText": "Email Us",
      "url": "mailto:team@getaiinabox.com",
      "className": "btn btn-outline-primary"
    };
    return {
      summarize: summarize,
      chat: chat,
      callbackAuth: callbackAuth,
      serviceAccount: serviceAccount,
      helperScript: helperScript,
      midserver: midserver,
      aiiabServer: aiiabServer,
      llmServer: llmServer,
      meet: meet,
      docs: docs,
      email: email,
      up: midserver.buttonText == '✅Up' &amp;&amp; aiiabServer.buttonText == '✅Up' &amp;&amp; llmServer.buttonText == '✅Up'
    };

  },
  statusMidServer: function () {

    var midservername = gs.getProperty('ai_in_a_box.config.midserver', 'aiinabox-mid');
    var enabled = gs.getProperty('ai_in_a_box.config.midserver.enabled', 'true');
    if(enabled != 'true'){
      return {
        status: "disabled",
        message: "Mid Server is disabled"
      };
    }
    var eccAgent = new GlideRecord('ecc_agent');
    eccAgent.addQuery('name', midservername);
    eccAgent.query();
    if (eccAgent.next()) {
      if (eccAgent.status != 'Up') {
        return {
          status: "down",
          message: "Mid Server is down"
        };
      }
      if (eccAgent.validated != 'true') {
        return {
          status: "not_validated",
          message: "Mid Server is not validated"
        };
      }
      var eccAgentIssues = new GlideRecord('ecc_agent_issue');
      eccAgentIssues.addQuery('mid_server.name', 'aiinabox-mid');
      eccAgentIssues.addQuery('state', '=', 'new');
      eccAgentIssues.query();
      if (eccAgentIssues.next()) {
        return {
          status: "issues",
          message: "Mid Server has issues"
        };
      }
      return {
        status: "up",
        message: "Mid Server is up"
      };
    } else {
      return {
        status: "down",
        message: "Mid Server is down"
      };
    }
  },
  statusAIABServer: function () {
    var aiabStatusServer = gs.getProperty('ai_in_a_box.config.server.aiab.url', 'http://localhost:5000');
    var response = new global.aiabRest().send({
      host: aiabStatusServer,
      path: '/meta/status',
    });
    var statusCode = JSON.parse(response.body).status;

    if (statusCode === "ok") {
      return {
        status: "up",
        message: "AIAB Server is up"
      };
    } else {
      return {
        status: "down",
        message: "AIAB Server is down"
      };
    }
  },
  type: 'aiabStatus'
};





]]&gt;&lt;/script&gt;&lt;sys_class_name&gt;sys_script_include&lt;/sys_class_name&gt;&lt;sys_created_by&gt;aiinaboxadmin&lt;/sys_created_by&gt;&lt;sys_created_on&gt;2024-12-23 20:42:04&lt;/sys_created_on&gt;&lt;sys_id&gt;7e581613c3ea9a50594e12f1b401310a&lt;/sys_id&gt;&lt;sys_mod_count&gt;144&lt;/sys_mod_count&gt;&lt;sys_name&gt;aiabStatus&lt;/sys_name&gt;&lt;sys_package display_value="AI in a Box" source="0439d1f593948210071230a97bba1016"&gt;0439d1f593948210071230a97bba1016&lt;/sys_package&gt;&lt;sys_policy/&gt;&lt;sys_scope display_value="AI in a Box"&gt;0439d1f593948210071230a97bba1016&lt;/sys_scope&gt;&lt;sys_update_name&gt;sys_script_include_7e581613c3ea9a50594e12f1b401310a&lt;/sys_update_name&gt;&lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;&lt;sys_updated_on&gt;2026-02-14 06:46:38&lt;/sys_updated_on&gt;&lt;/sys_script_include&gt;&lt;sys_es_latest_script action="INSERT_OR_UPDATE"&gt;&lt;id&gt;7e581613c3ea9a50594e12f1b401310a&lt;/id&gt;&lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;&lt;sys_created_on&gt;2025-01-23 00:56:51&lt;/sys_created_on&gt;&lt;sys_id&gt;2472394d83d792107f36c5b5eeaad3b1&lt;/sys_id&gt;&lt;sys_mod_count&gt;0&lt;/sys_mod_count&gt;&lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;&lt;sys_updated_on&gt;2025-01-23 00:56:51&lt;/sys_updated_on&gt;&lt;table&gt;sys_script_include&lt;/table&gt;&lt;use_es_latest&gt;false&lt;/use_es_latest&gt;&lt;/sys_es_latest_script&gt;&lt;/record_update&gt;</payload>
        <payload_hash>370451129</payload_hash>
        <record_name>aiabStatus</record_name>
        <reverted_from/>
        <source>fb79436b835232104d4fccb6feaad310</source>
        <source_table>sys_update_set</source_table>
        <state>previous</state>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-02-14 06:46:38</sys_created_on>
        <sys_id>a1c144f583cf36504d4fccb6feaad3cd</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_recorded_at>19c5ae6c2e00000001</sys_recorded_at>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-02-14 06:46:38</sys_updated_on>
        <type>Script Include</type>
        <update_guid>e1c144f5c1cf36503d788832505d02cc</update_guid>
        <update_guid_history>e1c144f5c1cf36503d788832505d02cc:370451129,d57dc7adcb0b3650e86580cb190d10f6:800645740,5316a7523b62b210b7bdb7965a2b1aae:1219453078,2605e3ded122b210de145c10548629d7:1680784903,c4446b5ea922b2104ca9974dcdc1d84b:-1831547472,93b3671e2622b210883eb8531ac29202:-1989762719,f3a2675a4822b210640b2cb969d52696:-1707422150,4be167d62622b21079680ab02b41f3bb:-297383696,5ce865ccaee2f21088d4abb48523db42:639908572,f7e5e1486fe2f210950259286cc7b248:-736520539,628ac32f4f5232100463808030debe3a:77360643,22c86782defba210ed725ca9cbff6cb0:-1332909445,b4986f426dfba2105073bd300c5fdb8d:243051067,3468eb42ccfba21032d70dcf1432b672:33396351,2cb7af0ecbbba2102f047ee9371a3980:672282869,008fcc289df32210786a9132f9e72fa8:2083880440,7d9d40e49af3221001b11b022734b723:2049215556,904dc4e4caf32210c59a06251f2a8a70:-1754835130,1aecc8a4d4f32210c4b174e28657b534:182794221,871c8c640bf32210a2ec917a91cde0a0:-859463990,81eb00e09bf32210169c998f63af94ee:-1881149452,965408e876b3221092b81d4a0f0b10e8:-1657515702,3e3dbb9000b32210345e6f93a8b379ca:1535312438,fdecbb9057b3221029d8585d4e1fca65:430970538,11dc7b500ab322109dbabb3da837d656:-1985847190,7a3cf75000b32210085ac136d4a61b9a:1581914425,c9fb371025b32210393c3ab256915a57:723645117,e09bff1071b32210eb257796a182b570:-289101891,cf9973d8be73221063c2eeacae238237:1466991106,d8697b1cf27322101a09e0144a2501b9:-1000035604,7ad96f54f53322104f2ab00f25708c69:1410603929,f659a3989233221037b65c700e694571:1395559468,4cc52f5406332210e9c794cd8351eea8:46779417,8f25a714f23322102e2dcce2ab01e0b6:918388887,bdf29b77492ba210dcaa3ef4ee495bb3:-1341858966,cffe4733d82ba210f4cbd2000ecd4637:-1028983029,7762f0affbe72210d61f74f56255be9e:2075686090</update_guid_history>
    </sys_update_version>
    <sys_metadata_delete action="INSERT_OR_UPDATE">
        <sys_audit_delete/>
        <sys_class_name>sys_metadata_delete</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-02-14 06:47:06</sys_created_on>
        <sys_db_object display_value="" name="sys_script_include">sys_script_include</sys_db_object>
        <sys_id>15624708499d4d0284e3be4dcf40cc99</sys_id>
        <sys_metadata>7e581613c3ea9a50594e12f1b401310a</sys_metadata>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>aiabStatus</sys_name>
        <sys_package display_value="AI in a Box" source="0439d1f593948210071230a97bba1016">0439d1f593948210071230a97bba1016</sys_package>
        <sys_parent/>
        <sys_policy/>
        <sys_scope display_value="AI in a Box">0439d1f593948210071230a97bba1016</sys_scope>
        <sys_scope_delete display_value="">c1a48f6b4a924506a5b1a6becbc665a1</sys_scope_delete>
        <sys_update_name>sys_script_include_7e581613c3ea9a50594e12f1b401310a</sys_update_name>
        <sys_update_version display_value="sys_script_include_7e581613c3ea9a50594e12f1b401310a">a1c144f583cf36504d4fccb6feaad3cd</sys_update_version>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-02-14 06:47:06</sys_updated_on>
    </sys_metadata_delete>
</record_update>
