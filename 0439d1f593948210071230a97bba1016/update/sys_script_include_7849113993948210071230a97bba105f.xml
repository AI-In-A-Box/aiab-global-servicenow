<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>public</access>
        <active>true</active>
        <api_name>global.aiabAjax</api_name>
        <caller_access>1</caller_access>
        <client_callable>true</client_callable>
        <description/>
        <mobile_callable>false</mobile_callable>
        <name>aiabAjax</name>
        <sandbox_callable>true</sandbox_callable>
        <script><![CDATA[var aiabAjax = Class.create();
aiabAjax.prototype = Object.extendsObject(AbstractAjaxProcessor, {
    cancelAIInference: function (sys_id, table, inferenceId) {
        try {
            if (!sys_id) sys_id = this.getParameter('sysparm_sys_id') || false;
            if (!table) table = this.getParameter('sysparm_table') || false;
            if (!inferenceId) inferenceId = this.getParameter('sysparm_inference_id') || false;
            var inference = new GlideRecord('u_ai_inference');
            if (inferenceId) {
                inference.addQuery('sys_id', inferenceId);
            }
            if (table && sys_id) {
                inference.addQuery('u_table', table);
                inference.addQuery('u_target', sys_id);
            }
            inference.addQuery('u_state', 'requested');
            inference.orderByDesc('sys_created_on');
            inference.query();
            if (inference.hasNext() === false) {
                return "Nothing to cancel.";
            }
            while (inference.next()) {
                inference.setValue('u_state', 'cancelled');
                inference.update();
                return "Cancelled Inference.";
            }
        } catch (error) {

        }
    },
    createAIInference: function (sys_id, table, type) {
        try {
            if (!sys_id) sys_id = this.getParameter('sysparm_sys_id') || "";
            if (!table) table = this.getParameter('sysparm_table') || "";
			if (!type) type = this.getParameter('sysparm_type') || "generic";
            var data = this.getParameter('sysparm_data') || {};
            var inference = new GlideRecord('u_ai_inference');
            inference.newRecord();
            inference.setValue('u_target', sys_id);
            inference.setValue('u_table', table);
            inference.setValue('u_metadata', data);
			inference.setValue('u_type', type);
            return inference.insert();
        } catch (error) {
            return error;
        }
    },
    createAIChat: function (messages) {
        try {
            // Support both sysparm_messages (legacy) and sysparm_conversation (new)
            if (!messages) messages = this.getParameter('sysparm_messages') || this.getParameter('sysparm_conversation') || false;
            if (messages == false) {
                return JSON.stringify({ error: "missing messages" })
            }
            
            // Get optional record context
            var recordTable = this.getParameter('sysparm_table') || '';
            var recordSysId = this.getParameter('sysparm_record') || '';
            
            var inference = new GlideRecord('u_ai_inference');
            inference.newRecord();
			inference.setValue('u_type','chat');
            
            // Store record reference if provided
            if (recordTable && recordSysId) {
                inference.setValue('u_table', recordTable);
                inference.setValue('u_target', recordSysId);
            }
            
            // Build system context
            var systemPrompt = gs.getProperty('ai_in_a_box.feature.chat.system_prompt') || 
                "You are a helpful AI assistant. Answer questions clearly and concisely. If you don't know the answer, say so.";
            
            var context = [{
				role: "system",
				content: systemPrompt
			}];
            
            // Add user context
            var userContext = this._buildUserContext();
            if (userContext) {
                context[0].content += '\n\n--- Current User Context ---\n' + userContext;
            }
            
            // Add record context if viewing a record
            if (recordTable && recordSysId) {
                var recContext = this._buildRecordContext(recordTable, recordSysId);
                if (recContext) {
                    context[0].content += '\n\n--- Current Record Context ---\n' + recContext;
                }
            }
            
            // Parse and append conversation messages
            var parsedMessages = JSON.parse(messages);
            parsedMessages = context.concat(parsedMessages);
            inference.setValue('u_prompt', JSON.stringify(parsedMessages, null, 4));
            return inference.insert();
            
        } catch (error) {
            return '';
        }
    },
    
    getAIInference: function(inferenceId) {
        try {
            if (!inferenceId) inferenceId = this.getParameter('sysparm_sys_id') || '';
            if (!inferenceId) {
                return JSON.stringify({ error: 'missing sys_id' });
            }
            
            var gr = new GlideRecord('u_ai_inference');
            if (gr.get(inferenceId)) {
                return JSON.stringify({
                    response: gr.getValue('u_response') || '',
                    state: gr.getValue('u_state') || ''
                });
            } else {
                return JSON.stringify({ error: 'not found' });
            }
        } catch (error) {
            return JSON.stringify({ error: error.message || 'unknown error' });
        }
    },
    
    getChatHistory: function() {
        try {
            var table = this.getParameter('sysparm_table') || '';
            var record = this.getParameter('sysparm_record') || '';
            
            if (!table || !record) {
                return JSON.stringify({ chats: [] });
            }
            
            var chats = [];
            var gr = new GlideRecord('u_ai_inference');
            gr.addQuery('u_type', 'chat');
            gr.addQuery('u_table', table);
            gr.addQuery('u_target', record);
            gr.addQuery('sys_created_by', gs.getUserName());
            gr.addQuery('u_state', 'finished');
            gr.orderByDesc('sys_created_on');
            gr.setLimit(10);
            gr.query();
            
            while (gr.next()) {
                // Extract first user message as preview
                var preview = 'Chat conversation';
                try {
                    var prompt = JSON.parse(gr.getValue('u_prompt') || '[]');
                    for (var i = 0; i < prompt.length; i++) {
                        if (prompt[i].role === 'user') {
                            preview = prompt[i].content || '';
                            if (preview.length > 50) {
                                preview = preview.substring(0, 50) + '...';
                            }
                            break;
                        }
                    }
                } catch(e) {
                    // Keep default preview
                }
                
                chats.push({
                    sys_id: gr.getValue('sys_id'),
                    created: gr.getDisplayValue('sys_created_on'),
                    preview: preview
                });
            }
            
            return JSON.stringify({ chats: chats });
        } catch (error) {
            return JSON.stringify({ chats: [], error: error.message || 'unknown error' });
        }
    },
    
    loadChatConversation: function() {
        try {
            var sysId = this.getParameter('sysparm_sys_id') || '';
            
            if (!sysId) {
                return JSON.stringify({ error: 'missing sys_id' });
            }
            
            var gr = new GlideRecord('u_ai_inference');
            if (!gr.get(sysId)) {
                return JSON.stringify({ error: 'not found' });
            }
            
            // Verify ownership - only allow loading your own conversations
            if (gr.getValue('sys_created_by') !== gs.getUserName()) {
                return JSON.stringify({ error: 'access denied' });
            }
            
            var messages = [];
            try {
                var prompt = JSON.parse(gr.getValue('u_prompt') || '[]');
                for (var i = 0; i < prompt.length; i++) {
                    // Only include user and assistant messages (skip system)
                    if (prompt[i].role === 'user' || prompt[i].role === 'assistant') {
                        messages.push({
                            role: prompt[i].role,
                            content: prompt[i].content || ''
                        });
                    }
                }
            } catch(e) {
                // Return empty if parsing fails
            }
            
            // Add final response if not already in messages
            var response = gr.getValue('u_response') || '';
            if (response && messages.length > 0 && messages[messages.length - 1].role !== 'assistant') {
                messages.push({ role: 'assistant', content: response });
            }
            
            return JSON.stringify({ messages: messages });
        } catch (error) {
            return JSON.stringify({ error: error.message || 'unknown error' });
        }
    },
    
    _buildUserContext: function() {
        var user = new GlideRecord('sys_user');
        if (!user.get(gs.getUserID())) return '';
        
        var lines = [
            'Logged in user: ' + user.getDisplayValue('name'),
            '- Email: ' + (user.getValue('email') || 'Not set'),
            '- Title: ' + (user.getValue('title') || 'Not set'),
            '- Department: ' + (user.getDisplayValue('department') || 'Not set'),
            '- Location: ' + (user.getDisplayValue('location') || 'Not set'),
            '- Manager: ' + (user.getDisplayValue('manager') || 'Not set')
        ];
        
        // Add user roles
        var roles = gs.getUser().getRoles().toString();
        if (roles) {
            lines.push('- Roles: ' + roles);
        }
        
        return lines.join('\n');
    },
    
    _buildRecordContext: function(table, sysId) {
        var gr = new GlideRecord(table);
        if (!gr.get(sysId)) return '';
        
        var userId = gs.getUserID();
        var lines = [
            'Table: ' + table,
            'Record: ' + gr.getDisplayValue()
        ];
        
        // Add number if available
        if (gr.isValidField('number')) {
            lines.push('Number: ' + gr.getValue('number'));
        }
        
        // Add short_description if available
        if (gr.isValidField('short_description')) {
            lines.push('Short description: ' + gr.getValue('short_description'));
        }
        
        // Add description if available (full details)
        if (gr.isValidField('description') && gr.getValue('description')) {
            var desc = gr.getValue('description');
            // Truncate if too long
            if (desc.length > 500) {
                desc = desc.substring(0, 500) + '...';
            }
            lines.push('Description: ' + desc);
        }
        
        // Add state if available
        if (gr.isValidField('state')) {
            lines.push('State: ' + gr.getDisplayValue('state'));
        }
        
        // Add priority if available
        if (gr.isValidField('priority')) {
            lines.push('Priority: ' + gr.getDisplayValue('priority'));
        }
        
        // Add caller/requester - check multiple common field names
        var callerFields = ['caller_id', 'requested_by', 'u_requested_by', 'contact', 'opened_by'];
        for (var c = 0; c < callerFields.length; c++) {
            var callerField = callerFields[c];
            if (gr.isValidField(callerField) && gr.getValue(callerField)) {
                var callerLabel = gr.getElement(callerField).getLabel();
                lines.push(callerLabel + ': ' + gr.getDisplayValue(callerField));
            }
        }
        
        // Add assigned_to if available
        if (gr.isValidField('assigned_to') && gr.getValue('assigned_to')) {
            lines.push('Assigned to: ' + gr.getDisplayValue('assigned_to'));
        }
        
        // Add assignment_group if available
        if (gr.isValidField('assignment_group') && gr.getValue('assignment_group')) {
            lines.push('Assignment group: ' + gr.getDisplayValue('assignment_group'));
        }
        
        // Add category/subcategory if available
        if (gr.isValidField('category') && gr.getValue('category')) {
            lines.push('Category: ' + gr.getDisplayValue('category'));
        }
        if (gr.isValidField('subcategory') && gr.getValue('subcategory')) {
            lines.push('Subcategory: ' + gr.getDisplayValue('subcategory'));
        }
        
        // Add created/updated timestamps
        if (gr.isValidField('sys_created_on')) {
            lines.push('Created: ' + gr.getDisplayValue('sys_created_on'));
        }
        if (gr.isValidField('sys_updated_on')) {
            lines.push('Last updated: ' + gr.getDisplayValue('sys_updated_on'));
        }
        
        // Determine user's relationship to the record
        var relationships = this._determineUserRelationship(gr, userId);
        if (relationships.length > 0) {
            lines.push('');
            lines.push('Your relationship to this record:');
            for (var r = 0; r < relationships.length; r++) {
                lines.push('- ' + relationships[r]);
            }
        }
        
        return lines.join('\n');
    },
    
    /**
     * Determine user's relationship to the record (for intent prediction)
     * @param {GlideRecord} gr - The record
     * @param {string} userId - Current user's sys_id
     * @returns {array} List of relationships
     */
    _determineUserRelationship: function(gr, userId) {
        var relationships = [];
        
        // Check if user is the caller/opened_by/requested_by
        var callerFields = ['caller_id', 'opened_by', 'requested_by', 'u_requested_by', 'contact'];
        for (var i = 0; i < callerFields.length; i++) {
            var field = callerFields[i];
            if (gr.isValidField(field) && gr.getValue(field) === userId) {
                relationships.push('You are the ' + gr.getElement(field).getLabel());
                break;
            }
        }
        
        // Check if user is assigned_to
        if (gr.isValidField('assigned_to') && gr.getValue('assigned_to') === userId) {
            relationships.push('You are assigned to this record');
        }
        
        // Check if user is in the assignment_group
        if (gr.isValidField('assignment_group') && gr.getValue('assignment_group')) {
            var groupId = gr.getValue('assignment_group');
            var groupMember = new GlideRecord('sys_user_grmember');
            groupMember.addQuery('group', groupId);
            groupMember.addQuery('user', userId);
            groupMember.setLimit(1);
            groupMember.query();
            if (groupMember.hasNext()) {
                relationships.push('You are a member of the assignment group');
            }
        }
        
        // Check if user is the manager of assigned_to
        if (gr.isValidField('assigned_to') && gr.getValue('assigned_to')) {
            var assignee = new GlideRecord('sys_user');
            if (assignee.get(gr.getValue('assigned_to'))) {
                if (assignee.getValue('manager') === userId) {
                    relationships.push('You are the manager of the assignee');
                }
            }
        }
        
        // If no relationship found
        if (relationships.length === 0) {
            relationships.push('You are viewing this record (no direct relationship)');
        }
        
        return relationships;
    },

	askClientScript: function (sys_id, table, prompt, script) {
		 try {
            if (!sys_id) sys_id = this.getParameter('sysparm_sys_id') || "";
            if (!table) table = this.getParameter('sysparm_table') || "";
			if (!script) script = this.getParameter('sysparm_script') || "";
			if (!prompt) prompt = this.getParameter('sysparm_prompt');
            var inference = new GlideRecord('u_ai_inference');
            inference.newRecord();
            inference.setValue('u_target', sys_id);
            inference.setValue('u_table', table);
			/**
			 * Exlain how this code works 
			 * """
			 * function onChange(...){.
			 * ..}
			 * """
			 * 			 */
			 var jsonPrompt = [
 {
  "role": "system",
  "content": "You are a helpful assistant."
 },
 {
  "role": "user",
  "content": 'I have a question about this code.\n\n"""' + script + '\n""""'
 }
]
			inference.setValue('u_prompt', JSON.stringify(jsonPrompt));
			inference.setValue('u_type', 'generic');
            return inference.insert();
        } catch (error) {
            return error;
        }

	},
    createAIInferenceAskRecord: function (sys_id, table, prompt) {
        try {
            if (!sys_id) sys_id = this.getParameter('sysparm_sys_id') || "";
            if (!table) table = this.getParameter('sysparm_table') || "";
			if (!prompt) prompt = this.getParameter('sysparm_prompt');
            var inference = new GlideRecord('u_ai_inference');
            inference.newRecord();
            inference.setValue('u_target', sys_id);
            inference.setValue('u_table', table);
			inference.setValue('u_prompt', prompt);
			inference.setValue('u_type', 'ask-record');
            return inference.insert();
        } catch (error) {
            return error;
        }
    },
    isChatEnabled: function () {
        // Check if chat feature is enabled
        var enabled = gs.getProperty('ai_in_a_box.feature.chat.enabled') == 'true';
        if (!enabled) return 'false';
        
        // Check if user has one of the required roles
        var rolesStr = gs.getProperty('ai_in_a_box.feature.chat.roles') || '';
        if (!rolesStr) return 'true'; // No roles configured = everyone can use
        
        var roles = rolesStr.split(',');
        for (var i = 0; i < roles.length; i++) {
            if (gs.hasRole(roles[i].trim())) {
                return 'true';
            }
        }
        return 'false';
    },
    getInferenceRecord: function (sys_id) {
        try {
            if (!sys_id) sys_id = this.getParameter('sysparm_sys_id') || "";
            var inferenceGR = new GlideRecord('u_ai_inference');
            inferenceGR.addQuery('u_target', sys_id);
            inferenceGR.orderByDesc('sys_created_on');
            inferenceGR.setLimit(1);
            inferenceGR.query();
            if (inferenceGR.next()) {
                return inferenceGR.getValue('u_response') || "";
            } else {
                return "No summary found";
            }
        } catch (error) {
            return error;
        }
    },
    getSummarizeTemplate: function (table, sys_id, template) {
        try {
            if (!table) table = this.getParameter('sysparm_table') || "";
            if (!sys_id) sys_id = this.getParameter('sysparm_sys_id') || "";
            if (!template) template = this.getParameter('sysparm_template');
            var task = new GlideRecord(table);
            if (task.get(sys_id)) {
                var aiSummarierGR = new GlideRecord('u_ai_summarizer');
                aiSummarierGR.addQuery('u_active', 'true');
                aiSummarierGR.addQuery('u_table', table);
                aiSummarierGR.setLimit(1);
                aiSummarierGR.query();
                if (aiSummarierGR.next()) {
                    var recordTemplate;
                    if (!template) recordTemplate = aiSummarierGR.getValue('u_record_template');
                    if (template) recordTemplate = template;
                    var recordFieldsFromTemplate = recordTemplate.match(/{{(.*?)}}/g);
                    var fields = recordFieldsFromTemplate.map(function (field) {
                        field = field.replace('{{', '').replace('}}', '');
                        return field;
                    });

                    var taskText = recordTemplate + '';
                    fields.forEach(function (field) {
                        var value = task.getDisplayValue(field) || '';
                        if (field == "__all_variables__") {
                            value += "Variables:\n";
                            for (var prop in task.variables) {
                                value += prop + ': ' + task.variables[prop] + '\n';
                            }
                        }
                        if (field.indexOf('__related__') > -1) {
                            try {
                                // what do i need to get a related list of display values
                                // i need the table, the query, and the field name
                                var clearField = field.replace('__related__', '');
                                var parts = clearField.split('__');
                                var rTable = parts[0];
                                var rQuery = parts[1];
                                var rField = parts[2].split(',');
                                (function () {
                                    var re = /\[\[(.*?)\]\]/g;
                                    var match;
                                    var result = [];
                                    while (match = re.exec(rQuery)) {
                                        result.push(match[1]);
                                    }
                                    result.forEach(function (r) {
                                        rQuery = rQuery.replace('[[' + r + ']]', task.getValue(r));
                                    });
                                })();
                                var rGR = new GlideRecord(rTable);
                                rGR.addQuery(rQuery);
                                rGR.setLimit(10);
                                //value = rTable + ':' + rField + ':' + rQuery
                                rGR.query();
                                var rValues = [];
                                while (rGR.next()) {
                                    var rFields = []
                                    rField.forEach(function (dField) {
                                        rFields.push(rGR.getElement(dField).getLabel() + ': ' + rGR.getDisplayValue(dField));
                                    });
                                    rValues.push(rFields.join('\n>'));
                                }
                                value = rValues.join('\n\n');
                            } catch (e) {
                                value = "ERROR: " + e
                            }
                        }
                        taskText = taskText.replace('{{' + field + '}}', value);
                    });
                    return taskText;
                } else {
                    return "Cannot find Summarizer Record";
                }
            } else {
                return "Cannot find Task";
            }
        } catch (error) {
            return "Error: " + error;
        }
    },

    commentToCode: function (instruction, script) {
        try {
            if (!instruction) instruction = this.getParameter('sysparm_instruction') || "";
            if (!script) script = this.getParameter('sysparm_script') || "";

            // prefix is code between script beginning, and instruction
            // suffix is code between instruction and end
            var prefix = script.split(instruction)[0] || "";
            var suffix = script.split(instruction)[1] || "";

            var baseUrl = gs.getProperty('scribe.url');
            var midserver = gs.getProperty('scribe.midserver');
            var model = gs.getProperty('scribe.model');
            var prompt = gs.getProperty('scribe.prompt.summarize');
            var tokenRestCall = new sn_ws.RESTMessageV2();
            tokenRestCall.setHttpMethod('post');
            tokenRestCall.setEndpoint(baseUrl + '/api/v1/auths/signin');
            tokenRestCall.setRequestHeader('Content-Type', 'application/json');
            var tokenBody = {
                "email": gs.getProperty('scribe.email'),
                "password": gs.getProperty('scribe.password')
            };
            tokenRestCall.setRequestBody(JSON.stringify(tokenBody));
            tokenRestCall.setMIDServer(midserver);
            var tokenResponse = tokenRestCall.execute();
            var tokenResponseBody = tokenResponse.getBody();
            var token = JSON.parse(tokenResponseBody).token || false;
            if (!token) return "Cannot Summarize, token not valid";
            var generateRestCall = new sn_ws.RESTMessageV2();
            generateRestCall.setHttpMethod('post');
            generateRestCall.setEndpoint(baseUrl + '/summarizeTask');
            generateRestCall.setRequestHeader('Content-Type', 'application/json');
            generateRestCall.setRequestHeader('Authorization', 'Bearer ' + token);
            var generateBody = {
                //"model": "codellama:7b-code",
                "model": "starcoder:1b",
                //<PRE> {prefix} <SUF>{suffix} <MID>
                //"prompt": "<PRE>" + prefix + "<SUF>" + suffix + "<MID>",
                "prompt": script,
                "stream": false,
                "options": {
                    "temperature": 0.2
                }
            };
            generateRestCall.setRequestBody(JSON.stringify(generateBody));
            generateRestCall.setMIDServer(midserver);
            var generateResponse = generateRestCall.execute();
            var generateResponseBody = generateResponse.getBody();
            gs.info(generateResponseBody);
            var llmResponse = JSON.parse(generateResponseBody);
            var answer = llmResponse.response;
            return answer;
        } catch (error) {
            return error;
        }
    },
    type: 'aiabAjax'
});]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>jacebenson</sys_created_by>
        <sys_created_on>2024-02-12 07:43:24</sys_created_on>
        <sys_id>7849113993948210071230a97bba105f</sys_id>
        <sys_mod_count>272</sys_mod_count>
        <sys_name>aiabAjax</sys_name>
        <sys_package display_value="AI in a Box" source="0439d1f593948210071230a97bba1016">0439d1f593948210071230a97bba1016</sys_package>
        <sys_policy/>
        <sys_scope display_value="AI in a Box">0439d1f593948210071230a97bba1016</sys_scope>
        <sys_update_name>sys_script_include_7849113993948210071230a97bba105f</sys_update_name>
        <sys_updated_by>opencode</sys_updated_by>
        <sys_updated_on>2026-01-22 23:59:38</sys_updated_on>
    </sys_script_include>
</record_update>
