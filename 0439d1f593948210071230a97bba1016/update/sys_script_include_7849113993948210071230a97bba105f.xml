<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>public</access>
        <active>true</active>
        <api_name>global.aiabAjax</api_name>
        <caller_access>1</caller_access>
        <client_callable>true</client_callable>
        <description/>
        <mobile_callable>false</mobile_callable>
        <name>aiabAjax</name>
        <sandbox_callable>true</sandbox_callable>
        <script><![CDATA[var aiabAjax = Class.create();
aiabAjax.prototype = Object.extendsObject(AbstractAjaxProcessor, {
    cancelAIInference: function (sys_id, table, inferenceId) {
        try {
            if (!sys_id) sys_id = this.getParameter('sysparm_sys_id') || false;
            if (!table) table = this.getParameter('sysparm_table') || false;
            if (!inferenceId) inferenceId = this.getParameter('sysparm_inference_id') || false;
            var inference = new GlideRecord('u_ai_inference');
            if (inferenceId) {
                inference.addQuery('sys_id', inferenceId);
            }
            if (table && sys_id) {
                inference.addQuery('u_table', table);
                inference.addQuery('u_target', sys_id);
            }
            inference.addQuery('u_state', 'requested');
            inference.orderByDesc('sys_created_on');
            inference.query();
            if (inference.hasNext() === false) {
                return "Nothing to cancel.";
            }
            while (inference.next()) {
                inference.setValue('u_state', 'cancelled');
                inference.update();
                return "Cancelled Inference.";
            }
        } catch (error) {

        }
    },
    createAIInference: function (sys_id, table, type) {
        try {
            if (!sys_id) sys_id = this.getParameter('sysparm_sys_id') || "";
            if (!table) table = this.getParameter('sysparm_table') || "";
			if (!type) type = this.getParameter('sysparm_type') || "generic";
            var data = this.getParameter('sysparm_data') || {};
            var inference = new GlideRecord('u_ai_inference');
            inference.newRecord();
            inference.setValue('u_target', sys_id);
            inference.setValue('u_table', table);
            inference.setValue('u_metadata', data);
			inference.setValue('u_type', type);
            return inference.insert();
        } catch (error) {
            return error;
        }
    },
    createAIChat: function (messages) {
        try {
            if (!messages) messages = this.getParameter('sysparm_messages') || false;
            if (messages == false) {
                return JSON.stringify({ error: "missing messages" })
            }
            var inference = new GlideRecord('u_ai_inference');
            inference.newRecord();
			inference.setValue('u_type','chat');
            // lets build some context...
            var context = [{
				role: "system",
				content: "You are a chatbot.  You will answer questions presented by the user, and if you don't know the answer, reply 'I don\'t know that.'"
			}]
            //who am i?
            var sys_user = new GlideRecord('sys_user');
            sys_user.get(gs.getUserID());
			var userData = [
                "Logged in user: " + sys_user.getDisplayValue(),
                "- Email: " + sys_user.email || "Not set",
                "- Phone: " + sys_user.phone_number || "Not set",
                "- Location: " + sys_user.location.getDisplayValue() || "Not set",
                "- Department: " + sys_user.department.getDisplayValue() || "Not set",
                "- Manager: " + sys_user.manager.getDisplayValue() || "Not set",
                "- Title: " + sys_user.title || "Not set",
            ].join('\n');
            // if admin, lets get some .. interesting data
            if (gs.hasRole('admin')) {
                // add some.. details from the system using this post
                // https://www.servicenow.com/community/developer-articles/instance-performance-maintenance-and-administration/ta-p/2326277
                // logged in users
                // https://dev216364.service-now.com/v_user_session_list.do?sysparm_query=user!%3Dguest&sysparm_view=
                var adminContext = [userData];
                var sessions = new GlideQuery('v_user_session')
                    .where('user', '!=', 'guest')
                    .count();

                adminContext.push('There are ' + sessions + ' users logged in.');


				// query sys_log_transactions
				// sys_created_onRELATIVEGT@minute@ago@5^urlSTARTSWITH/^type!=rest^ORtype=^type!=soap^ORtype=^url!=/amb_session_setup.do^ORurl=NULL
				// group by sys_created_by
				// gett things like admin
                var fiveMinuteAgo = new GlideDateTime();
                fiveMinuteAgo.addSeconds(-300);
                var transactions = new GlideQuery('syslog_transaction')
                    .where('sys_created_on', '>', fiveMinuteAgo)
                    .where('type', '!=', 'rest')
                    .where('type', '!=', 'soap')
                    .where('url', '!=', '/amb_session_setup.do')
                    .where('url', '!=', 'NULL')
                    .aggregate('avg', 'response_time')
                    .groupBy('sys_created_by')
                    .select()
                    .toArray(10);

                var txMessage = '';
                transactions.forEach(function (transaction) {
                    var responseTimeInSec = transaction.avg.response_time / 1000;
                    if (transaction.avg.response_time > 1000) {
                        txMessage += 'User "' + transaction.group.sys_created_by + '" had an average response time of ' + responseTimeInSec + 's on the syslog_transaction table\n';
                    }
                });
                if (txMessage.length > 0) {
                    txMessage = 'The following transactions took longer than 3s:\n' + txMessage;
                }


                //adminContext.push('Average response time for transactions over last 5 minutes: ' + transactions + 'ms. Anything over 3000ms is considered slow.');
                adminContext.push(txMessage);

                // count events for today
                var today = new GlideDateTime();
                // set today to midnight
                today.setDisplayValue(today.getDisplayValue().split(' ')[0] + ' 00:00:00');
                var events = new GlideQuery('sysevent')
                    .where('sys_created_on', '>', today)
                    .aggregate('count')
                    .groupBy('name')
                    .select()
                    .toArray(10);
                events.sort(function (a, b) {
                    return b.count - a.count;
                });
                var message = 'The 10 most common events today are:\n';
                events.forEach(function (event) {
                    message += '- ' + event.group.name + ' occurred ' + event.count + ' times\n';
                });
                adminContext.push(message);
                // lets get all tasks assigned to me that are not closed and updated in the last 2 weeks
                // well get the number and short description
                var twoWeeksAgo = new GlideDateTime();
                twoWeeksAgo.addDays(-14);
                var tasks = new GlideQuery('task')
                    .where('assigned_to', '=', gs.getUserID())
                    .where('active', '=', true)
                    .where('sys_updated_on', '>', twoWeeksAgo)
                    .select('number', 'short_description')
                    .toArray(10);
                var taskMessage = 'You have ' + tasks.length + ' tasks assigned to you.';
                tasks.forEach(function (task) {
                    taskMessage += '\n- ' + task.number + ': ' + task.short_description;
                });

                adminContext.push(taskMessage);

                context.push({
                    role: "assistant",
                    content: adminContext.join('\n')
                });
                context.push({
                    role:"user",
                    content: "Who am I?"
                })
                context.push({
                    role:"assistant",
                    content: "You are " + sys_user.getDisplayValue() + "."
                })
                context.push({
                    role:"user",
                    content: "How many events are we tracking?"
                })
                context.push({
                    role:"assistant",
                    content: "We are tracking " + events.length + " events."
                })
                var parsedMessages = JSON.parse(messages);
                //we need to prepend the context to the messages
                parsedMessages = context.concat(parsedMessages);
                inference.setValue('u_prompt', JSON.stringify(parsedMessages, null, 4));
                return inference.insert();
            }
            if(gs.hasRole('itil')){
                context.push(userData);
                var parsedMessages = JSON.parse(messages);
                //we need to prepend the context to the messages
                parsedMessages = context.concat(parsedMessages);
                inference.setValue('u_prompt', JSON.stringify(parsedMessages, null, 4));
                return inference.insert();
            }
            if(!gs.hasRole('itil') && !gs.hasRole('admin')){
                context.push(userData);
                var parsedMessages = JSON.parse(messages);
                //we need to prepend the context to the messages
                parsedMessages = context.concat(parsedMessages);
                inference.setValue('u_prompt', JSON.stringify(parsedMessages, null, 4));
                return inference.insert();

            }
            // lets get a summary of some simple stats
            // users logged in, incidents created today, yesterday
            // inferences created today, yesterday


        } catch (error) {
            return error;
        }
    },
	askClientScript: function (sys_id, table, prompt, script) {
		 try {
            if (!sys_id) sys_id = this.getParameter('sysparm_sys_id') || "";
            if (!table) table = this.getParameter('sysparm_table') || "";
			if (!script) script = this.getParameter('sysparm_script') || "";
			if (!prompt) prompt = this.getParameter('sysparm_prompt');
            var inference = new GlideRecord('u_ai_inference');
            inference.newRecord();
            inference.setValue('u_target', sys_id);
            inference.setValue('u_table', table);
			/**
			 * Exlain how this code works 
			 * """
			 * function onChange(...){.
			 * ..}
			 * """
			 * 			 */
			 var jsonPrompt = [
 {
  "role": "system",
  "content": "You are a helpful assistant."
 },
 {
  "role": "user",
  "content": 'I have a question about this code.\n\n"""' + script + '\n""""'
 }
]
			inference.setValue('u_prompt', JSON.stringify(jsonPrompt));
			inference.setValue('u_type', 'generic');
            return inference.insert();
        } catch (error) {
            return error;
        }

	},
    createAIInferenceAskRecord: function (sys_id, table, prompt) {
        try {
            if (!sys_id) sys_id = this.getParameter('sysparm_sys_id') || "";
            if (!table) table = this.getParameter('sysparm_table') || "";
			if (!prompt) prompt = this.getParameter('sysparm_prompt');
            var inference = new GlideRecord('u_ai_inference');
            inference.newRecord();
            inference.setValue('u_target', sys_id);
            inference.setValue('u_table', table);
			inference.setValue('u_prompt', prompt);
			inference.setValue('u_type', 'ask-record');
            return inference.insert();
        } catch (error) {
            return error;
        }
    },
    isChatEnabled: function () {
        // Check if chat feature is enabled
        var enabled = gs.getProperty('ai_in_a_box.feature.chat.enabled') == 'true';
        if (!enabled) return 'false';
        
        // Check if user has one of the required roles
        var rolesStr = gs.getProperty('ai_in_a_box.feature.chat.roles') || '';
        if (!rolesStr) return 'true'; // No roles configured = everyone can use
        
        var roles = rolesStr.split(',');
        for (var i = 0; i < roles.length; i++) {
            if (gs.hasRole(roles[i].trim())) {
                return 'true';
            }
        }
        return 'false';
    },
    getInferenceRecord: function (sys_id) {
        try {
            if (!sys_id) sys_id = this.getParameter('sysparm_sys_id') || "";
            var inferenceGR = new GlideRecord('u_ai_inference');
            inferenceGR.addQuery('u_target', sys_id);
            inferenceGR.orderByDesc('sys_created_on');
            inferenceGR.setLimit(1);
            inferenceGR.query();
            if (inferenceGR.next()) {
                return inferenceGR.getValue('u_response') || "";
            } else {
                return "No summary found";
            }
        } catch (error) {
            return error;
        }
    },
    getSummarizeTemplate: function (table, sys_id, template) {
        try {
            if (!table) table = this.getParameter('sysparm_table') || "";
            if (!sys_id) sys_id = this.getParameter('sysparm_sys_id') || "";
            if (!template) template = this.getParameter('sysparm_template');
            var task = new GlideRecord(table);
            if (task.get(sys_id)) {
                var aiSummarierGR = new GlideRecord('u_ai_summarizer');
                aiSummarierGR.addQuery('u_active', 'true');
                aiSummarierGR.addQuery('u_table', table);
                aiSummarierGR.setLimit(1);
                aiSummarierGR.query();
                if (aiSummarierGR.next()) {
                    var recordTemplate;
                    if (!template) recordTemplate = aiSummarierGR.getValue('u_record_template');
                    if (template) recordTemplate = template;
                    var recordFieldsFromTemplate = recordTemplate.match(/{{(.*?)}}/g);
                    var fields = recordFieldsFromTemplate.map(function (field) {
                        field = field.replace('{{', '').replace('}}', '');
                        return field;
                    });

                    var taskText = recordTemplate + '';
                    fields.forEach(function (field) {
                        var value = task.getDisplayValue(field) || '';
                        if (field == "__all_variables__") {
                            value += "Variables:\n";
                            for (var prop in task.variables) {
                                value += prop + ': ' + task.variables[prop] + '\n';
                            }
                        }
                        if (field.indexOf('__related__') > -1) {
                            try {
                                // what do i need to get a related list of display values
                                // i need the table, the query, and the field name
                                var clearField = field.replace('__related__', '');
                                var parts = clearField.split('__');
                                var rTable = parts[0];
                                var rQuery = parts[1];
                                var rField = parts[2].split(',');
                                (function () {
                                    var re = /\[\[(.*?)\]\]/g;
                                    var match;
                                    var result = [];
                                    while (match = re.exec(rQuery)) {
                                        result.push(match[1]);
                                    }
                                    result.forEach(function (r) {
                                        rQuery = rQuery.replace('[[' + r + ']]', task.getValue(r));
                                    });
                                })();
                                var rGR = new GlideRecord(rTable);
                                rGR.addQuery(rQuery);
                                rGR.setLimit(10);
                                //value = rTable + ':' + rField + ':' + rQuery
                                rGR.query();
                                var rValues = [];
                                while (rGR.next()) {
                                    var rFields = []
                                    rField.forEach(function (dField) {
                                        rFields.push(rGR.getElement(dField).getLabel() + ': ' + rGR.getDisplayValue(dField));
                                    });
                                    rValues.push(rFields.join('\n>'));
                                }
                                value = rValues.join('\n\n');
                            } catch (e) {
                                value = "ERROR: " + e
                            }
                        }
                        taskText = taskText.replace('{{' + field + '}}', value);
                    });
                    return taskText;
                } else {
                    return "Cannot find Summarizer Record";
                }
            } else {
                return "Cannot find Task";
            }
        } catch (error) {
            return "Error: " + error;
        }
    },

    commentToCode: function (instruction, script) {
        try {
            if (!instruction) instruction = this.getParameter('sysparm_instruction') || "";
            if (!script) script = this.getParameter('sysparm_script') || "";

            // prefix is code between script beginning, and instruction
            // suffix is code between instruction and end
            var prefix = script.split(instruction)[0] || "";
            var suffix = script.split(instruction)[1] || "";

            var baseUrl = gs.getProperty('scribe.url');
            var midserver = gs.getProperty('scribe.midserver');
            var model = gs.getProperty('scribe.model');
            var prompt = gs.getProperty('scribe.prompt.summarize');
            var tokenRestCall = new sn_ws.RESTMessageV2();
            tokenRestCall.setHttpMethod('post');
            tokenRestCall.setEndpoint(baseUrl + '/api/v1/auths/signin');
            tokenRestCall.setRequestHeader('Content-Type', 'application/json');
            var tokenBody = {
                "email": gs.getProperty('scribe.email'),
                "password": gs.getProperty('scribe.password')
            };
            tokenRestCall.setRequestBody(JSON.stringify(tokenBody));
            tokenRestCall.setMIDServer(midserver);
            var tokenResponse = tokenRestCall.execute();
            var tokenResponseBody = tokenResponse.getBody();
            var token = JSON.parse(tokenResponseBody).token || false;
            if (!token) return "Cannot Summarize, token not valid";
            var generateRestCall = new sn_ws.RESTMessageV2();
            generateRestCall.setHttpMethod('post');
            generateRestCall.setEndpoint(baseUrl + '/summarizeTask');
            generateRestCall.setRequestHeader('Content-Type', 'application/json');
            generateRestCall.setRequestHeader('Authorization', 'Bearer ' + token);
            var generateBody = {
                //"model": "codellama:7b-code",
                "model": "starcoder:1b",
                //<PRE> {prefix} <SUF>{suffix} <MID>
                //"prompt": "<PRE>" + prefix + "<SUF>" + suffix + "<MID>",
                "prompt": script,
                "stream": false,
                "options": {
                    "temperature": 0.2
                }
            };
            generateRestCall.setRequestBody(JSON.stringify(generateBody));
            generateRestCall.setMIDServer(midserver);
            var generateResponse = generateRestCall.execute();
            var generateResponseBody = generateResponse.getBody();
            gs.info(generateResponseBody);
            var llmResponse = JSON.parse(generateResponseBody);
            var answer = llmResponse.response;
            return answer;
        } catch (error) {
            return error;
        }
    },
    type: 'aiabAjax'
});]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>jacebenson</sys_created_by>
        <sys_created_on>2024-02-12 07:43:24</sys_created_on>
        <sys_id>7849113993948210071230a97bba105f</sys_id>
        <sys_mod_count>268</sys_mod_count>
        <sys_name>aiabAjax</sys_name>
        <sys_package display_value="AI in a Box" source="0439d1f593948210071230a97bba1016">0439d1f593948210071230a97bba1016</sys_package>
        <sys_policy/>
        <sys_scope display_value="AI in a Box">0439d1f593948210071230a97bba1016</sys_scope>
        <sys_update_name>sys_script_include_7849113993948210071230a97bba105f</sys_update_name>
        <sys_updated_by>opencode</sys_updated_by>
        <sys_updated_on>2026-01-22 18:43:58</sys_updated_on>
    </sys_script_include>
</record_update>
