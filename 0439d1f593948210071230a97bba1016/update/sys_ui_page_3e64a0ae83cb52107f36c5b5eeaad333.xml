<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_ui_page">
    <sys_ui_page action="INSERT_OR_UPDATE">
        <category>general</category>
        <client_script><![CDATA[$j(document).ready(function () {
	try{
		iframeHelper.hideCloseButton();
		iframeHelper.autoResize();
	} catch(error){
		//
	}
    $j("#response").on("change", function () {
        $j(this).css('height', 'auto');
        $j(this).css('height', this.scrollHeight + 'px');
        try{
			iframeHelper.setHeight(this.scrollHeight);
		} catch(error){
			//
		}
    });
    $j('#stop').click(function () {
        cancelInference();
    });
    $j('#ask').click(function () {
        generateResponse();
    });
    $j('#cancel').click(function () {
		try{
        iframeHelper.cancel();
		GlideModal.get().destroy();

		}catch(error){
			//
		}
    });

    var url = new URL(window.location.href);
    var table = url.searchParams.get("table") || document.getElementById('table').value;
    var record = url.searchParams.get("record") || document.getElementById('record').value;
    var watchRecord = function (table, filter, callback) {
        function getFilterString(filter) {
            return btoa(filter.replace(/\^EQ/g, '').replace(/\^ORDERBY(?:DESC)?[^^]*/g, '').replace(/^GOTO/, '')).replace(/=/g, '-');
        }
        if (table === "sys_amb_message" || table.startsWith("sys_rw")) return null;
        var amb = top.window.top.g_ambClient;
        var watcherChannel = amb.getChannel('/rw/default/' + table + '/' + getFilterString(filter));
        watcherChannel.subscribe(callback);
        amb.connect();
        return watcherChannel;
    };
    var cancelInference = function () {
        var ga = new GlideAjax('aiabAjax');
        ga.addParam('sysparm_name', 'cancelAIInference');
        ga.addParam('sysparm_sys_id', $j("#inference").val());
        ga.getXMLAnswer(function (response) {

        });
    };
    var generateResponse = function () {
        //disable regenerate button
        $j('#ask').prop('disabled', true);
        $j('#stop').prop('disabled', false);
        var ga = new GlideAjax('aiabAjax');
        ga.addParam('sysparm_name', 'createAIInferenceAskRecord');
        ga.addParam('sysparm_sys_id', record);
        ga.addParam('sysparm_table', table);
        ga.addParam('sysparm_prompt', $j("#prompt").val());
        ga.getXMLAnswer(function (response) {
            $j("#inference").val(response);
            var queryToWatch = 'sys_id=' + response;
            watchRecord('u_ai_inference', queryToWatch, function (message) {
                var response = message.data.record.u_response;
                //console.log({record:message.data.record});
                var responseFound = typeof response !== 'undefined';
                if (responseFound) {
                    var responseValue = response.display_value;
                    $j("#response").val(responseValue);
					try{
                    iframeHelper.setHeight($j("#p-response")[0].scrollHeight + 40);
					}catch(error){
						//
					}
                }
                var state = message.data.record.u_state;
                var stateFound = typeof state !== 'undefined';
                if (stateFound) {
                    var stateValue = state.value;
                    if (stateValue === 'finished' || stateValue === 'cancelled') {
                        $j('#ask').prop('disabled', false);
                        $j('#stop').prop('disabled', true);
                    }
                }
            });
        });
    };
});]]></client_script>
        <description/>
        <direct>false</direct>
        <endpoint/>
        <html><![CDATA[<?xml version="1.0" encoding="utf-8" ?>
<j:jelly trim="false"
    xmlns:j="jelly:core"
    xmlns:g="glide"
    xmlns:j2="null"
    xmlns:g2="null">
    <g:requires name="iframeHelper.jsdbx"></g:requires>
	<j:set var="jvar_table" value="${sysparm_table}"/>
	<j:set var="jvar_record" value="${sysparm_record}"/>
    <div class="form-group">
        <label for="prompt">Ask Away</label>
        <textarea class="form-control" id="prompt" name="prompt" style="height: auto;">
        ${prompt}
        </textarea>
		<label for="response">Response</label>
		<textarea class="form-control" id="response" name="response" style="height: auto;" rows="15">
        ${response}
        </textarea>
        <label for="inference" class="hidden">Inference</label>
        <input id="inference" class="form-control hidden" />
		<label for="table" class="hidden">Table</label>
        <input id="table" class="form-control hidden" value="${jvar_table}" />
		<label for="record" class="hidden">Record</label>
        <input id="record" class="form-control hidden" value="${jvar_record}" />
    </div>
    <div style="display:flex; gap: 4px;">
        <button id="ask" class="btn btn-default">Ask</button>
        <button id="stop" class="btn btn-danger">
            <span id="spinner" class="glyphicon glyphicon-refresh glyphicon-spin" style="display:none;"></span>
		Stop
        </button>
        <button id="cancel" class="btn btn-primary">Close</button>
    </div>

</j:jelly>]]></html>
        <name>aiiab.ask</name>
        <processing_script/>
        <sys_class_name>sys_ui_page</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-01-15 00:51:07</sys_created_on>
        <sys_id>3e64a0ae83cb52107f36c5b5eeaad333</sys_id>
        <sys_mod_count>11</sys_mod_count>
        <sys_name>aiiab.ask</sys_name>
        <sys_package display_value="AI in a Box" source="0439d1f593948210071230a97bba1016">0439d1f593948210071230a97bba1016</sys_package>
        <sys_policy/>
        <sys_scope display_value="AI in a Box">0439d1f593948210071230a97bba1016</sys_scope>
        <sys_update_name>sys_ui_page_3e64a0ae83cb52107f36c5b5eeaad333</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-01-15 06:25:30</sys_updated_on>
    </sys_ui_page>
</record_update>
