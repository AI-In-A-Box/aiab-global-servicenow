<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_ui_page">
    <sys_ui_page action="INSERT_OR_UPDATE">
        <category>general</category>
        <client_script><![CDATA[$j(document).ready(function() {
    // Fixed height for modal - no dynamic resizing
    try {
        iframeHelper.hideCloseButton();
        iframeHelper.setHeight(450);
    } catch(e) {
        // Not in modal context, ignore
    }
    
    // State
    var table = $j('#chat-table').val();
    var record = $j('#chat-record').val();
    var display = $j('#chat-display').val();
    var isFloating = $j('#chat-floating').val() === 'true';
    var isModal = $j('#chat-modal').val() === 'true';
    var isLoading = false;
    var watcherChannel = null;
    var isViewingHistory = false;
    var previousChats = [];
    
    // Apply mode classes
    if (isFloating) {
        $j('#aiab-chat-container').addClass('floating-mode');
        $j('#expand-btn').show();
    }
    if (isModal) {
        $j('#aiab-chat-container').addClass('modal-mode');
    }
    
    // Initialize conversation with greeting
    var conversationHistory = [
        { role: 'assistant', content: 'Hi! How can I help you today?' }
    ];
    
    // Update context bar
    if (table && record) {
        $j('#context-text').text(table + ': ' + (display || record));
    } else {
        $j('#context-bar').hide();
    }
    
    // Load previous chats for this record
    loadPreviousChats();
    
    function loadPreviousChats() {
        if (!table || !record) return;
        
        var ga = new GlideAjax('aiabAjax');
        ga.addParam('sysparm_name', 'getChatHistory');
        ga.addParam('sysparm_table', table);
        ga.addParam('sysparm_record', record);
        ga.getXMLAnswer(function(response) {
            try {
                var data = JSON.parse(response);
                if (data && data.chats && data.chats.length > 0) {
                    previousChats = data.chats;
                    // Show appropriate history button based on mode
                    if (isModal) {
                        $j('#history-btn-modal').show();
                        buildHistoryDropdown('#history-dropdown-modal');
                    } else {
                        $j('#history-btn').show();
                        buildHistoryDropdown('#history-dropdown');
                    }
                }
            } catch(e) {
                console.error('Error loading chat history', e);
            }
        });
    }
    
    function buildHistoryDropdown(selector) {
        var html = '<div class="aiab-history-header">Previous Conversations</div>';
        for (var i = 0; i < previousChats.length; i++) {
            var chat = previousChats[i];
            html += '<button class="aiab-history-item" data-id="' + chat.sys_id + '">';
            html += '<div class="aiab-history-preview">' + escapeHtml(chat.preview) + '</div>';
            html += '<div class="aiab-history-date">' + chat.created + '</div>';
            html += '</button>';
        }
        $j(selector).html(html);
        
        // Bind click events
        $j(selector + ' .aiab-history-item').click(function() {
            var chatId = $j(this).data('id');
            loadConversation(chatId);
            $j(selector).hide();
        });
    }
    
    function loadConversation(chatId) {
        var ga = new GlideAjax('aiabAjax');
        ga.addParam('sysparm_name', 'loadChatConversation');
        ga.addParam('sysparm_sys_id', chatId);
        ga.getXMLAnswer(function(response) {
            try {
                var data = JSON.parse(response);
                if (data && data.messages) {
                    conversationHistory = data.messages;
                    isViewingHistory = true;
                    renderMessages();
                    // Show new chat button and history badge based on mode
                    if (isModal) {
                        $j('#new-chat-btn-modal').show();
                        $j('#history-badge-modal').show();
                    } else {
                        $j('#new-chat-btn').show();
                        $j('#history-badge').show();
                    }
                    $j('#user-input').attr('placeholder', 'Continue this conversation...');
                }
            } catch(e) {
                console.error('Error loading conversation', e);
            }
        });
    }
    
    function renderMessages() {
        var html = '';
        for (var i = 0; i < conversationHistory.length; i++) {
            var msg = conversationHistory[i];
            var cls = msg.role === 'user' ? 'aiab-msg-user' : 'aiab-msg-assistant';
            html += '<div class="aiab-msg ' + cls + '">' + formatMarkdown(msg.content) + '</div>';
        }
        $j('#messages').html(html);
        // Use setTimeout to ensure DOM is updated before scrolling
        setTimeout(scrollToBottom, 50);
    }
    
    function startNewChat() {
        conversationHistory = [
            { role: 'assistant', content: 'Hi! How can I help you today?' }
        ];
        isViewingHistory = false;
        renderMessages();
        $j('#new-chat-btn, #new-chat-btn-modal').hide();
        $j('#history-badge, #history-badge-modal').hide();
        $j('#user-input').attr('placeholder', 'Type a message...');
    }
    
    // Event handlers
    $j('#expand-btn').click(function() {
        try {
            window.parent.postMessage({ type: 'aiab-expand' }, '*');
        } catch(e) {
            console.error('Could not send expand message', e);
        }
    });
    
    // History buttons (both modes)
    $j('#history-btn').click(function(e) {
        e.stopPropagation();
        $j('#history-dropdown').toggle();
    });
    $j('#history-btn-modal').click(function(e) {
        e.stopPropagation();
        $j('#history-dropdown-modal').toggle();
    });
    
    // New chat buttons (both modes)
    $j('#new-chat-btn, #new-chat-btn-modal').click(function() {
        startNewChat();
    });
    
    $j(document).click(function() {
        $j('#history-dropdown, #history-dropdown-modal').hide();
    });
    
    $j('#history-dropdown, #history-dropdown-modal').click(function(e) {
        e.stopPropagation();
    });
    
    $j('#user-input').keypress(function(e) {
        if (e.which === 13 && !isLoading) {
            sendMessage();
        }
    });
    
    $j('#send-btn').click(function() {
        if (!isLoading) sendMessage();
    });
    
    $j('#stop-btn').click(function() {
        stopGeneration();
    });
    
    function sendMessage() {
        var userInput = $j('#user-input').val().trim();
        if (!userInput) return;
        
        // If viewing history, we're now continuing
        if (isViewingHistory) {
            isViewingHistory = false;
            $j('#history-badge, #history-badge-modal').hide();
            $j('#user-input').attr('placeholder', 'Type a message...');
        }
        
        // Add user message to UI and history
        addMessageToUI('user', userInput);
        conversationHistory.push({ role: 'user', content: userInput });
        
        // Clear input and show loading
        $j('#user-input').val('');
        setLoading(true);
        
        // Show loading dots
        var loadingHtml = '<div class="aiab-msg aiab-msg-assistant" id="loading-msg">' +
            '<div class="aiab-loading">' +
            '<span class="aiab-dot"></span><span class="aiab-dot"></span><span class="aiab-dot"></span>' +
            '</div></div>';
        $j('#messages').append(loadingHtml);
        setTimeout(scrollToBottom, 50);
        
        // Create inference
        var ga = new GlideAjax('aiabAjax');
        ga.addParam('sysparm_name', 'createAIChat');
        ga.addParam('sysparm_conversation', JSON.stringify(conversationHistory));
        ga.addParam('sysparm_table', table);
        ga.addParam('sysparm_record', record);
        ga.getXMLAnswer(function(response) {
            if (response) {
                $j('#current-inference').val(response);
                $j('#loading-msg').remove();
                addMessageToUI('assistant', '', 'current-response');
                watchInference(response);
            } else {
                $j('#loading-msg').remove();
                addMessageToUI('assistant', 'Sorry, something went wrong. Please try again.');
                setLoading(false);
            }
        });
    }
    
    function addMessageToUI(role, content, id) {
        var cls = role === 'user' ? 'aiab-msg-user' : 'aiab-msg-assistant';
        var idAttr = id ? ' id="' + id + '"' : '';
        var html = '<div class="aiab-msg ' + cls + '"' + idAttr + '>' + formatMarkdown(content) + '</div>';
        $j('#messages').append(html);
        setTimeout(scrollToBottom, 50);
    }
    
    function updateAssistantMessage(content) {
        $j('#current-response').html(formatMarkdown(content));
        setTimeout(scrollToBottom, 50);
    }
    
    function finalizeAssistantMessage(content) {
        $j('#current-response').removeAttr('id');
        conversationHistory.push({ role: 'assistant', content: content });
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }
    
    function formatMarkdown(text) {
        if (!text) return '';
        var html = escapeHtml(text);
        html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
        html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
        html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
        html = html.replace(/\n/g, '<br>');
        return html;
    }
    
    function scrollToBottom() {
        var container = $j('#messages')[0];
        if (container) {
            container.scrollTop = container.scrollHeight;
        }
    }
    
    function setLoading(loading) {
        isLoading = loading;
        $j('#send-btn').toggle(!loading);
        $j('#stop-btn').toggle(loading);
        $j('#user-input').prop('disabled', loading);
    }
    
    function stopGeneration() {
        var inferenceId = $j('#current-inference').val();
        if (!inferenceId) return;
        
        var ga = new GlideAjax('aiabAjax');
        ga.addParam('sysparm_name', 'cancelAIInference');
        ga.addParam('sysparm_sys_id', inferenceId);
        ga.getXMLAnswer(function() {
            setLoading(false);
            if (watcherChannel) {
                try { watcherChannel.unsubscribe(); } catch(e) {}
                watcherChannel = null;
            }
        });
    }
    
    function watchInference(inferenceId) {
        var filter = 'sys_id=' + inferenceId;
        
        function getFilterString(f) {
            return btoa(f.replace(/\^EQ/g, '').replace(/\^ORDERBY(?:DESC)?[^^]*/g, '').replace(/^GOTO/, '')).replace(/=/g, '-');
        }
        
        try {
            var amb = null;
            try {
                amb = window.parent.g_ambClient || (window.parent.top && window.parent.top.g_ambClient);
            } catch(e) {}
            
            if (!amb) {
                pollInference(inferenceId);
                return;
            }
            
            var channelName = '/rw/default/u_ai_inference/' + getFilterString(filter);
            watcherChannel = amb.getChannel(channelName);
            watcherChannel.subscribe(function(message) {
                var rec = message.data && message.data.record;
                if (!rec) return;
                
                if (rec.u_response) {
                    var val = rec.u_response.value !== undefined ? rec.u_response.value : rec.u_response;
                    updateAssistantMessage(val);
                }
                
                var state = rec.u_state ? (rec.u_state.value !== undefined ? rec.u_state.value : rec.u_state) : null;
                if (state === 'finished' || state === 'cancelled') {
                    setLoading(false);
                    var finalResponse = $j('#current-response').text();
                    finalizeAssistantMessage(finalResponse);
                    try { watcherChannel.unsubscribe(); } catch(e) {}
                    watcherChannel = null;
                    loadPreviousChats();
                }
            });
            amb.connect();
        } catch(e) {
            console.error('AMB error, falling back to polling', e);
            pollInference(inferenceId);
        }
    }
    
    function pollInference(inferenceId) {
        var pollCount = 0;
        var maxPolls = 120;
        
        function poll() {
            if (!isLoading || pollCount >= maxPolls) return;
            pollCount++;
            
            var ga = new GlideAjax('aiabAjax');
            ga.addParam('sysparm_name', 'getAIInference');
            ga.addParam('sysparm_sys_id', inferenceId);
            ga.getXMLAnswer(function(response) {
                try {
                    var data = JSON.parse(response);
                    if (data.response) {
                        updateAssistantMessage(data.response);
                    }
                    if (data.state === 'finished' || data.state === 'cancelled') {
                        setLoading(false);
                        if (data.response) {
                            finalizeAssistantMessage(data.response);
                        }
                        loadPreviousChats();
                    } else {
                        setTimeout(poll, 1000);
                    }
                } catch(e) {
                    setLoading(false);
                }
            });
        }
        
        setTimeout(poll, 1000);
    }
});]]></client_script>
        <description/>
        <direct>false</direct>
        <endpoint/>
        <html><![CDATA[<?xml version="1.0" encoding="utf-8" ?>
<j:jelly trim="false" xmlns:j="jelly:core" xmlns:g="glide" xmlns:j2="null" xmlns:g2="null">
    <g:requires name="iframeHelper.jsdbx"></g:requires>
    <j:set var="jvar_table" value="${sysparm_table}"/>
    <j:set var="jvar_record" value="${sysparm_record}"/>
    <j:set var="jvar_display" value="${sysparm_display}"/>
    <j:set var="jvar_floating" value="${sysparm_floating}"/>
    <j:set var="jvar_modal" value="${sysparm_modal}"/>
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        
        .aiab-chat {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            height: 450px;
            max-height: 450px;
            background: #fff;
            overflow: hidden;
        }
        
        /* Header - hidden in modal mode (modal has its own title) */
        .aiab-chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            border-bottom: 1px solid #e1e4e8;
            background: #f6f8fa;
            flex-shrink: 0;
        }
        .aiab-chat.modal-mode .aiab-chat-header {
            display: none;
        }
        .aiab-chat-title {
            font-size: 15px;
            font-weight: 600;
            color: #24292f;
            margin: 0;
        }
        .aiab-chat-header-btns {
            display: flex;
            gap: 4px;
        }
        .aiab-chat-header-btn {
            background: none;
            border: none;
            font-size: 14px;
            cursor: pointer;
            color: #57606a;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .aiab-chat-header-btn:hover {
            background: #e1e4e8;
            color: #24292f;
        }
        
        /* History dropdown */
        .aiab-history-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 280px;
            max-height: 300px;
            overflow-y: auto;
            background: #fff;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            z-index: 1000;
        }
        .aiab-history-header {
            padding: 10px 12px;
            font-size: 12px;
            font-weight: 600;
            color: #57606a;
            background: #f6f8fa;
            border-bottom: 1px solid #e1e4e8;
        }
        .aiab-history-item {
            display: block;
            width: 100%;
            padding: 10px 12px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            border-bottom: 1px solid #e1e4e8;
        }
        .aiab-history-item:hover {
            background: #f6f8fa;
        }
        .aiab-history-item:last-child {
            border-bottom: none;
        }
        .aiab-history-preview {
            font-size: 13px;
            color: #24292f;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .aiab-history-date {
            font-size: 11px;
            color: #57606a;
            margin-top: 2px;
        }
        
        /* Context bar */
        .aiab-chat-context {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            background: #f6f8fa;
            border-bottom: 1px solid #e1e4e8;
            font-size: 11px;
            color: #57606a;
            flex-shrink: 0;
        }
        .aiab-chat-context-badge {
            font-size: 10px;
            padding: 2px 6px;
            background: #1f6feb;
            color: #fff;
            border-radius: 10px;
        }
        
        /* Toolbar - shown in modal mode for history/new chat buttons */
        .aiab-chat-toolbar {
            display: none;
            padding: 6px 14px;
            background: #f6f8fa;
            border-bottom: 1px solid #e1e4e8;
            flex-shrink: 0;
        }
        .aiab-chat.modal-mode .aiab-chat-toolbar {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: flex-end;
        }
        .aiab-toolbar-spacer {
            flex: 1;
        }
        
        /* Messages - THIS is the only scrollable area */
        .aiab-chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0;
        }
        .aiab-msg {
            max-width: 85%;
            padding: 8px 12px;
            border-radius: 14px;
            font-size: 13px;
            line-height: 1.4;
            word-wrap: break-word;
            flex-shrink: 0;
        }
        .aiab-msg-user {
            align-self: flex-end;
            background: #1f6feb;
            color: #fff;
            border-bottom-right-radius: 4px;
        }
        .aiab-msg-assistant {
            align-self: flex-start;
            background: #f6f8fa;
            color: #24292f;
            border-bottom-left-radius: 4px;
        }
        .aiab-msg pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 8px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 6px 0;
            font-size: 11px;
        }
        .aiab-msg code {
            background: rgba(0,0,0,0.08);
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 12px;
        }
        .aiab-msg-user code {
            background: rgba(255,255,255,0.2);
        }
        
        /* Loading dots */
        .aiab-loading {
            display: flex;
            gap: 4px;
            padding: 8px;
        }
        .aiab-dot {
            width: 6px;
            height: 6px;
            background: #999;
            border-radius: 50%;
            animation: aiab-bounce 1.4s ease-in-out infinite;
        }
        .aiab-dot:nth-child(2) { animation-delay: 0.2s; }
        .aiab-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes aiab-bounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        /* Input area */
        .aiab-chat-input-area {
            display: flex;
            gap: 8px;
            padding: 10px 12px;
            border-top: 1px solid #e1e4e8;
            background: #fff;
            flex-shrink: 0;
        }
        .aiab-chat-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            font-size: 13px;
            outline: none;
        }
        .aiab-chat-input:focus {
            border-color: #1f6feb;
        }
        .aiab-chat-input:disabled {
            background: #f6f8fa;
        }
        .aiab-btn {
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }
        .aiab-btn-sm {
            padding: 4px 10px;
            font-size: 12px;
        }
        .aiab-btn-primary {
            background: #1f6feb;
            color: #fff;
        }
        .aiab-btn-primary:hover:not(:disabled) {
            background: #1558d6;
        }
        .aiab-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .aiab-btn-secondary {
            background: #e1e4e8;
            color: #24292f;
        }
        .aiab-btn-secondary:hover {
            background: #d0d3d7;
        }
        .aiab-btn-danger {
            background: #dc3545;
            color: #fff;
        }
        .aiab-btn-danger:hover {
            background: #c82333;
        }
    </style>
    
    <div class="aiab-chat" id="aiab-chat-container">
        <!-- Header (floating mode only) -->
        <div class="aiab-chat-header" style="position: relative;">
            <h5 class="aiab-chat-title">AI Assistant</h5>
            <div class="aiab-chat-header-btns">
                <button class="aiab-chat-header-btn" id="expand-btn" title="Expand" style="display:none;">&#x26F6;</button>
                <button class="aiab-chat-header-btn" id="history-btn" title="Previous conversations" style="display:none;">&#128220;</button>
                <button class="aiab-chat-header-btn" id="new-chat-btn" title="New conversation" style="display:none;">&#10133;</button>
            </div>
            <div class="aiab-history-dropdown" id="history-dropdown" style="display:none;"></div>
        </div>
        
        <!-- Toolbar (modal mode only) -->
        <div class="aiab-chat-toolbar" style="position: relative;">
            <span class="aiab-chat-context-badge" id="history-badge-modal" style="display:none;">viewing history</span>
            <div class="aiab-toolbar-spacer"></div>
            <button class="aiab-btn aiab-btn-sm aiab-btn-secondary" id="new-chat-btn-modal" title="New conversation" style="display:none;">&#10133; New</button>
            <button class="aiab-btn aiab-btn-sm aiab-btn-secondary" id="history-btn-modal" title="Previous conversations" style="display:none;">&#128220; History</button>
            <div class="aiab-history-dropdown" id="history-dropdown-modal" style="display:none;"></div>
        </div>
        
        <!-- Context bar -->
        <div class="aiab-chat-context" id="context-bar">
            <span>&#128203;</span>
            <span id="context-text">Loading...</span>
            <span class="aiab-chat-context-badge" id="history-badge" style="display:none; margin-left: auto;">viewing history</span>
        </div>
        
        <!-- Messages -->
        <div class="aiab-chat-messages" id="messages">
            <div class="aiab-msg aiab-msg-assistant">Hi! How can I help you today?</div>
        </div>
        
        <!-- Input -->
        <div class="aiab-chat-input-area">
            <input type="text" class="aiab-chat-input" id="user-input" placeholder="Type a message..." />
            <button class="aiab-btn aiab-btn-primary" id="send-btn">Send</button>
            <button class="aiab-btn aiab-btn-danger" id="stop-btn" style="display:none;">Stop</button>
        </div>
    </div>
    
    <!-- Hidden fields -->
    <input type="hidden" id="chat-table" value="${jvar_table}" />
    <input type="hidden" id="chat-record" value="${jvar_record}" />
    <input type="hidden" id="chat-display" value="${jvar_display}" />
    <input type="hidden" id="chat-floating" value="${jvar_floating}" />
    <input type="hidden" id="chat-modal" value="${jvar_modal}" />
    <input type="hidden" id="current-inference" value="" />
</j:jelly>]]></html>
        <name>aiab_chat_modal</name>
        <processing_script/>
        <sys_class_name>sys_ui_page</sys_class_name>
        <sys_created_by>opencode</sys_created_by>
        <sys_created_on>2026-01-22 19:47:50</sys_created_on>
        <sys_id>b808542a83e6b2104d4fccb6feaad394</sys_id>
        <sys_mod_count>20</sys_mod_count>
        <sys_name>aiab_chat_modal</sys_name>
        <sys_package display_value="AI in a Box" source="0439d1f593948210071230a97bba1016">0439d1f593948210071230a97bba1016</sys_package>
        <sys_policy/>
        <sys_scope display_value="AI in a Box">0439d1f593948210071230a97bba1016</sys_scope>
        <sys_update_name>sys_ui_page_b808542a83e6b2104d4fccb6feaad394</sys_update_name>
        <sys_updated_by>opencode</sys_updated_by>
        <sys_updated_on>2026-01-22 21:36:31</sys_updated_on>
    </sys_ui_page>
</record_update>
