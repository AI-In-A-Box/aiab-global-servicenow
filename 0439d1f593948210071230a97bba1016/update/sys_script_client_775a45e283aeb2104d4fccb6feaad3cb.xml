<?xml version="1.0" encoding="UTF-8"?><record_update sys_domain="global" table="sys_script_client">
    <sys_script_client action="INSERT_OR_UPDATE">
        <active>true</active>
        <applies_extended>true</applies_extended>
        <condition/>
        <description/>
        <field/>
        <global>true</global>
        <isolate_script>true</isolate_script>
        <messages/>
        <name>AIAB Chat Injector</name>
        <order/>
        <script><![CDATA[function onLoad() {
  try {
    console.log('AIAB Chat Injector: Starting');
    
    // Skip if already injected
    if (top.document.querySelector('#aiab-chat-iframe')) return;
    
    var table = g_form.getTableName();
    var sysId = g_form.getUniqueValue();
    var display = g_form.getValue('number') || '';
    
    var src = '/aiab?id=aiab_chat';
    src += '&record_table=' + encodeURIComponent(table);
    src += '&record_sys_id=' + encodeURIComponent(sysId);
    if (display) src += '&record_display=' + encodeURIComponent(display);
    
    // Size constants
    var BUTTON_WIDTH = '140px';
    var BUTTON_HEIGHT = '80px'; /* Fixed: was 60px, now 80px */
    var NORMAL_WIDTH = '420px';
    var NORMAL_HEIGHT = '560px';
    var WIDE_WIDTH = '640px';
    var WIDE_HEIGHT = '640px';
    var SNOOZED_WIDTH = '60px';
    var SNOOZED_HEIGHT = '60px';
    
    // Create iframe - START WITH BUTTON SIZE ONLY
    var iframe = top.document.createElement('iframe');
    iframe.id = 'aiab-chat-iframe';
    iframe.src = src;
    
    // FIXED CSS - ensure proper sizing and visibility
    iframe.style.cssText = 
      'position:fixed;' +
      'bottom:20px;' +
      'right:20px;' +
      'width:' + BUTTON_WIDTH + ';' +
      'height:' + BUTTON_HEIGHT + ';' +
      'border:none;' +
      'z-index:2147483647;' +
      'background:transparent;' +
      'pointer-events:auto;' +
      'transition:all 0.3s ease;' +
      'overflow:hidden;';
    
    iframe.setAttribute('allowtransparency', 'true');
    iframe.setAttribute('scrolling', 'no');
    
    top.document.body.appendChild(iframe);
    console.log('AIAB Chat Injector: Iframe injected');
    
    // Listen for messages from the widget to resize iframe
    top.window.addEventListener('message', function(event) {
      if (!event.data || event.data.type !== 'aiab-chat-state') return;
      
      var chatIframe = top.document.getElementById('aiab-chat-iframe');
      if (!chatIframe) return;
      
      console.log('AIAB Chat Injector: Received state', event.data);
      
      if (event.data.isSnoozed) {
        // Snoozed - tiny button in corner
        chatIframe.style.width = SNOOZED_WIDTH;
        chatIframe.style.height = SNOOZED_HEIGHT;
        chatIframe.style.bottom = '20px';
        chatIframe.style.right = '20px';
      } else if (event.data.isOpen) {
        // Open - full dialog, positioned from bottom-right corner
        if (event.data.isWide) {
          chatIframe.style.width = WIDE_WIDTH;
        chatIframe.style.height = WIDE_HEIGHT;
        } else {
          chatIframe.style.width = NORMAL_WIDTH;
          chatIframe.style.height = NORMAL_HEIGHT;
        }
        chatIframe.style.bottom = '20px';
        chatIframe.style.right = '20px';
      } else {
        // Closed - just the button
        chatIframe.style.width = BUTTON_WIDTH;
        chatIframe.style.height = BUTTON_HEIGHT;
        chatIframe.style.bottom = '20px';
        chatIframe.style.right = '20px';
      }
    });
    
  } catch(error) {
    console.log('AIAB Chat Injector: Error', error);
  }
}]]></script>
        <sys_class_name>sys_script_client</sys_class_name>
        <sys_created_by>opencode</sys_created_by>
        <sys_created_on>2026-01-22 23:27:51</sys_created_on>
        <sys_domain>global</sys_domain>
        <sys_domain_path>/</sys_domain_path>
        <sys_id>775a45e283aeb2104d4fccb6feaad3cb</sys_id>
        <sys_mod_count>13</sys_mod_count>
        <sys_name>AIAB Chat Injector</sys_name>
        <sys_overrides/>
        <sys_package display_value="AI in a Box" source="0439d1f593948210071230a97bba1016">0439d1f593948210071230a97bba1016</sys_package>
        <sys_policy/>
        <sys_scope display_value="AI in a Box">0439d1f593948210071230a97bba1016</sys_scope>
        <sys_update_name>sys_script_client_775a45e283aeb2104d4fccb6feaad3cb</sys_update_name>
        <sys_updated_by>opencode</sys_updated_by>
        <sys_updated_on>2026-02-20 07:37:18</sys_updated_on>
        <table>task</table>
        <type>onLoad</type>
        <ui_type>0</ui_type>
        <view/>
    </sys_script_client>
</record_update>
