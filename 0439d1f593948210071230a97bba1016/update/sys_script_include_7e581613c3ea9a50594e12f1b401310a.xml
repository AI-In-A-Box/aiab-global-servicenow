<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>public</access>
        <active>true</active>
        <api_name>global.aiabStatus</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description/>
        <mobile_callable>false</mobile_callable>
        <name>aiabStatus</name>
        <sandbox_callable>false</sandbox_callable>
        <script><![CDATA[//current aiiab
/* global Class,gs,GlideRecord, sn_ws */
/*eslint semi: "error"*/
var aiabStatus = Class.create();
aiabStatus.prototype = {
  initialize: function () { },
  canSummarize: function (table) {
    var enabled = gs.getProperty('ai_in_a_box.feature.summarize.enabled') == "true";
    if (enabled === false) return false;
    var userHasRole = gs.hasRole(gs.getProperty('ai_in_a_box.feature.summarize.roles'.split(',')));
    if (userHasRole === false) return false;
    var summarizer = new GlideRecord('u_ai_summarizer');
    summarizer.addQuery('u_active', 'true');
    summarizer.addQuery('u_table', table);
    summarizer.setLimit(1);
    summarizer.query();
    if (summarizer.next()) {
      return true;
    }
    return false;
  },
  featuresAndProperties: [
    {
      enabled: gs.getProperty('ai_in_a_box.config.midserver.enabled') == "true",
      properties: [
        'ai_in_a_box.config.midserver.enabled',
        'ai_in_a_box.config.midserver'
      ],
      label: "Midserver"
    },
    {
      enabled: gs.getProperty('ai_in_a_box.feature.summarize.enabled') == "true",
      roles: gs.getProperty('ai_in_a_box.feature.summarize.roles').split(','),
      properties: [
        'ai_in_a_box.feature.summarize.enabled',
        'ai_in_a_box.feature.summarize.roles',
      ],
      label: "Summarize"
    },
  {
    enabled: gs.getProperty('ai_in_a_box.feature.chat.enabled') == "true",
    roles: gs.getProperty('ai_in_a_box.feature.chat.roles').split(','),
    properties: [
      'ai_in_a_box.feature.chat.enabled',
      'ai_in_a_box.feature.chat.roles',
    ],
    label: "Chat"
  }
  ],
  status: function () {
    var summarize = (function () {
      var property = 'ai_in_a_box.feature.summarize.enabled';
      var returnObject = {
        "className": "btn btn-danger",
        "label": "Summarize",
        "buttonText": "Disabled",
        "url": "/sys_properties_list.do?sysparm_query=name=" + property
      };
      var value = gs.getProperty(property);
      if (value == null) {
        returnObject.buttonText = "Not Set";
        return returnObject;
      }
      if (value == "false") {
        returnObject.buttonText = "Disabled";
        returnObject.className = "btn btn-warning";
        return returnObject;
      }
      returnObject.className = "btn btn-success";
      returnObject.buttonText = '✅Done';
      return returnObject;
    })();
    var chat = (function () {
      var property = 'ai_in_a_box.feature.chat.enabled';
      var returnObject = {
        "className": "btn btn-danger",
        "label": "Chat",
        "buttonText": "Disabled",
        "url": "/sys_properties_list.do?sysparm_query=name=" + property
      };
      var value = gs.getProperty(property);
      if (value == null) {
        returnObject.buttonText = "Not Set";
        return returnObject;
      }
      if (value == "false") {
        returnObject.buttonText = "Disabled";
        returnObject.className = "btn btn-warning";
        return returnObject;
      }
      returnObject.className = "btn btn-success";
      returnObject.buttonText = '✅Done';
      return returnObject;
    })();
    // Tools ACL - checks if impersonation is configured for ACL-aware tool execution
    var toolsAcl = (function () {
      var returnObject = {
        "className": "btn btn-warning",
        "label": "Tools ACL",
        "buttonText": "Not Configured",
        "url": "https://getaiinabox.com/docs/tools-acl",
        "description": "ACL-aware tool execution requires manual setup"
      };
      var issues = [];
      // Check 1: callback auth property is set
      var callbackAuth = gs.getProperty('ai_in_a_box.config.server.callback.auth');
      if (!callbackAuth || callbackAuth == '') {
        issues.push('Callback auth not set');
      }
      // Check 2: AIABGlobalHelper script include exists in global scope
      var scriptInclude = new GlideRecord('sys_script_include');
      scriptInclude.addQuery('name', 'AIABGlobalHelper');
      scriptInclude.addQuery('sys_scope', 'global');
      scriptInclude.addQuery('active', true);
      scriptInclude.setLimit(1);
      scriptInclude.query();
      if (!scriptInclude.hasNext()) {
        issues.push('Global helper missing');
      }
      // Check 3: Service user exists with impersonator role
      if (callbackAuth && callbackAuth != '') {
        var parts = callbackAuth.split(':');
        if (parts.length >= 1) {
          var username = parts[0];
          var serviceUser = new GlideRecord('sys_user');
          serviceUser.addQuery('user_name', username);
          serviceUser.addQuery('active', true);
          serviceUser.setLimit(1);
          serviceUser.query();
          if (!serviceUser.next()) {
            issues.push('Service user not found');
          } else {
            // Check if user has impersonator role
            var hasRole = new GlideRecord('sys_user_has_role');
            hasRole.addQuery('user', serviceUser.sys_id);
            hasRole.addQuery('role.name', 'impersonator');
            hasRole.setLimit(1);
            hasRole.query();
            if (!hasRole.hasNext()) {
              issues.push('Missing impersonator role');
            }
          }
        }
      }
      if (issues.length == 0) {
        returnObject.className = 'btn btn-success';
        returnObject.buttonText = '✅Ready';
        returnObject.description = 'Tools will respect user ACLs';
      } else if (issues.length == 3) {
        returnObject.className = 'btn btn-secondary';
        returnObject.buttonText = 'Optional';
        returnObject.description = 'Setup for ACL-aware tools (optional)';
      } else {
        returnObject.buttonText = issues[0];
      }
      return returnObject;
    })();
    // mid server [ai_in_a_box.config.midserver]
    var midserver = (function () {
	  var enabled = gs.getProperty('ai_in_a_box.config.midserver.enabled', 'true');
	  var returnObject = {
        "className": "btn btn-danger",
        "label": "Mid Server",
        "buttonText": "Down",
        "url": "/sys_properties_list.do?sysparm_query=name=ai_in_a_box.config.midserver"
      };
	  if(enabled == 'false') {
		returnObject.buttonText = "Not Used";
		returnObject.className = "btn btn-secondary";
		return returnObject;
	  }
      var property = 'ai_in_a_box.config.midserver';
      var value = gs.getProperty(property);
      if (value == null) {
        returnObject.buttonText = "Not Set";
        return returnObject;
      }
      var eccAgent = new GlideRecord('ecc_agent');
      eccAgent.setLimit(1);
      eccAgent.addQuery('name', value);
      eccAgent.query();
      if (eccAgent.hasNext() == false) {
        returnObject.buttonText = "Missing";
        return returnObject;
      }
      if (eccAgent.next()) {
        if (eccAgent.status != 'Up') {
          returnObject.buttonText = "Down";
          return returnObject;
        }
        if (eccAgent.validated != 'true') {
          returnObject.buttonText = "Not Validated";
          returnObject.className = "btn btn-warning";
          returnObject.url = "/ecc_agent_list.do?sysparm_query=" + eccAgent.getEncodedQuery();
          return returnObject;
        }
        // if... issues
        var eccAgentIssues = new GlideRecord('ecc_agent_issue');
        eccAgentIssues.addQuery('mid_server.name', value);
        eccAgentIssues.addQuery('state', '=', 'new');
        eccAgentIssues.query();
        if (eccAgentIssues.next()) {
          returnObject.className = "btn btn-warning";
          returnObject.buttonText = 'Address Issues';
          returnObject.url = "/ecc_agent_list.do?sysparm_query=" + eccAgent.getEncodedQuery();
          return returnObject;
        }
        returnObject.className = "btn btn-success";
        returnObject.buttonText = '✅Up';
        return returnObject;
      }
    })();
    // aiiab url / auth [ai_in_a_box.config.server.aiiab.url / ai_in_a_box.config.server.aiiab.auth]
    var aiiabServer = (function () {
      var property = 'ai_in_a_box.config.server.aiab.url';
      var returnObject = {
        "className": "btn btn-danger",
        "label": "AI In A Box",
        "buttonText": "Down",
        "url": "/sys_properties_list.do?sysparm_query=name=" + property
      };
      var value = gs.getProperty(property);
      if (value == null || value == "") {
        returnObject.buttonText = "URL Not Set";
        return returnObject;
      }
      var authProperty = 'ai_in_a_box.config.server.aiiab.auth';
      var authValue = gs.getProperty(authProperty);
      var url = value + "/meta/status";
      // we need to ensure the mid is up to do this
      var midEnabled = gs.getProperty('ai_in_a_box.config.midserver.enabled', 'true');
      if (midEnabled == 'true') {
        var eccAgent = new GlideRecord('ecc_agent');
        eccAgent.setLimit(1);
        eccAgent.addQuery('name', gs.getProperty('ai_in_a_box.config.midserver'));
        eccAgent.addQuery('status', 'Up');
        eccAgent.addQuery('validated', 'true');
        eccAgent.query();
        if (eccAgent.hasNext() == false) {
          returnObject.buttonText = "Mid Server Down";
          returnObject.url = "/ecc_agent_list.do?sysparm_query=name=" + gs.getProperty('ai_in_a_box.config.midserver');
          return returnObject;
        }
      }
      var restMessage = new sn_ws.RESTMessageV2();
      restMessage.setHttpMethod('get');
      restMessage.setEndpoint(url);
      if (midEnabled == 'true') {
        restMessage.setMIDServer(gs.getProperty('ai_in_a_box.config.midserver'));
      }
      restMessage.setRequestHeader('Content-Type', 'application/json');
      restMessage.setRequestHeader('Authorization', 'Basic ' + GlideStringUtil.base64Encode(authValue));
      var response = restMessage.execute();
      if (response.getStatusCode() == 401) {
        returnObject.buttonText = 'Invalid Auth';
        return returnObject;
      }
      if (response.getStatusCode() != 200) {
        returnObject.buttonText = 'Down';
        return returnObject;
      }
      returnObject.buttonText = '✅Up';
      returnObject.className = 'btn btn-success';
      return returnObject;
    })();
    var llmServer = (function () {
      var property = 'ai_in_a_box.config.server.llm.url';
      var returnObject = {
        "className": "btn btn-danger",
        "label": "LLM Server",
        "buttonText": "Down",
        "url": "/sys_properties_list.do?sysparm_query=name=" + property
      };
      var value = gs.getProperty(property);
      var urlRegex = new RegExp('^(http|https)://.*$');
      if (!urlRegex.test(value) || value == null) {
        returnObject.buttonText = 'Invalid URL';
        return returnObject;
      }
      var authProperty = 'ai_in_a_box.config.server.llm.auth';
      var authValue = gs.getProperty(authProperty);
      if (authValue == null || authValue == "") {
        returnObject.buttonText = 'Auth not set';
        returnObject.url = "/sys_properties_list.do?sysparm_query=name=" + authProperty;
        return returnObject;
      }
      var midEnabled = gs.getProperty('ai_in_a_box.config.midserver.enabled', 'true');
      if (midEnabled == 'true') {
        var eccAgent = new GlideRecord('ecc_agent');
        eccAgent.setLimit(1);
        eccAgent.addQuery('name', gs.getProperty('ai_in_a_box.config.midserver'));
        eccAgent.addQuery('status', 'Up');
        eccAgent.addQuery('validated', 'true');
        eccAgent.query();
        if (eccAgent.hasNext() == false) {
          returnObject.buttonText = "Mid Server Down";
          returnObject.url = "/ecc_agent_list.do?sysparm_query=name=" + gs.getProperty('ai_in_a_box.config.midserver');
          return returnObject;
        }
      }
      var restMessage = new sn_ws.RESTMessageV2();
      returnObject.gottorest = true;
      restMessage.setHttpMethod('get');
      restMessage.setEndpoint(value + '/models');
      if (midEnabled == 'true') {
        restMessage.setMIDServer(gs.getProperty('ai_in_a_box.config.midserver'));
      }
      restMessage.setRequestHeader('Content-Type', 'application/json');
      restMessage.setRequestHeader('Authorization', 'Bearer ' + authValue);
      var response = restMessage.execute();
      var responseBody = response.getBody();
      if (response.getStatusCode() == 401) {
        returnObject.buttonText = 'Invalid Auth';
        return returnObject;
      }
      if (response.getStatusCode() != 200) {
        returnObject.buttonText = 'Down';
        return returnObject;
      }

      var responseJSON = JSON.parse(responseBody);
      var isLlamaCpp = false;
      var models = [];
      if (responseJSON.data) {
        for (var i = 0; i < responseJSON.data.length; i++) {
          models.push(responseJSON.data[i].id);
          if (responseJSON.data[i].owned_by == 'llamacpp') {
            isLlamaCpp = true;
          }
        }
      }
      if (isLlamaCpp == false) {
        var modelProperty = 'ai_in_a_box.config.server.llm.model';
        var modelValue = gs.getProperty(modelProperty);
        if (models.indexOf(modelValue) == -1) {
          returnObject.className = 'btn btn-warning';
          returnObject.buttonText = 'Model(' + modelValue + ') not found.  Models: ' + models.join(', ');
          returnObject.url = "/sys_properties_list.do?sysparm_query=name=" + modelProperty;
          return returnObject;
        }
      }

      returnObject.buttonText = '✅Up';
      returnObject.className = 'btn btn-success';
      return returnObject;
    })();
    var meet = {
      "label": "Let's Meet",
      "buttonText": "Schedule it",
      "url": "https://meetings.hubspot.com/jace-benson",
      "className": "btn btn-primary"
    };
    var docs = {
      "label": "Docs",
      "buttonText": "Help yourself",
      "url": "https://getaiinabox.com/docs",
      "className": "btn btn-success"
    };
    var email = {
      "label": "Email",
      "buttonText": "Email Us",
      "url": "mailto:team@getaiinabox.com",
      "className": "btn btn-outline-primary"
    };
    return {
      summarize: summarize,
      chat: chat,
      toolsAcl: toolsAcl,
      midserver: midserver,
      aiiabServer: aiiabServer,
      llmServer: llmServer,
      meet: meet,
      docs: docs,
      email: email,
      up: midserver.buttonText == '✅Up' && aiiabServer.buttonText == '✅Up' && llmServer.buttonText == '✅Up'
    };

  },
  statusMidServer: function () {

    var midservername = gs.getProperty('ai_in_a_box.config.midserver', 'aiinabox-mid');
    var enabled = gs.getProperty('ai_in_a_box.config.midserver.enabled', 'true');
    if(enabled != 'true'){
      return {
        status: "disabled",
        message: "Mid Server is disabled"
      };
    }
    var eccAgent = new GlideRecord('ecc_agent');
    eccAgent.addQuery('name', midservername);
    eccAgent.query();
    if (eccAgent.next()) {
      if (eccAgent.status != 'Up') {
        return {
          status: "down",
          message: "Mid Server is down"
        };
      }
      if (eccAgent.validated != 'true') {
        return {
          status: "not_validated",
          message: "Mid Server is not validated"
        };
      }
      var eccAgentIssues = new GlideRecord('ecc_agent_issue');
      eccAgentIssues.addQuery('mid_server.name', 'aiinabox-mid');
      eccAgentIssues.addQuery('state', '=', 'new');
      eccAgentIssues.query();
      if (eccAgentIssues.next()) {
        return {
          status: "issues",
          message: "Mid Server has issues"
        };
      }
      return {
        status: "up",
        message: "Mid Server is up"
      };
    } else {
      return {
        status: "down",
        message: "Mid Server is down"
      };
    }
  },
  statusAIABServer: function () {
    var aiabStatusServer = gs.getProperty('ai_in_a_box.config.server.aiab.url', 'http://localhost:5000');
    var response = new global.aiabRest().send({
      host: aiabStatusServer,
      path: '/meta/status',
    });
    var statusCode = JSON.parse(response.body).status;

    if (statusCode === "ok") {
      return {
        status: "up",
        message: "AIAB Server is up"
      };
    } else {
      return {
        status: "down",
        message: "AIAB Server is down"
      };
    }
  },
  type: 'aiabStatus'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>aiinaboxadmin</sys_created_by>
        <sys_created_on>2024-12-23 20:42:04</sys_created_on>
        <sys_id>7e581613c3ea9a50594e12f1b401310a</sys_id>
        <sys_mod_count>136</sys_mod_count>
        <sys_name>aiabStatus</sys_name>
        <sys_package display_value="AI in a Box" source="0439d1f593948210071230a97bba1016">0439d1f593948210071230a97bba1016</sys_package>
        <sys_policy/>
        <sys_scope display_value="AI in a Box">0439d1f593948210071230a97bba1016</sys_scope>
        <sys_update_name>sys_script_include_7e581613c3ea9a50594e12f1b401310a</sys_update_name>
        <sys_updated_by>opencode</sys_updated_by>
        <sys_updated_on>2026-01-15 07:16:20</sys_updated_on>
    </sys_script_include>
    <sys_es_latest_script action="INSERT_OR_UPDATE">
        <id>7e581613c3ea9a50594e12f1b401310a</id>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-01-23 00:56:51</sys_created_on>
        <sys_id>2472394d83d792107f36c5b5eeaad3b1</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-01-23 00:56:51</sys_updated_on>
        <table>sys_script_include</table>
        <use_es_latest>false</use_es_latest>
    </sys_es_latest_script>
</record_update>
