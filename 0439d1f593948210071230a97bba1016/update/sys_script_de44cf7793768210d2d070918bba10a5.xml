<?xml version="1.0" encoding="UTF-8"?><record_update sys_domain="global" table="sys_script">
    <sys_script action="INSERT_OR_UPDATE">
        <abort_action>false</abort_action>
        <access>package_private</access>
        <action_delete>false</action_delete>
        <action_insert>true</action_insert>
        <action_query>false</action_query>
        <action_update>false</action_update>
        <active>true</active>
        <add_message>false</add_message>
        <advanced>true</advanced>
        <change_fields>false</change_fields>
        <client_callable>false</client_callable>
        <collection>u_ai_inference</collection>
        <condition/>
        <description/>
        <execute_function>false</execute_function>
        <filter_condition table="u_ai_inference">u_state=new^EQ<item display_value="New" endquery="false" field="u_state" goto="false" newquery="false" operator="=" or="false" value="new"/>
            <item endquery="true" field="" goto="false" newquery="false" operator="=" or="false" value=""/>
        </filter_condition>
        <is_rest>false</is_rest>
        <message><![CDATA[<p>Queueing Fetch</p>]]></message>
        <name>Fetch Inference</name>
        <order>100</order>
        <priority>100</priority>
        <rest_method/>
        <rest_method_text/>
        <rest_service/>
        <rest_service_text/>
        <rest_variables/>
        <role_conditions/>
        <script><![CDATA[(function executeRule(current, previous /*null when async*/ ) {
    var buildTableMessages = function() {

        var task = new GlideRecord(table);
        task.get(current.getValue('u_target'));
        var aiSummarierGR = new GlideRecord('u_ai_summarizer');
        aiSummarierGR.addQuery('u_active', 'true');
        aiSummarierGR.addQuery('u_table', table);
        aiSummarierGR.setLimit(1);
        aiSummarierGR.query();
        if (aiSummarierGR.next()) {
            messages = [];
            messages.push({
                role: 'system',
                content: aiSummarierGR.getValue('u_prompt')
            });
            var recordTemplate = aiSummarierGR.getValue('u_record_template');
            var recordFieldsFromTemplate = recordTemplate.match(/{{(.*?)}}/g);
            var fields = recordFieldsFromTemplate.map(function(field) {
                field = field.replace('{{', '').replace('}}', '');
                return field;
            });

            var recordA = new GlideRecord(table);
            recordA.setLimit(1);
            if (aiSummarierGR.getValue('u_record_a_data')) {
                messages.push({
                    role: 'user',
                    content: aiSummarierGR.getValue('u_record_a_data')
                });
                messages.push({
                    role: 'assistant',
                    content: aiSummarierGR.getValue('u_record_a_summary')
                });
            }

            var recordB = new GlideRecord(table);
            recordB.setLimit(1);
            if (aiSummarierGR.getValue('u_record_b_data')) {
                messages.push({
                    role: 'user',
                    content: aiSummarierGR.getValue('u_record_b_data')
                });
                messages.push({
                    role: 'assistant',
                    content: aiSummarierGR.getValue('u_record_b_summary')
                });
            }

            var taskText = recordTemplate + '';
            fields.forEach(function(field) {
                var value = task.getDisplayValue(field) || '';
                if (field == "__all_variables__") {
                    value += "Variables:\n";
                    for (var prop in task.variables) {
                        value += prop + ': ' + task.variables[prop] + '\n';
                    }
                }
                if (field.indexOf('__related__') > -1) {
                    try {
                        var clearField = field.replace('__related__', '');
                        var parts = clearField.split('__');
                        var rTable = parts[0];
                        var rQuery = parts[1];
                        var rField = parts[2].split(',');
                        (function() {
                            var re = /\[\[(.*?)\]\]/g;
                            var match;
                            var result = [];
                            while (match = re.exec(rQuery)) {
                                result.push(match[1]);
                            }
                            result.forEach(function(r) {
                                rQuery = rQuery.replace('[[' + r + ']]', task.getValue(r));
                            });
                        })();
                        var rGR = new GlideRecord(rTable);
                        rGR.addQuery(rQuery);
                        rGR.setLimit(10);
                        rGR.query();
                        var rValues = [];
                        while (rGR.next()) {
                            var rFields = [];
                            rField.forEach(function(dField) {
                                rFields.push(rGR.getElement(dField).getLabel() + ': ' + rGR.getDisplayValue(dField));
                            });
                            rValues.push(rFields.join('\n>'));
                        }
                        value = rValues.join('\n\n');
                    } catch (e) {
                        value = "ERROR: " + e;
                        current.u_state = 'finished';
                        current.u_response = e;
                        current.update();
                    }
                }
                taskText = taskText.replace('{{' + field + '}}', value);
            });
            messages.push({
                role: 'user',
                content: taskText
            });
        }
        return messages;
    };
    var setPromptToJSON = function(prompt) {
        var messages = [{
            role: "system",
            content: "You are a helpful assistant."
        }, {
            role: "user",
            content: prompt
        }];
        try {
            var parsedPrompt = JSON.parse(prompt);
            if (Array.isArray(parsedPrompt)) {
                messages = parsedPrompt;
            }
            return messages;
        } catch (e) {
            return messages;
        }
    };
    var getActiveTools = function() {
        var tools = [];
        var toolGR = new GlideRecord('u_ai_tool');
        toolGR.addQuery('u_active', true);
        toolGR.query();
        while (toolGR.next()) {
            try {
                tools.push({
                    type: "function",
                    "function": {
                        name: toolGR.getValue('u_name'),
                        description: toolGR.getValue('u_description'),
                        parameters: JSON.parse(toolGR.getValue('u_parameters'))
                    }
                });
            } catch (e) {
                gs.warn('AIAB: Failed to parse tool parameters for ' + toolGR.getValue('u_name') + ': ' + e);
            }
        }
        return tools;
    };
    var buildAskRecordMessages = function(sysid, table, prompt) {
        var messages = [{
                role: "system",
                content: "You are a helpful chatbot who will answer to the best of your ability the request asked.  Do not expand more than necessary."
            },
            {
                role: "user",
                content: "I need assistance, given the following record, I will ask a few questions about it.  Do you're best to answer the question or request.  Ready?"
            },
            {
                role: "assistant",
                content: "I'm ready."
            }
        ];
        var questionMessage = {
            role: "user",
            content: ""
        }
        var record = new GlideRecord(table);
        record.addQuery('sys_id', sysid);
        record.setLimit(1);
        record.query();
        if (record.next()) {
            for (var field in record) {
                var validField = record.isValidField(field);
                if (validField) {
                    var label = record[field].getLabel(field);
                    var value = record.getDisplayValue(field) || "Not set";
                    questionMessage.content += label + ': ' + value + '\n';
                }
            }
        }
        messages.push(questionMessage);
        messages.push({
            role: "assistant",
            content: "Ask your question."
        });
        messages.push({
            role: "user",
            content: "What is the records unique id, the sys_id?"
        });
        messages.push({
            role: "assistant",
            content: "The record's sys_id is " + sysid
        })
        messages.push({
            role: "user",
            content: prompt
        });
        return messages;
    };
    try {
        var prompt = current.getValue('u_prompt');
        var table = current.getValue('u_table');
        var target = current.getValue('u_target');
        var type = current.getValue('u_type');
        var model = current.getValue('u_model') || gs.getProperty('ai_in_a_box.config.server.llm.model');
        // Get the requesting user - use u_requested_by if set, otherwise fall back to sys_created_by
        var requestingUserId = current.getValue('u_requested_by') || current.getValue('sys_created_by');
        if (!requestingUserId) {
            // Last resort - look up by sys_created_by username
            var userGR = new GlideRecord('sys_user');
            userGR.addQuery('user_name', current.getValue('sys_created_by'));
            userGR.setLimit(1);
            userGR.query();
            if (userGR.next()) {
                requestingUserId = userGR.getUniqueValue();
            }
        }
        if (type == 'summarize-simple') {
            messages = buildTableMessages();
        }
        if (type == 'chat') {
            messages = setPromptToJSON(prompt);
        }
        if (type == 'generic') {
            messages = setPromptToJSON(prompt);
        }
        if (type == 'ask-record') {
            messages = buildAskRecordMessages(target, table, prompt);
        }
        current.u_prompt = JSON.stringify(messages, null, ' ');
        current.u_state = 'requested';
        var tools = getActiveTools();
        var aiabRest = new global.aiabRest();
        var body = {
            messages: messages,
            model: model,
            tools: tools.length > 0 ? tools : undefined
        };
        var path = "/openai/v1/chat/completions";
        var method = "post";
        var headers = {
            "ai_in_a_box.inference.id": current.getValue('sys_id'),
            "ai_in_a_box.user.id": requestingUserId
        };
        gs.info('AIAB: Sending inference ' + current.getValue('sys_id') + ' for user ' + requestingUserId);
        var restMessageNoTable = aiabRest.send({
            body: body,
            path: path,
            method: method,
            headers: headers
        });
        if (restMessageNoTable) {
            var parsed = JSON.parse(restMessageNoTable.body);
            if (parsed.error) {
                current.u_response = parsed.contents;
                current.u_state = 'finished';
            }
        }
        current.update();
    } catch (error) {
        gs.addErrorMessage(error);
    }
})(current, previous);]]></script>
        <sys_class_name>sys_script</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-06-22 03:15:37</sys_created_on>
        <sys_domain>global</sys_domain>
        <sys_domain_path>/</sys_domain_path>
        <sys_id>de44cf7793768210d2d070918bba10a5</sys_id>
        <sys_mod_count>77</sys_mod_count>
        <sys_name>Fetch Inference</sys_name>
        <sys_overrides/>
        <sys_package display_value="AI in a Box" source="0439d1f593948210071230a97bba1016">0439d1f593948210071230a97bba1016</sys_package>
        <sys_policy/>
        <sys_scope display_value="AI in a Box">0439d1f593948210071230a97bba1016</sys_scope>
        <sys_update_name>sys_script_de44cf7793768210d2d070918bba10a5</sys_update_name>
        <sys_updated_by>opencode</sys_updated_by>
        <sys_updated_on>2026-01-15 06:28:34</sys_updated_on>
        <template/>
        <when>after</when>
    </sys_script>
    <sys_translated_text action="delete_multiple" query="documentkey=de44cf7793768210d2d070918bba10a5"/>
</record_update>
