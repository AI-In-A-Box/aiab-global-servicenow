<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller = function (spUtil, $scope, $interval) {
  /*global api, setInterval, document, console, spUtil*/
  try {
    var c = this;
    c.data.tryitlabel = "";
		c.data.timePercent = 0;
    c.requestServer = function () {
      c.data.midserverUser = document.querySelector('#midserver-username').value;
      c.data.requestServer = true;
			c.data.timerStarted = true;
			c.startTimer()
      c.server.update();
      //console.log(c.data);
    };
    c.startTimer = function () {
      c.data.estimatedTimeToComplete = 60 * 5//5 minutes
      c.data.timePassed = 0//0 seconds
      c.data.timePercent = 0;
			c.data.timerStarted = true;
      //var timer = setInterval(function () {
      var timer = $interval(function () {
        c.data.timePassed++;
        //if (c.data.startTimer === 0) {
        // if timepassed is greater than estimated time to complete
        c.data.timePercent = parseFloat((c.data.timePassed / c.data.estimatedTimeToComplete) * 100).toFixed(2);
        if (c.data.timePassed >= c.data.estimatedTimeToComplete) {
          //clearInterval(timer);
          // calculate the percentage
          c.data.timePercent = 100;
          $interval.cancel(timer);
					c.data.timerStarted = false;
					c.data.requestServer = false;
					c.server.update()
        }
      }, 1000);
    }
    var midQuery = 'name=' + c.data.midserverName;
    spUtil.recordWatch($scope, 'ecc_agent', midQuery, function (response) {
      // lets reload the page
      c.data.requestServer = false;// stop it from re-requesting
      c.server.update();
      //console.log('midquery', response.data.record);
      if (response.data.record && response.data.record.status) {
        c.data.midserverRequested = response.data.record.status.value;
      }
      if (response.data.record && response.data.record.validated) {
        if (response.data.record.validated.value != 'true') {
          c.data.midserverRequested = 'Address Midserver issues';
        }
      }
    });
    var issueQuery = 'mid_server.name=' + c.data.midserverName;
    issueQuery += '^state!=resolved';
    spUtil.recordWatch(
      $scope,
      'ecc_agent_issue',
      issueQuery,
      function (response) {
        //console.log('issuequery', response.data.record);
        c.data.requestServer = false;// stop it from re-requesting
        c.server.update();
      }
    );
  } catch (error) {
    console.log(error);
  }
}
]]></client_script>
        <controller_as>c</controller_as>
        <css/>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>aiiab_welcome_widget</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {

}]]></link>
        <name>AIIAB Welcome Widget</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function () {
  /*global gs, global, data, sn_ws, console*/
  try {
	    data.midserverNeeded = gs.getProperty('ai_in_a_box.config.midserver.enabled') == 'true';
		data.midserverName = gs.getProperty('ai_in_a_box.config.midserver');
		data.midserverRequested = false;
		var aiiab = new Aiiab();
		var status = aiiab.Status();
		data.instanceUrl = "https://" + gs.getProperty('instance_name') + '.service-now.com';
		data.models = aiiab.HFModels()
		data.midserverUserName = input.midserverUser || "tryaiinabox-mid-user";
		if(input && input.timerStarted == true){
			data.startTimerServer = true;
		} else {
			data.startTimerServer = false;
		}

		if(input && input.requestServer && input.midserverUser){
			var password = aiiab.GeneratePassword();
			var miduser = aiiab.CreateMidUser(password);
			var hfRepo = input.hfRepo;
			var hfFile = input.hfFile;
			if(miduser.status == "success"){
				var infra = aiiab.RequestDemoInfra(input.midserverUser, password, hfRepo, hfFile);
				data.midserverRequested = "Server Requested...";
				data.requestServer = false;
			}
		}
		var sys_user = new GlideRecord('sys_user');
		if(sys_user.get('user_name', data.midserverUserName)){
			data.checkUserResponse = {
				exists: true,
				message: "User already Exists"
			};
		} else {
			data.checkUserResponse = {
				exists: false,
				message: null
			};
		}

		data.features = [
			status.streaming,
			status.summarize,
		];
		data.servers = [];
		if(data.midserverNeeded){ data.servers.push(status.midserver) }
		data.servers = [
			status.aiiabServer,
			status.llmServer
		];
		data.reachOut = [
			status.meet,
			status.docs,
			status.email
		];
    var requestBody = {
      instance: gs.getProperty('instance_name') || 'instance_name not set',
      aiiab_version: gs.getProperty('ai_in_a_box.version') || 'version not set',
      instance_version:
        gs.getProperty('glide.product.version') || 'version not set',
    };
    var url = 'https://tryaiinabox.com/.redwood/functions/status/';
    var restMessage = new sn_ws.RESTMessageV2();
    restMessage.setHttpMethod('post');
    restMessage.setEndpoint(url);
    restMessage.setRequestHeader('Content-Type', 'application/json');
    restMessage.setRequestBody(JSON.stringify(requestBody));
    var response = restMessage.execute();
    var responseBody = response.getBody();
    var responseStatus = response.getStatusCode();
    var message = null;
    if (responseStatus != 200) {
      message = 'An error occurred';
      messageType = 'danger';
    }
    if (responseStatus == 200) {
      var parsedResponse = JSON.parse(responseBody);
      customerType = parsedResponse.customerType;
      message = parsedResponse.message;
    }
    data.message = message;
  } catch (error) {
    console.log(error);
  }
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>aiinaboxadmin</sys_created_by>
        <sys_created_on>2024-12-06 00:11:44</sys_created_on>
        <sys_id>99bb9aedc3deda10594e12f1b401313b</sys_id>
        <sys_mod_count>445</sys_mod_count>
        <sys_name>AIIAB Welcome Widget</sys_name>
        <sys_package display_value="AI in a Box" source="0439d1f593948210071230a97bba1016">0439d1f593948210071230a97bba1016</sys_package>
        <sys_policy/>
        <sys_scope display_value="AI in a Box">0439d1f593948210071230a97bba1016</sys_scope>
        <sys_update_name>sp_widget_99bb9aedc3deda10594e12f1b401313b</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-14 01:04:54</sys_updated_on>
        <template><![CDATA[<div class="container-fluid"
     style="background-color: #f8f8f8; padding: 20px; border-radius: 5px; margin-top: 20px; margin-bottom: 20px;">
  <div class="row">
    <div class="col-md-12">
      <h1>Welcome to AI In A Box</h1>
      <p>
        AI In A Box is a powerful tool that adds Gen AI to ServiceNow.
      </p>
      <div class="alert alert-{{data.messageType}}">
        <strong>{{data.message}}</strong>
      </div>
      <div ng-if="data.error" class="alert alert-danger">

        {{data.error}}
      </div>
    </div>
  </div>
  <div class="row">
    <!--Settings-->
    <div class="col-md-4">
      <div class="panel panel-default">
        <div class="panel-heading">
          <!--using emoijis, lets show there's error here-->
          <h3 class="panel-title">
            Settings
          </h3>
        </div>
        <div class="panel-body">
          <p>
            Configure the settings for AI In A Box
          </p>
          <div class="flex-row" style="padding: 2px;">
            <div>
              All Settings
            </div>
            <div style="flex-grow: 1"></div>
            <a
               href="/system_properties_ui.do?sysparm_title=Properties&sysparm_category=AI%20In%20A%20Box&sysparm_domain_restore=false&sysparm_stack=no"
               class="btn btn-primary"
               >
              Property Page
            </a>
          </div>
          <div ng-repeat="feature in c.data.features" class="flex-row" style="padding: 2px;">
            <div>
              {{feature.label}}
            </div>
            <div style="flex-grow: 1"></div>
            <a ng-href="{{feature.url}}" class="{{feature.className}}">{{feature.buttonText}}</a>
            <!--<details><summary>Debug</summary>{{feature}}</details>-->
          </div>
          <div class="flex-row" style="padding: 2px;">
            <div>
              Summarizers
            </div>
            <div style="flex-grow: 1"></div>
            <a
               href="/u_ai_summarizer_list.do"
               class="btn btn-primary"
               >
              View Summarizers
            </a>
          </div>
          <div class="flex-row" style="padding: 2px;">
            <div>
              Inferences
            </div>
            <div style="flex-grow: 1"></div>
            <a
               href="/u_ai_inference_list.do"
               class="btn btn-primary"
               >
              View Inferences
            </a>
          </div>
        </div>
      </div>
    </div>
    <!--Demo Box-->
    <div class="col-md-4" ng-if="data.customerType != 'customer'">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Servers</h3>
        </div>
        <div class="panel-body">
          <div ng-if="data.midserverNeeded == true">
          <p>
            Let's get you a temporary server
          </p>
          <div class="flex-row" style="padding: 2px;">
            <div style="flex-grow: 1"></div>
            <div
                 ng-if="data.startTimerServer == true"
                 >

            <progress
                      ng-if="data.startTimerServer == true"
                      id="provisionServer"
                      value={{c.data.timePassed}}
                      max={{c.data.estimatedTimeToComplete}}>
              {{c.data.timePercent}}%
            </progress><br/>
            {{c.data.timePercent}}% {{c.data.timePassed}}s/{{c.data.estimatedTimeToComplete}}s<br/>
            </div>

          </div>


          <div class="flex-row" style="padding: 2px;">
            <div>Want to try it?</div>
            <div style="flex-grow: 1"></div>
            <div ng-if="data.midserverRequested != false">
              <button type="button" disabled class="btn btn-secondary">
                {{data.midserverRequested}}
              </button>
            </div>
            <div ng-if="data.midserverRequested == false">
              <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#demoModal">
                Request a Server for 100 minutes
              </button>
            </div>
            <div class="modal fade" id="demoModal" tabindex="-1" role="dialog" aria-labelledby="demoModalLabel"
                 aria-hidden="true">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="demoModalLabel">Request Server</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <form>
                      <div class="form-group">


                        <label for="midserver-username" class="col-form-label">
                          What username can we use for the
                          midserver?
                        </label>
                        <input
                               type="text"
                               class="form-control"
                               id="midserver-username"
                               value="tryaiinabox-mid-user"
                               readonly="true"
                               >
                        <br />
                        <button
                                data-dismiss="modal"
                                type="submit"
                                ng-click="c.requestServer()"
                                class="btn btn-primary"

                                >
                          <div
                               ng-if="c.data.checkUserResponse.exists == true"
                               >
                            Delete + Recreate User + Request Server
                          </div>
                          <div
                               ng-if="c.data.checkUserResponse.exists == false"
                               >
                            Create User + Request Server
                          </div>
                        </button>
                        <div>
                          It takes <span style="font-weight:bold">~2-5 minutes to provision</span> the server.  <br/>
                          You'll still need to validate the server after it connects.<br/>
                          This <span style="font-weight:bold">server will be destroyed in ~100 minutes</span>.  You can re-request one at any time, and it will last for 100 minutes after that.<br/>
                          <details>
                            <summary
                                     class="btn btn-primary"
                                     >Why 100 minutes!?
                            </summary>
                            Let's not break the bank.  It costs me some money to run these.  Albeit not a lot, that amount increases with every team.  If you're building, great, but if you're not, I'd like not keep these things running without a need.
                          </details>
                        </div>

                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
          </div>  
          <div ng-repeat="server in c.data.servers" class="flex-row" style="padding: 2px;">
            <div>
              {{server.label}}
            </div>
            <div style="flex-grow: 1"></div>

            <a
               ng-href="{{server.url}}" class="{{server.className}}">{{server.buttonText}}</a>
            <!--<details><summary>Debug</summary>{{server}}</details>-->

          </div>

        </div>
      </div>

    </div>
    <!--Put in a support request if customer-->
    <div class="col-md-4" ng-if="data.customerType == 'customer'">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Support Request</h3>
        </div>
        <div class="panel-body">
          <p>
            Need help with AI In A Box?
          </p>
          <a href="https://jace.pro/meeting" class="btn btn-primary">Ask for Help</a>
        </div>
      </div>
    </div>
    <!--Get Help-->
    <div class="col-md-4">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Get Help</h3>
        </div>
        <div class="panel-body">
          <p>
            Need help with AI In A Box?
          </p>
          <div ng-repeat="action in c.data.reachOut" class="flex-row" style="padding: 2px;">
            <div>
              {{action.label}}
            </div>
            <div style="flex-grow: 1"></div>
            <a ng-href="{{action.url}}" class="{{action.className}}" target="_blank" >{{action.buttonText}}</a>
            <!--<details><summary>Debug</summary>{{server}}</details>-->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>]]></template>
    </sp_widget>
</record_update>
